<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - Profil Agent</title>

    <script>
        const REQUIRED_LEVEL = 1; 
    </script>
    <script src="../security.js"></script>
    <link rel="stylesheet" href="../style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
</head>
<body>
    <main class="terminal">
        <h1 id="profile-title">PROFIL AGENT<span class="blinker">_</span></h1>
        
        <p class="status">ACCES: <span class="restricted" id="agent-name-display"></span> :: NIVEAU <span id="agent-level-display">?</span></p>

        <div class="report-content" id="profile-container">
            <h2 id="agent-details-header">[COORDONNÉES PERSONNELLES]</h2>
            <div id="details-section">
                <p style="color: #00ff00;">[Chargement des données...]</p>
            </div>
            
            <h2 id="warning-header">[ALERTES ET AVERTISSEMENTS]</h2>
            <div id="warning-section">
                <p style="color: #00ff00;">[Vérification du dossier...]</p>
            </div>
            
            <h2 id="password-header">[MAJ MOT DE PASSE]</h2>
            <form id="update-password-form" class="inventory-form">
                <input type="password" name="current_password" placeholder="Mot de passe actuel" required>
                <input type="password" name="new_password" placeholder="Nouveau mot de passe" required>
                <input type="password" name="confirm_password" placeholder="Confirmer nouveau mot de passe" required>
                <button type="submit">METTRE À JOUR</button>
                <p id="password-message" style="color: #ff4141; margin-top: 10px;"></p>
            </form>
            
        </div>

        <footer class="portal-footer">
            <a href="../index.html" class="back-link">&lt;&lt; RETURN_TO_MAINFRAME</a>
        </footer>
    </main>

    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const user = localStorage.getItem('sas_user');
            const agentId = localStorage.getItem('sas_agent_id');
            const level = localStorage.getItem('sas_level');
            
            document.getElementById('agent-name-display').textContent = user || 'AGENT INCONNU';
            document.getElementById('agent-level-display').textContent = level || '?';
            document.getElementById('profile-title').textContent = `PROFIL AGENT ${user.toUpperCase()}`;

            const detailsSection = document.getElementById('details-section');
            const warningSection = document.getElementById('warning-section');
            const updatePasswordForm = document.getElementById('update-password-form');
            const passwordMessage = document.getElementById('password-message');

 
            if (user) {
                try {
                   
                    const response = await fetch(`../api/read?resource=agent-details&username=${user}`);
                    const data = await response.json();

                    if (data.error) throw new Error(data.error);
                    
                    
                    const warningLevel = data.warningLevel || 0;
                    detailsSection.innerHTML = `
                        <p>Niveau d'Accréditation: <strong>NIVEAU ${level}</strong></p>
                        <p>Niveau d'Alerte Actuel: <strong style="color: ${warningLevel > 0 ? '#ff6666' : '#00ff00'};">NIVEAU ${warningLevel}</strong></p>
                        <p>Agent ID: <strong>${agentId}</strong></p>
                    `;

                    // Affichage des avertissements
                    if (data.warningNotes && data.warningNotes.length > 0) {
                        let notesHTML = '<ul class="note-list">';
                        data.warningNotes.forEach(note => {
                            const date = new Date(note.created_at).toLocaleDateString();
                            notesHTML += `
                                <li class="note-warning">
                                    <span class="warning-date">[${date}]</span>
                                    <span class="warning-author">Par ${note.author_name}:</span>
                                    <p class="warning-text">${note.note_text}</p>
                                </li>
                            `;
                        });
                        notesHTML += '</ul>';
                        warningSection.innerHTML = notesHTML;
                    } else {
                        warningSection.innerHTML = '<p style="color: #00ff00;">AUCUN AVERTISSEMENT ACTIF DANS LE DOSSIER.</p>';
                    }
                } catch (error) {
                    console.error('Erreur chargement détails:', error);
                    detailsSection.innerHTML = `<p style="color: #ff4141;">[ERREUR: IMPOSSIBLE DE VÉRIFIER LE DOSSIER]</p>`;
                    warningSection.innerHTML = `<p style="color: #ff4141;">[ERREUR: IMPOSSIBLE DE VÉRIFIER LE DOSSIER]</p>`;
                }
            }


            
            updatePasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const currentPassword = updatePasswordForm.current_password.value;
                const newPassword = updatePasswordForm.new_password.value;
                const confirmPassword = updatePasswordForm.confirm_password.value;
                
                passwordMessage.textContent = '';
                
                if (newPassword !== confirmPassword) {
                    passwordMessage.textContent = '//: ERROR :: NOUVEAUX MOTS DE PASSE INÉGAUX';
                    return;
                }
                
                if (newPassword.length < 5) {
                    passwordMessage.textContent = '//: ERROR :: MOT DE PASSE TROP COURT (MIN 5 CAR)';
                    return;
                }
                
                const submitButton = updatePasswordForm.querySelector('button[type="submit"]');
                submitButton.textContent = '... EN COURS ...';

                try {
                    const response = await fetch('../api/update-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            agentId: parseInt(agentId),
                            currentPassword: currentPassword,
                            newPassword: newPassword
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        passwordMessage.textContent = '//: SUCCÈS :: MOT DE PASSE MIS À JOUR';
                        updatePasswordForm.reset();
                        submitButton.textContent = 'MIS À JOUR OK';
                    } else {
                        throw new Error(result.error || 'Erreur inconnue.');
                    }
                } catch (error) {
                    passwordMessage.textContent = `//: ERREUR :: ${error.message.toUpperCase()}`;
                    submitButton.textContent = 'ERREUR';
                } finally {
                    setTimeout(() => { submitButton.textContent = 'METTRE À JOUR'; }, 2000);
                }
            });

        });
    </script>
</body>
</html>