<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - Profil Agent</title>

    <script> const REQUIRED_LEVEL = 1; </script>
    <script src="../security.js"></script>
    <link rel="stylesheet" href="../style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
</head>
<body>
    <main class="terminal">
        <h1>PROFIL AGENT<span class="blinker">_</span></h1>
        
        <p class="status" id="agent-name-status">AGENT: [CHARGEMENT...]</p>

        <div class="report-content">
            <h3 class="category-title">//: DONNÉES D'IDENTIFICATION</h3>
            <ul class="inventory-list">
                <li>
                    <span class="item-name">AGENT ID:</span>
                    <ul class="item-details">
                        <li><span id="profile-name">[INCONNU]</span></li>
                    </ul>
                </li>
                <li>
                    <span class="item-name">ACCRÉDITATION:</span>
                    <ul class="item-details">
                        <li><span id="profile-level">[NIVEAU 0]</span></li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="report-content" style="margin-top: 2rem;">
            <h3 class="category-title">//: GESTION DE LA SÉCURITÉ</h3>
            
            <p class="ada-warning">
                "Attention, mettez un mot de passe différent de vos mots de passe habituels.
                <br>-- Je vois vos mots de passe -- Ada :)"
            </p>

            <form id="change-password-form" class="assignment-form">
                <label for="new-password">//: NOUVEAU MOT DE PASSE:</label>
                <input type="password" id="new-password" class="form-input" required>
                
                <label for="confirm-password">//: CONFIRMER LE MOT DE PASSE:</label>
                <input type="password" id="confirm-password" class="form-input" required>
                
                <button type="submit" class="form-button">&gt;&gt; CHANGER LE MOT DE PASSE</button>
                <p id="form-message" class="form-message"></p>
            </form>
        </div>
        <footer class="portal-footer">
            <a href="../index.html" class="back-link">&lt;&lt; RETURN_TO_MAINFRAME</a>
        </footer>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const user = localStorage.getItem('sas_user') || 'INCONNU';
            const level = localStorage.getItem('sas_level') || '0';
            
            document.getElementById('agent-name-status').textContent = `AGENT: ${user}`;
            document.getElementById('profile-name').textContent = user;
            document.getElementById('profile-level').textContent = `NIVEAU ${level}`;
            
            if (parseInt(level) >= 3) {
                document.getElementById('profile-level').style.color = '#ff4141';
            } else {
                document.getElementById('profile-level').style.color = '#00ff00';
            }
            
            const passwordForm = document.getElementById('change-password-form');
            const newPasswordEl = document.getElementById('new-password');
            const confirmPasswordEl = document.getElementById('confirm-password');
            const messageEl = document.getElementById('form-message');

            
            function validatePassword(password) {
                // Au moins 5 caractères
                if (password.length < 5) {
                    return "Erreur: Mot de passe trop court (5 min).";
                }
               
                const specialCharRegex = /[^A-Za-z0-9]/;
                if (!specialCharRegex.test(password)) {
                    return "Erreur: Doit contenir au moins 1 caractère spécial (!, @, #, $, etc.)";
                }
                return null; 
            }

            passwordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                messageEl.textContent = 'Mise à jour en cours...';
                messageEl.className = 'form-message';

                const newPassword = newPasswordEl.value;
                const confirmPassword = confirmPasswordEl.value;

                // Vérification 1: Correspondance
                if (newPassword !== confirmPassword) {
                    messageEl.textContent = 'Erreur: Les mots de passe ne correspondent pas.';
                    messageEl.className = 'form-message error';
                    return;
                }
                
                
                const validationError = validatePassword(newPassword);
                if (validationError) {
                    messageEl.textContent = validationError;
                    messageEl.className = 'form-message error';
                    return;
                }

                try {
                    const response = await fetch('../api/change-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            username: user, 
                            newPassword: newPassword 
                        })
                    });

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error);
                    
                    messageEl.textContent = 'Succès ! Mot de passe mis à jour.';
                    messageEl.className = 'form-message success';
                    newPasswordEl.value = '';
                    confirmPasswordEl.value = '';

                } catch (error) {
                    messageEl.textContent = `Erreur: ${error.message}`;
                    messageEl.className = 'form-message error';
                }
            });
        });
    </script>
</body>
</html>