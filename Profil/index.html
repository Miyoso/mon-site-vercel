<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - Gestion Sécurité</title>

    <script> const REQUIRED_LEVEL = 1; </script>
    <script src="../security.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style-profil.css">
</head>
<body>

    <div class="security-container">
        <h1><span class="blink">&gt;&gt;</span>GESTION DE LA SÉCURITÉ</h1>

        <p class="status" id="agent-status-display">AGENT: [CHARGEMENT...]</p>


        <div class="alert-box">
            <span class="quote">"Attention, mettez un mot de passe différent de vos mots de passe habituels."</span>
            <span class="signature">-- Je vois vos mots de passe -- Ada :)</span>
        </div>

        <form id="change-password-form">
            <div class="form-group">
                <label for="new-password"><span class="blink">&gt;&gt;</span>NOUVEAU MOT DE PASSE:</label>
                <input type="password" id="new-password" class="form-input" required>
            </div>

            <div class="form-group">
                <label for="confirm-password"><span class="blink">&gt;&gt;</span>CONFIRMER LE MOT DE PASSE:</label>
                <input type="password" id="confirm-password" class="form-input" required>
            </div>

            <button type="submit" class="btn-submit">
                &gt;&gt; Changer le mot de passe
            </button>

            <p id="form-message" class="form-message"></p>
        </form>

        <footer class="footer-link">
            <a href="../index.html">&lt;&lt; RETURN_TO_MAINFRAME</a>
        </footer>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            
            const user = localStorage.getItem('sas_user') || 'INCONNU';
            const level = localStorage.getItem('sas_level') || '0';
            
            
            const statusMessage = document.getElementById('agent-status-display');
            if (user === 'INCONNU') {
                statusMessage.textContent = 'AGENT: [ERREUR_SESSION]';
                statusMessage.style.color = '#ff4444'; // Rouge
            } else {
                
                statusMessage.innerHTML = `AGENT: <span class="status-secure">${user}</span> :: ACCREDITATION: <span class="status-level">${level}</span>`;
            }
            // 

            const passwordForm = document.getElementById('change-password-form');
            const newPasswordEl = document.getElementById('new-password');
            const confirmPasswordEl = document.getElementById('confirm-password');
            const messageEl = document.getElementById('form-message');

            function validatePassword(password) {
                if (password.length < 5) {
                    return "Erreur: Mot de passe trop court (5 min).";
                }
                const specialCharRegex = /[^A-Za-z0-9]/;
                if (!specialCharRegex.test(password)) {
                    return "Erreur: Doit contenir au moins 1 caractère spécial (!, @, #, $, etc.)";
                }
                return null;
            }

            passwordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                messageEl.textContent = 'MISE A JOUR EN COURS...';
                messageEl.className = 'form-message';

                const newPassword = newPasswordEl.value;
                const confirmPassword = confirmPasswordEl.value;

                if (newPassword !== confirmPassword) {
                    messageEl.textContent = 'ERREUR: NON-CONCORDANCE';
                    messageEl.className = 'form-message error';
                    return;
                }
                
                const validationError = validatePassword(newPassword);
                if (validationError) {
                    messageEl.textContent = validationError.toUpperCase();
                    messageEl.className = 'form-message error';
                    return;
                }

                try {
                    const response = await fetch('../api/change-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            username: user, 
                            newPassword: newPassword 
                        })
                    });

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error);
                    
                    messageEl.textContent = 'SUCCES! MOT DE PASSE MIS A JOUR.';
                    messageEl.className = 'form-message success';
                    newPasswordEl.value = '';
                    confirmPasswordEl.value = '';

                } catch (error) {
                    messageEl.textContent = `ERREUR: ${error.message}`;
                    messageEl.className = 'form-message error';
                }
            });
        });
    </script>
</body>
</html>