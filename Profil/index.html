<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - Gestion Sécurité</title>

    <script> const REQUIRED_LEVEL = 1; </script>
    <script src="../security.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style-profil.css">
</head>
<body>

    <div class="security-container">
        <div class="prompt-header">
            ┌──(<span id="prompt-user" class="username">[LOADING]</span><span class="host">㉿sas-mainframe</span>)-[<span class="path">~/profil</span>]
        </div>

        <h1>
            <span class="prompt-end">└─<span class="blink">#</span></span>
            change_passphrase
        </h1>

        <p class="status" id="agent-status-display">AGENT: [CHARGEMENT...]</p>
        
        <div class="warning-notes-container">
            <h1>
                <span class="prompt-end">└─<span class="blink">#</span></span>
                dossier_avertissement
            </h1>
            <p class="status" id="warning-level-display">NIVEAU D'AVERTISSEMENT: [CHARGEMENT...]</p>
            <ul class="warning-notes-list" id="warning-notes-list">
                <li class="warning-note-empty">[CHARGEMENT DES NOTES...]</li>
            </ul>
        </div>
        
        <footer class="footer-link">
            <a href="../index.html">&lt;&lt; RETURN_TO_MAINFRAME</a>
        </footer>
    </div> 
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const user = localStorage.getItem('sas_user') || 'INCONNU';
            const level = localStorage.getItem('sas_level') || '0';
            
            document.getElementById('prompt-user').textContent = user.toLowerCase();
            
            async function loadAgentDetails() {
                const warningLevelEl = document.getElementById('warning-level-display');
                const warningListEl = document.getElementById('warning-notes-list');
                const agentStatusDisplay = document.getElementById('agent-status-display');
                
                try {
                    // CORRECTION : Utilisation du chemin ABSOLU FIABLE
                    const response = await fetch(`/api/read?resource=agent-details&username=${user}`);
                    const data = await response.json();

                    if (!response.ok) throw new Error(data.error || 'Erreur inconnue de l\'API');

                    // Mettre à jour l'affichage STATUS (qui était en CHARGEMENT...)
                    agentStatusDisplay.innerHTML = `AGENT: <span class="status-secure">${user}</span> :: ACCREDITATION: <span class="status-level">${level}</span>`;

                    warningLevelEl.textContent = \`NIVEAU D'AVERTISSEMENT: \${data.warningLevel}\`;

                    if (data.warningNotes && data.warningNotes.length > 0) {
                        let notesHTML = '';
                        data.warningNotes.forEach(note => {
                            notesHTML += \`
                                <li class="warning-note-item">
                                    <span class="warning-note-meta">
                                        De: <span class="author">\${note.author_name}</span> (Le \${new Date(note.created_at).toLocaleDateString()})
                                    </span>
                                    <p class="warning-note-text">\${note.note_text}</p>
                                </li>
                            \`;
                        });
                        warningListEl.innerHTML = notesHTML;
                    } else {
                        warningListEl.innerHTML = '<li class="warning-note-empty">Aucune note d\'avertissement dans votre dossier.</li>';
                    }

                } catch (error) {
                    console.error('Erreur API Profil:', error);
                    // Mettre l'affichage en mode erreur si le chargement échoue
                    agentStatusDisplay.innerHTML = \`AGENT: \${user} :: ACCREDITATION: <span style="color:#ff6666;">[ÉCHEC]</span>\`;
                    warningLevelEl.textContent = "NIVEAU D'AVERTISSEMENT: [ÉCHEC_CONNEXION]";
                    warningListEl.innerHTML = \`<li class="warning-note-empty" style="color: #ff6666;">ERREUR DE SERVICE: \${error.message}</li>\`;
                }
            }
            
            // (Le reste de la logique pour changer le mot de passe n'a pas été inclus pour l'exemple, 
            // mais assurez-vous qu'elle est présente dans votre fichier réel)

            loadAgentDetails();
        });
    </script>
</body>
</html>