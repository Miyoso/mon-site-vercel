<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dossier Audio Confidentiel</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> 
    
    <link rel="stylesheet" href="style.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
</head>
<body>

    <audio id="mon-audio" src="School_classroom_amb_#3-1762423618105.mp3" preload="auto"></audio>

    <div id="bouton-visualiseur">
        <i id="icone-livre" class="fa-solid fa-book"></i>
        <div id="visualiseur-conteneur" class="pointille-ligne">
            </div>
    </div>

    <script>
    window.addEventListener('DOMContentLoaded', () => {

        const bouton = document.getElementById('bouton-visualiseur');
        const audio = document.getElementById('mon-audio');
        const conteneur = document.getElementById('visualiseur-conteneur');
        const iconeLivre = document.getElementById('icone-livre');
        
        let audioContext;
        let analyseur;
        let source;
        let dataArray;
        let barresVisualiseur = [];
        let estInitialise = false;

        const NOMBRE_DE_BARRES = 32; // Nombre de barres du visualiseur

        function initialiserAudio() {
            if (estInitialise) return;

            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyseur = audioContext.createAnalyser();
            analyseur.fftSize = 128; 
            source = audioContext.createMediaElementSource(audio);
            source.connect(analyseur);
            analyseur.connect(audioContext.destination);

            const bufferLength = analyseur.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);

            conteneur.innerHTML = ''; 
            for (let i = 0; i < NOMBRE_DE_BARRES; i++) {
                const barre = document.createElement('div');
                barre.classList.add('barre-visualiseur');
                conteneur.appendChild(barre);
                barresVisualiseur.push(barre);
            }

            estInitialise = true;
        }

        function boucleAnimation() {
            requestAnimationFrame(boucleAnimation);

            // Vérifie si le contexte audio est encore actif et si l'audio joue
            if (audioContext && audioContext.state === 'running' && !audio.paused) {
                analyseur.getByteFrequencyData(dataArray);

                const step = Math.floor(dataArray.length / NOMBRE_DE_BARRES);
                for (let i = 0; i < NOMBRE_DE_BARRES; i++) {
                    let hauteurMoyenne = dataArray[i * step];
                    // Ajusté la hauteur pour une ligne plus fine et plus réactive
                    const hauteurBarre = (hauteurMoyenne / 255) * 10; // Max 10px de hauteur
                    const barre = barresVisualiseur[i];
                    
                    if (barre) {
                        barre.style.height = (hauteurBarre > 1 ? hauteurBarre : 1) + 'px'; // Hauteur min de 1px
                    }
                }
            } else {
                // Si l'audio est en pause ou arrêté, ramener les barres à leur état initial
                barresVisualiseur.forEach(barre => barre.style.height = '1px');
            }
        }

        bouton.addEventListener('click', () => {
            if (!estInitialise) {
                initialiserAudio();
            }

            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            if (audio.paused) {
                audio.play();
                iconeLivre.classList.remove('fa-book');
                iconeLivre.classList.add('fa-book-open');
                conteneur.classList.remove('pointille-ligne'); // Retire le style pointillé
                boucleAnimation();
            } else {
                audio.pause();
                iconeLivre.classList.remove('fa-book-open');
                iconeLivre.classList.add('fa-book');
                conteneur.classList.add('pointille-ligne'); // Remet le style pointillé
            }
        });

        audio.addEventListener('ended', () => {
            iconeLivre.classList.remove('fa-book-open');
            iconeLivre.classList.add('fa-book');
            conteneur.classList.add('pointille-ligne'); 
            barresVisualiseur.forEach(barre => barre.style.height = '1px');
        });

        // Initialiser l'état initial du bouton (livre fermé, ligne pointillée)
        iconeLivre.classList.add('fa-book');
        conteneur.classList.add('pointille-ligne');
    });
    </script>
</body>
</html>