<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - Agent Database</title>
    
    <script> const REQUIRED_LEVEL = 1; </script>
    <script src="security.js"></script>

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style-database.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
</head>
<body>

    <main class="terminal">
        
        <img src="logo-sas.png" alt="Logo SAS" class="logo">

        <div class="system-status">
            SYSTEM STATUS: <span class="secured">SECURED</span> :: ACCESS: <span class="encrypted">[ENCRYPTED]</span>
        </div>

        <div class="org-chart">
            <div class="chart-node lead" id="agent-box-graves">
                <div class="role">[DIR]</div>
                <div class="name">[CHARGEMENT...]</div>
                <a href="#" class="action-button">[ACCÈS PROFIL]</a>
            </div>
            
            <div class="chart-sub">
                <div class="chart-node subordinate" id="agent-box-javier">
                    <div class="role">[AGENT_LTN]</div>
                    <div class="name">[CHARGEMENT...]</div>
                    <a href="#" class="action-button">[FICHIER ENCRYPTÉ]</a>
                </div>
                <div class="chart-node subordinate" id="agent-box-ji">
                    <div class="role">[AGENT_LTN]</div>
                    <div class="name">[CHARGEMENT...]</div>
                    <a href="#" class="action-button">[VOIR DOSSIER]</a>
                </div>
            </div>
        </div>
        
        <div class="operators-section">
            <h2 class="section-title">//: OPÉRATEURS ACTIFS</h2>
            <div class="operators-grid" id="operators-grid-container">
                </div>
        </div>

        <footer class="portal-footer">
            <a href="index.html" class="back-link">&lt;&lt; RETURN_TO_MAINFRAME</a>
        </footer>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const gridContainer = document.getElementById('operators-grid-container');
            
            const gravesBox = document.getElementById('agent-box-graves');
            const javierBox = document.getElementById('agent-box-javier');
            const jiBox = document.getElementById('agent-box-ji');

            
            async function destroyAgentData(agentId) {
                try {
                    
                    console.warn(`Simulation: Destruction des données pour Agent ID ${agentId}`);
                    
                    
                } catch (error) {
                    console.error("Erreur lors de la corruption des données:", error);
                }
            }


            try {
                const response = await fetch('/api/get-agents');
                const data = await response.json();

                if (data.agents && data.agents.length > 0) {
                    
                    let gridHTML = '';
                    data.agents.sort((a, b) => a.id - b.id);

                    data.agents.forEach(agent => {
                        
                        // -- Traitement agents-clés --
                        if (agent.id === 1 || agent.id === 8 || agent.id === 18) {
                            let box;
                            if (agent.id === 1) box = gravesBox;
                            if (agent.id === 8) box = javierBox;
                            if (agent.id === 18) box = jiBox;
                            
                            box.querySelector('.name').textContent = agent.name;
                            box.querySelector('a').href = agent.profile_url;
                            return;
                        }

                        // -- Traitement grille --
                        const parts = agent.status_text.split('::').map(part => part.trim());
                        const statusText = parts[1] || '[STATUS_UNKNOWN]';
                        const dataText = parts[2] || null;

                        let statusClass = 'status-gray';
                        if (agent.css_class === 'decrypted') {
                            statusClass = 'status-green';
                        } else if (agent.css_class === 'corrupted') {
                            statusClass = 'status-red';
                        }
                        
                        let cellHTML = `
                            <a href="${agent.profile_url}" class="agent-cell ${statusClass} ${agent.css_class || ''}" data-id="${agent.id}">
                                <span class="agent-rank">[AGENT_STD]</span>
                        `;

                        if (statusText === 'DOSSIER SCELLÉ' && dataText === '[DECEASED]') {
                            cellHTML += `
                                <span class="agent-id">${statusText}</span> <span>::</span>
                                <span class="agent-data special" style="color: #ff4141;">[DECEASED]</span>
                            `;
                        } 
                        else if (dataText) {
                            cellHTML += `
                                <span class="agent-id">${statusText}</span> <span>::</span>
                                <span class="agent-status">${dataText}</span>
                            `;
                        } 
                        else {
                            cellHTML += `
                                <span class="agent-id" style="grid-column: 1 / 4;">${statusText}</span>
                            `;
                        }
                        
                        cellHTML += `</a>`;
                        gridHTML += cellHTML;
                    });

                    gridContainer.innerHTML = gridHTML;

                    // --- PIÈGE AGENT 13 
                    const agent13Link = document.querySelector('a[data-id="13"]');
                    
                    if (agent13Link) {
                        agent13Link.addEventListener('click', function(e) {
                         
                            e.preventDefault(); 
                            
                           
                            this.classList.add('is-corrupting');
                            
                         
                            this.href = '#';

                            
                            setTimeout(() => {
                                
                            }, 1000); 

                        }, { once: true });
                    }
                    

                } else {
                    gridContainer.innerHTML = '<p>[ERREUR: AUCUN AGENT TROUVÉ]</p>';
                }
            } catch (error) {
                console.error('Erreur lors de la récupération des agents:', error);
                gridContainer.innerHTML = '<p>[ERREUR DE CONNEXION AU MAINFRAME]</p>';
            }
        });
    </script>
</body>
</html>