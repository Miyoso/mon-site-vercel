<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - Dossiers Internes (Niv 3)</title>

    <script>
        const REQUIRED_LEVEL = 3;
    </script>
    <script src="security.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
</head>
<body>
    <main class="terminal">
        <h1>DOSSIERS INTERNES<span class="blinker">_</span></h1>
        
        <p class="status">ACCES: <span class="restricted" id="agent-name-display"></span> :: NIVEAU 3</p>

        <div id="dossiers-container">
            <p style="color: #00ff00;">[CHARGEMENT DES DOSSIERS...]</p>
        </div>

        <footer class="portal-footer">
            <a href="index.html" class="back-link">&lt;&lt; RETURN_TO_MAINFRAME</a>
        </footer>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('dossiers-container');
            
            // 'adminName' est défini ici, il sera visible par tout le script
            const adminName = localStorage.getItem('sas_user') || 'ADMIN';
            document.getElementById('agent-name-display').textContent = adminName;

            try {
                // 1. On charge les agents ET les notes en même temps
                const [agentsResponse, notesResponse] = await Promise.all([
                    fetch('/api/get-agents'),
                    fetch('/api/get-notes')
                ]);
                
                const agentsData = await agentsResponse.json();
                const notesData = await notesResponse.json();

                if (!agentsData.agents || !notesData.notes) {
                    throw new Error('Erreur lors du chargement des données.');
                }

                const agents = agentsData.agents.sort((a, b) => a.id - b.id);
                const allNotes = notesData.notes;

            
                container.innerHTML = ''; 
                
                agents.forEach(agent => {
                    const agentNotes = allNotes.filter(note => note.agent_id === agent.id);
                    const agentBlock = document.createElement('div');
                    agentBlock.className = 'report-content agent-dossier';
                    
                    let notesHTML = '';
                    if (agentNotes.length > 0) {
                        agentNotes.forEach(note => {
                            notesHTML += `
                                <li class="note-item">
                                    <span class="note-meta">De: ${note.author_name} (Le ${new Date(note.created_at).toLocaleDateString()})</span>
                                    <p class="note-text">${note.note_text}</p>
                                </li>
                            `;
                        });
                    } else {
                        notesHTML = '<li class="note-item-empty">Aucune note pour cet agent.</li>';
                    }

                    agentBlock.innerHTML = `
                        <h3 class="category-title dossier-title">${agent.name} (Niv ${agent.level})</h3>
                        <ul class="notes-list">
                            ${notesHTML}
                        </ul>
                        <form class="add-note-form" data-agent-id="${agent.id}">
                            <textarea class="note-textarea" placeholder="Ajouter une note privée..."></textarea>
                            <button type="submit" class="form-button">&gt;&gt; Ajouter la note</button>
                            <p class="form-message"></p>
                        </form>
                    `;
                    container.appendChild(agentBlock);
                });

            } catch (error) {
                console.error('Erreur:', error);
                container.innerHTML = `<p style="color: #ff4141;">[ERREUR CRITIQUE DE CONNEXION AU MAINFRAME]</p>`;
            }

          
            container.addEventListener('submit', async (e) => {
                if (e.target.classList.contains('add-note-form')) {
                    e.preventDefault();
                    
                    const form = e.target;
                    const agentId = form.getAttribute('data-agent-id');
                    const textarea = form.querySelector('.note-textarea');
                    const noteText = textarea.value;
                    const messageEl = form.querySelector('.form-message');

                    if (!noteText) {
                        messageEl.textContent = "La note ne peut pas être vide.";
                        messageEl.className = 'form-message error';
                        return;
                    }

                    messageEl.textContent = "Ajout en cours...";
                    messageEl.className = 'form-message';

                    try {
                        const response = await fetch('/api/add-note', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                agent_id: parseInt(agentId),
                                author_name: adminName, 
                                note_text: noteText
                            })
                        });

                        const result = await response.json();
                        if (!response.ok) throw new Error(result.error);

                        messageEl.textContent = "Note ajoutée !";
                        messageEl.className = 'form-message success';
                        textarea.value = '';
                        
                        setTimeout(() => location.reload(), 1000);

                    } catch (error) {
                        messageEl.textContent = `Erreur: ${error.message}`;
                        messageEl.className = 'form-message error';
                    }
                }
            });
        

        });
    </script>
</body>
</html>