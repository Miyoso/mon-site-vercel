<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - Inventaire (Niv 3)</title>
    <script>
        const REQUIRED_LEVEL = 3;
    </script>
    <script src="security.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
</head>
<body>
    <main class="terminal">
        <h1>INVENTAIRE GLOBAL<span class="blinker">_</span></h1>
        
        <p class="status">ACCES: <span class="restricted" id="inventory-name-display"></span> :: NIVEAU 3</p>

        <div class="report-content">
            <h2>Ajouter/Modifier Item</h2>
            <form id="add-item-form" class="inventory-form">
                <input type="text" name="name" placeholder="Nom de l'Item" required>
                <input type="text" name="category" placeholder="Catégorie (Ex: ARMES, VEHICULES)" required>
                <input type="number" name="quantity" placeholder="Quantité" min="0" required>
                <input type="hidden" name="id" id="item-id-hidden"> 
                <button type="submit" id="submit-button">AJOUTER</button>
            </form>

            <div class="inventory-list" id="inventory-container">
                <p style="color: #00ff00;">[CHARGEMENT DE L'INVENTAIRE...]</p>
            </div>
            
        </div>

        <footer class="portal-footer">
            <a href="index.html" class="back-link">&lt;&lt; RETURN_TO_MAINFRAME</a>
        </footer>
    </main>

    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('inventory-container');
            const form = document.getElementById('add-item-form');
            const submitButton = document.getElementById('submit-button');
            const inventoryName = localStorage.getItem('sas_user') || 'ADMIN';
            document.getElementById('inventory-name-display').textContent = inventoryName;

            // Fonction pour charger et afficher l'inventaire
            async function loadInventory() {
                container.innerHTML = '<p style="color: #00ff00;">[CHARGEMENT DE L\'INVENTAIRE...]</p>';
                try {
                    // --- MODIFICATION ICI : Appel à la nouvelle API READ (Inventaire) ---
                    const inventoryResponse = await fetch('/api/read?resource=inventory');
                    const inventoryData = await inventoryResponse.json();

                    if (!inventoryData.items) throw new Error('Données d\'inventaire non reçues');
                    
                    // --- MODIFICATION ICI : Appel à la nouvelle API READ (Agents pour la logistique) ---
                    const agentsResponse = await fetch('/api/read?resource=agents');
                    const agentsData = await agentsResponse.json();
                    
                    if (!agentsData.agents) throw new Error('Données d\'agents non reçues');
                    
                    // Créer un dictionnaire de noms d'agents par ID
                    const agentNames = agentsData.agents.reduce((acc, agent) => {
                        acc[agent.id] = agent.name;
                        return acc;
                    }, {});

                    let inventoryHTML = `
                        <div class="inventory-header">
                            <span>ID</span>
                            <span>ITEM</span>
                            <span>CATÉGORIE</span>
                            <span>QTE</span>
                            <span>MAJ PAR</span>
                            <span>ACTIONS</span>
                        </div>
                        <div class="inventory-grid">
                    `;
                    
                    inventoryData.items.forEach(item => {
                        // Utiliser le dictionnaire pour le nom
                        const modifierName = item.modified_by_agent_id ? agentNames[item.modified_by_agent_id] || 'INCONNU' : 'N/A';
                        
                        inventoryHTML += `
                            <span data-label="ID">${item.id}</span>
                            <span data-label="ITEM">${item.name}</span>
                            <span data-label="CATÉGORIE">${item.category}</span>
                            <span data-label="QTE">${item.quantity}</span>
                            <span data-label="MAJ PAR">${modifierName}</span>
                            <span data-label="ACTIONS">
                                <button class="form-button edit-item-btn" data-id="${item.id}" data-name="${item.name}" data-category="${item.category}" data-quantity="${item.quantity}">MOD</button>
                                <button class="form-button delete-item-btn" data-id="${item.id}">SUPPR</button>
                            </span>
                        `;
                    });

                    inventoryHTML += `</div>`;
                    container.innerHTML = inventoryHTML;

                } catch (error) {
                    console.error('Erreur:', error);
                    container.innerHTML = `<p style="color: #ff4141;">[ERREUR CRITIQUE DE CONNEXION] : ${error.message}</p>`;
                }
            }
            
            // ... (Le reste du script pour l'ajout, la modification et la suppression reste inchangé) ...
            
            // Événement d'édition (Remplit le formulaire)
            container.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-item-btn')) {
                    const button = e.target;
                    document.querySelector('#item-id-hidden').value = button.dataset.id;
                    document.querySelector('input[name="name"]').value = button.dataset.name;
                    document.querySelector('input[name="category"]').value = button.dataset.category;
                    document.querySelector('input[name="quantity"]').value = button.dataset.quantity;
                    submitButton.textContent = 'MODIFIER';
                }
                
                // Événement de suppression (Appel à /api/delete-inventory)
                if (e.target.classList.contains('delete-item-btn')) {
                    const itemId = e.target.dataset.id;
                    if (!confirm(`Confirmer la suppression de l'item ID ${itemId} ?`)) {
                        return;
                    }
                    
                    fetch('/api/delete-inventory', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ itemId: parseInt(itemId) })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            loadInventory();
                            alert('Item supprimé.');
                        } else {
                            alert(`Erreur: ${data.error}`);
                        }
                    })
                    .catch(error => alert(`Erreur serveur: ${error.message}`));
                }
            });

            // Événement de soumission (Appel à /api/add-inventory)
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const itemId = document.querySelector('#item-id-hidden').value;
                const endpoint = itemId ? '/api/update-inventory' : '/api/add-inventory';
                
                const formData = {
                    name: form.name.value,
                    category: form.category.value,
                    quantity: parseInt(form.quantity.value),
                    agentId: parseInt(localStorage.getItem('sas_agent_id')), // Assurez-vous que l'ID est stocké
                };
                
                if (itemId) {
                    formData.itemId = parseInt(itemId);
                }

                submitButton.textContent = '...';

                fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        loadInventory();
                        form.reset();
                        document.querySelector('#item-id-hidden').value = '';
                        submitButton.textContent = 'AJOUTER';
                    } else {
                        alert(`Erreur: ${data.error}`);
                        submitButton.textContent = 'ERREUR';
                    }
                })
                .catch(error => {
                    alert(`Erreur serveur: ${error.message}`);
                    submitButton.textContent = 'ERREUR';
                });
            });
            
            loadInventory();
        });
    </script>
</body>
</html>