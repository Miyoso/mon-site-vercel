<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - Inventaire (Niv 3)</title>

    <script>
        const REQUIRED_LEVEL = 3;
    </script>
    <script src="security.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
</head>
<body>
    <main class="terminal">
        <h1>INVENTAIRE (NIV 3)<span class="blinker">_</span></h1>
        
        <p class="status">STATUS: <span class="secure">DECRYPTED</span> :: ACCES: <span class="restricted" id="agent-name-display"></span></p>

        <div class="report-content" id="inventory-container">
            <p>[CHARGEMENT DE L'INVENTAIRE DEPUIS LA BASE DE DONNÉES...]</p>
        </div>

        <footer class="portal-footer">
            <a href="index.html" class="back-link">&lt;&lt; RETURN_TO_MAINFRAME</a>
        </footer>
    </main>


    <script>
        // On attend que la page soit chargée
        document.addEventListener('DOMContentLoaded', () => {
            
            // On récupère tous les éléments dont on a besoin
            const agentName = localStorage.getItem('sas_user') || 'UNKNOWN';
            document.getElementById('agent-name-display').textContent = agentName;

            const container = document.getElementById('inventory-container');
            
            // --- FONCTION 1 : AFFICHER L'INVENTAIRE (ET REMPLIR LES FORMULAIRES) ---
            async function fetchAndDisplayInventory() {
                
                try {
                    // On appelle le "Cerveau" de l'inventaire
                    const response = await fetch('/api/get-inventory');
                    const data = await response.json();

                    if (!data.items) throw new Error('Données d\'inventaire non reçues');

                    // On vide le conteneur
                    container.innerHTML = '';
                    
                    let htmlToInsert = '';
                    let currentCategory = '';
                    let itemOptionsHTML = '<option value="">-- Sélectionner un objet --</option>'; // Pour le formulaire

                    // Boucle sur les objets
                    data.items.forEach(item => {
                        // Affiche la liste principale
                        if (item.category !== currentCategory) {
                            if (currentCategory !== '') htmlToInsert += `</ul>`;
                            currentCategory = item.category;
                            htmlToInsert += `<h3 class="category-title">//: ${currentCategory.toUpperCase()}</h3><ul class="inventory-list">`;
                        }
                        htmlToInsert += `
                            <li>
                                <span class="item-name">${item.item_name}</span>
                                <ul class="item-details">
                                    <li><span class="detail-label">N° de série:</span> ${item.serial_number || 'N/A'}</li>
                                    <li><span class="detail-label">Attribution:</span> ${item.assigned_to || 'Aucune'}</li>
                                    <li><span class="detail-label">Statut:</span> ${item.status}</li>
                                </ul>
                            </li>
                        `;

                        // Prépare la liste pour le formulaire
                        itemOptionsHTML += `<option value="${item.id}">${item.item_name} (N°: ${item.serial_number})</option>`;
                    });
                    htmlToInsert += `</ul>`; // Ferme la dernière liste

                    // Injecte le formulaire d'assignation
                    htmlToInsert += `
                        <h3 class="category-title" id="form-title">//: ASSIGNATION D'ÉQUIPEMENT</h3>
                        <form id="assignment-form" class="assignment-form">
                            <label for="item-select">//: 1. SÉLECTIONNER L'OBJET</label>
                            <select id="item-select" name="itemId" class="form-select" required>
                                ${itemOptionsHTML} </select>
                            
                            <label for="agent-select">//: 2. ASSIGNER À</label>
                            <select id="agent-select" name="agentName" class="form-select" required>
                                <option value="">-- Chargement des agents... --</option>
                            </select>
                            
                            <button type="submit" class="form-button">&gt;&gt; CONFIRMER L'ASSIGNATION</button>
                            <p id="form-message" class="form-message"></p>
                        </form>
                    `;
                    
                    // On injecte tout le HTML
                    container.innerHTML = htmlToInsert;

                    // MAINTENANT que le formulaire existe, on remplit les agents et on écoute
                    fetchAgentsForForm();
                    setupFormListener();

                } catch (error) {
                    console.error('Erreur:', error);
                    container.innerHTML = '<p>[ERREUR DE CONNEXION AU MAINFRAME]</p>';
                }
            }

            // --- FONCTION 2 : REMPLIR LA LISTE DES AGENTS ---
            async function fetchAgentsForForm() {
                try {
                    const agentSelect = document.getElementById('agent-select');
                    const response = await fetch('/api/get-agents');
                    const data = await response.json();

                    if (!data.agents) throw new Error('Agents non reçus');

                    let agentOptionsHTML = '<option value="Réserve SAS">-- Réserve SAS --</option>'; // Option pour désassigner
                    data.agents.forEach(agent => {
                        // On utilise le VRAI nom de l'agent
                        agentOptionsHTML += `<option value="${agent.name}">${agent.name} (Niv ${agent.level})</option>`;
                    });
                    
                    agentSelect.innerHTML = agentOptionsHTML;

                } catch (error) {
                    console.error('Erreur agents:', error);
                    document.getElementById('agent-select').innerHTML = '<option value="">Erreur API</option>';
                }
            }

            // --- FONCTION 3 : GÉRER L'ENVOI DU FORMULAIRE ---
            function setupFormListener() {
                const form = document.getElementById('assignment-form');
                const messageEl = document.getElementById('form-message');

                form.addEventListener('submit', async (e) => {
                    e.preventDefault(); // Empêche la page de recharger
                    
                    const itemId = form.itemId.value;
                    const agentName = form.agentName.value;

                    if (!itemId || !agentName) {
                        messageEl.textContent = 'Sélection requise';
                        messageEl.className = 'form-message error';
                        return;
                    }

                    messageEl.textContent = 'Assignation en cours...';
                    messageEl.className = 'form-message';

                    try {
                        // On appelle notre NOUVEAU "Cerveau" (api/assign-item.js)
                        const response = await fetch('/api/assign-item', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ itemId, agentName }) // On envoie l'ordre
                        });

                        const result = await response.json();

                        if (!response.ok) throw new Error(result.error);
                        
                        // C'est un succès !
                        messageEl.textContent = 'Assignation confirmée ! Mise à jour...';
                        messageEl.className = 'form-message success';
                        
                        // La "magie" : on recharge tout l'inventaire pour voir le changement
                        setTimeout(fetchAndDisplayInventory, 1000); 

                    } catch (error) {
                        console.error('Erreur d\'assignation:', error);
                        messageEl.textContent = `Erreur: ${error.message}`;
                        messageEl.className = 'form-message error';
                    }
                });
            }

            // --- DÉMARRAGE ---
            // On lance la première fonction qui s'occupe de tout
            fetchAndDisplayInventory();

        });
    </script>
</body>
</html>