<!DOCTYPE html>
<html>
<head>
    <title>Agent Database - Carte Interactive (GTA V)</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/SJPMeX/KwGzIDdd8"
        crossorigin=""/>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="terminal">
        <h1 class="map-title">Localisation des Agents - San Andreas (GTA V)</h1>
        
        <div id="map-container"></div>

        <div class="portal-footer">
            <span style="color: #888;">// DATABASE ONLINE //</span>
            <a href="index.html" class="back-link">SYSTEM ROOT</a>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20n6a32hQePz4gJ2kKk8/sQ+G39G1n4g1F4L7A5lD"
        crossorigin=""></script>

    <script>
        document.addEventListener('DOMContentLoaded', initializeMap);

        function initializeMap() {
            const IMAGE_WIDTH_PIXELS = 4096;
            const IMAGE_HEIGHT_PIXELS = 4096;
            const GAME_X_MIN = -4000;
            const GAME_X_MAX = 4000;
            const GAME_Y_MIN = -4000;
            const GAME_Y_MAX = 4000;

            const X_RANGE = GAME_X_MAX - GAME_X_MIN;
            const Y_RANGE = GAME_Y_MAX - GAME_Y_MIN;
            
            const gtaV_CRS = L.extend({}, L.CRS.Simple, {
                transformation: new L.Transformation(
                    IMAGE_WIDTH_PIXELS / X_RANGE, 
                    -IMAGE_WIDTH_PIXELS * GAME_X_MIN / X_RANGE,
                    -IMAGE_HEIGHT_PIXELS / Y_RANGE, 
                    IMAGE_HEIGHT_PIXELS * GAME_Y_MAX / Y_RANGE
                )
            });

            const map = L.map('map-container', {
                crs: gtaV_CRS, 
                minZoom: -2,
                maxZoom: 3,
                center: [0, 0], 
                zoom: -1, 
                maxBoundsViscosity: 1.0, 
            });

            const bounds = [[GAME_Y_MIN, GAME_X_MIN], [GAME_Y_MAX, GAME_X_MAX]];
            
            
            L.imageOverlay('carte-satellite-gta-5.jpg', bounds).addTo(map);

            
            map.setView([0, 0], 0); 


            fetch('/api/get-agents.js')
                .then(res => res.json())
                .then(data => {
                    const agents = data.agents || [];
                    
                    if (agents.length === 0) {
                        return;
                    }

                    agents.forEach(agent => {
                        const markerPosition = [agent.map_y, agent.map_x];

                        const popupContent = `
                            <h4>${agent.name} (Niv. ${agent.level})</h4>
                            <p>Statut: <b>${agent.status_text}</b></p>
                            <p>Niveau d'Alerte: ${agent.warning_level}</p>
                            <a href="${agent.profile_url}" target="_blank">Voir Profil</a>
                        `;

                        L.marker(markerPosition, {
                        }).addTo(map)
                          .bindPopup(popupContent);
                    });
                })
                .catch(error => {
                    console.error('Erreur lors de la récupération des agents:', error);
                });
        }
    </script>
</body>
</html>