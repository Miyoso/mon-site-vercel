<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - Agent Database</title>
    
    <script> const REQUIRED_LEVEL = 1; </script>
    <script src="/js/security.js"></script>

    <link rel="stylesheet" href="/css/style-mo.css">

    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
</head>
<body>

    <main class="terminal">
        
        <img src="/assets/logo-sas.png" alt="Logo SAS" class="logo">

        <div class="system-status">
            SYSTEM STATUS: <span class="secured">SECURED</span> :: ACCESS: <span class="encrypted">[ENCRYPTED]</span>
        </div>

        <div class="org-chart">
            <div class="chart-node lead" id="agent-box-graves">
                <div class="role">[DIR]</div>
                <div class="name">[CHARGEMENT...]</div>
                <a href="#" class="action-button">[ACCÈS PROFIL]</a>
            </div>
            
            <div class="chart-sub">
                <div class="chart-node subordinate" id="agent-box-javier">
                    <div class="role">[AGENT_LTN]</div>
                    <div class="name">[CHARGEMENT...]</div>
                    <a href="#" class="action-button">[FICHIER ENCRYPTÉ]</a>
                </div>
                <div class="chart-node subordinate" id="agent-box-ji">
                    <div class="role">[AGENT_LTN]</div>
                    <div class="name">[CHARGEMENT...]</div>
                    <a href="#" class="action-button">[VOIR DOSSIER]</a>
                </div>
            </div>
        </div>
        
        <div class="operators-section">
            <h2 class="section-title">//: OPÉRATEURS ACTIFS</h2>
            
            <div class="operators-grid" id="operators-grid-container">
                <div style="color: #444; font-size: 0.8rem;">[INITIALISATION DU FLUX DE DONNÉES...]</div>
            </div>
        </div>

        <footer class="portal-footer">
            <a href="/index.html" class="back-link">&lt;&lt; RETURN_TO_MAINFRAME</a>
        </footer>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const gridContainer = document.getElementById('operators-grid-container');
            
            // Références aux boîtes de l'organigramme
            const boxes = {
                1: document.getElementById('agent-box-graves'),
                3: document.getElementById('agent-box-javier'),
                18: document.getElementById('agent-box-ji')
            };

            try {
                console.log("Tentative de connexion à l'API...");
                const response = await fetch('/api/read?resource=agents');
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }

                const rawData = await response.json();
                console.log("Données reçues (Debug):", rawData);

               
                let agents = [];
                if (rawData.agents) {
                    agents = rawData.agents;
                } else if (rawData.rows) {
                    agents = rawData.rows;
                } else if (Array.isArray(rawData)) {
                    agents = rawData;
                }

                if (agents && agents.length > 0) {
                    
                    let gridHTML = '';
                    agents.sort((a, b) => a.id - b.id); 

                    agents.forEach(agent => {
                        
                        let cleanProfileUrl = (agent.profile_url || '#').replace(/^\//, '');

                       
                        if (boxes[agent.id]) {
                            const box = boxes[agent.id];
                            box.querySelector('.name').textContent = agent.name;
                            box.querySelector('a').href = cleanProfileUrl;
                            
                           
                            const btn = box.querySelector('.action-button');
                            if (agent.status_text && agent.status_text.includes("SCELLÉ")) {
                                btn.textContent = "[DOSSIER SCELLÉ]";
                                btn.style.color = "#ff3333"; // Rouge
                                btn.style.borderColor = "#ff3333";
                            } else {
                                btn.textContent = "[ACCÈS AUTORISÉ]";
                            }
                           
                            return; 
                        }

                       
                        
                     
                        const parts = agent.status_text ? agent.status_text.split('::') : ['UNKNOWN'];
                        let buttonText = parts.length > 1 ? parts[1].trim() : parts[0];
                        
                        // Raccourcis visuels
                        if (buttonText === 'DOSSIER SCELLÉ') buttonText = 'SCELLÉ';
                        if (buttonText === 'STATUT NON-SANCTIONNÉ') buttonText = 'N/A';

                        // Couleurs
                        let colorClass = 'status-gray';
                        if (agent.css_class === 'decrypted') colorClass = 'status-green';
                        else if (agent.css_class === 'corrupted') colorClass = 'status-red';
                        
                        gridHTML += `
                            <div class="chart-node team-member ${agent.css_class || ''}">
                                <div class="role">[AGENT_STD]</div>
                                <div class="name">${agent.name}</div>
                                <a href="${cleanProfileUrl}" class="action-button ${colorClass}">
                                    [${buttonText}]
                                </a>
                            </div>
                        `;
                    });

                    gridContainer.innerHTML = gridHTML;

                } else {
                    console.warn("Tableau 'agents' vide ou introuvable.");
                    gridContainer.innerHTML = '<p style="color:red;">[ERREUR: AUCUNE DONNÉE AGENT TROUVÉE]</p>';
                }

            } catch (error) {
                console.error('Erreur critique:', error);
                gridContainer.innerHTML = `<p style="color:red;">[ERREUR SYSTÈME: ${error.message}]</p>`;
            }
        });
    </script>
</body>
</html>