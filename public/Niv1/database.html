<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - Agent Database</title>
    
    <script> const REQUIRED_LEVEL = 1; </script>
    <script src="/js/security.js"></script>

    <link rel="stylesheet" href="/css/style-mo.css">

    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
</head>
<body>

    <main class="terminal">
        
        <img src="/assets/logo-sas.png" alt="Logo SAS" class="logo">

        <div class="system-status">
            SYSTEM STATUS: <span class="secured">SECURED</span> :: ACCESS: <span class="encrypted">[ENCRYPTED]</span>
        </div>

        <div class="org-chart">
            <div class="chart-node lead" id="agent-box-graves">
                <div class="role">[DIR]</div>
                <div class="name">[CHARGEMENT...]</div>
                <a href="#" class="action-button">[ACCÈS PROFIL]</a>
            </div>
            
            <div class="chart-sub">
                <div class="chart-node subordinate" id="agent-box-javier">
                    <div class="role">[AGENT_LTN]</div>
                    <div class="name">[CHARGEMENT...]</div>
                    <a href="#" class="action-button">[FICHIER ENCRYPTÉ]</a>
                </div>
                <div class="chart-node subordinate" id="agent-box-ji">
                    <div class="role">[AGENT_LTN]</div>
                    <div class="name">[CHARGEMENT...]</div>
                    <a href="#" class="action-button">[VOIR DOSSIER]</a>
                </div>
            </div>
        </div>
        
        <div class="operators-section">
            <h2 class="section-title">//: OPÉRATEURS ACTIFS</h2>
            
            <div class="operators-grid" id="operators-grid-container">
                <div style="color: #444; font-size: 0.8rem;">[INITIALISATION DU FLUX DE DONNÉES...]</div>
            </div>
        </div>

        <footer class="portal-footer">
            <a href="/index.html" class="back-link">&lt;&lt; RETURN_TO_MAINFRAME</a>
        </footer>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const gridContainer = document.getElementById('operators-grid-container');
            
       
            const gravesBox = document.getElementById('agent-box-graves');
            const javierBox = document.getElementById('agent-box-javier');
            const jiBox = document.getElementById('agent-box-ji');

            try {
    
                const response = await fetch('/api/read?resource=agents');
                const data = await response.json();

                if (data.agents && data.agents.length > 0) {
                    
                    let gridHTML = '';
          
                    data.agents.sort((a, b) => a.id - b.id);

                    data.agents.forEach(agent => {
                        
                        
                        let cleanProfileUrl = (agent.profile_url || '#').replace(/^\//, '');
                        
                      
                        if (agent.id === 1 || agent.id === 3 || agent.id === 18) {
                            let box;
                            if (agent.id === 1) box = gravesBox;
                            if (agent.id === 3) box = javierBox;
                            if (agent.id === 18) box = jiBox;
                            
                            if(box) {
                                box.querySelector('.name').textContent = agent.name;
                                box.querySelector('a').href = cleanProfileUrl; 
                                
                               
                                const btn = box.querySelector('.action-button');
                                if (agent.status_text && agent.status_text.includes("SCELLÉ")) {
                                    btn.textContent = "[DOSSIER SCELLÉ]";
                                    btn.style.color = "var(--terminal-red)";
                                    btn.style.borderColor = "var(--terminal-red)";
                                } else {
                                    btn.textContent = "[ACCÈS AUTORISÉ]";
                                }
                            }
                            return; 
                        }

                        
                        const parts = agent.status_text ? agent.status_text.split('::') : ['UNKNOWN'];
                        let buttonText = parts.length > 1 ? parts[1].trim() : parts[0];
                        
                        if (buttonText === 'DOSSIER SCELLÉ') buttonText = 'SCELLÉ';
                        if (buttonText === 'STATUT NON-SANCTIONNÉ') buttonText = 'N/A';

                        // Définition de la couleur selon le CSS renvoyé par la DB
                        let colorClass = 'status-gray';
                        if (agent.css_class === 'decrypted') {
                            colorClass = 'status-green';
                        } else if (agent.css_class === 'corrupted') {
                            colorClass = 'status-red';
                        }
                        
                        gridHTML += `
                            <div class="chart-node team-member ${agent.css_class || ''}">
                                <div class="role">[AGENT_STD]</div>
                                <div class="name">${agent.name}</div>
                                <a href="${cleanProfileUrl}" class="action-button ${colorClass}" data-id="${agent.id}">
                                    [${buttonText}]
                                </a>
                            </div>
                        `;
                    });

                    gridContainer.innerHTML = gridHTML;

                } else {
                    gridContainer.innerHTML = '<p style="color:red;">[ERREUR: AUCUNE DONNÉE AGENT]</p>';
                }
            } catch (error) {
                console.error('Erreur lors de la récupération des agents:', error);
                gridContainer.innerHTML = '<p style="color:red;">[ERREUR DE CONNEXION AU SERVEUR]</p>';
            }
        });
    </script>
</body>
</html>