<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHADOW CO. :: HIERARCHY</title>

    <link rel="stylesheet" href="/css/style-mo.css">
    <link rel="stylesheet" href="/css/style-hierarchy.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
</head>
<body>

    <div class="wrapper">
        
        <header>
            <h1>SHADOW_NET // <span style="color:var(--primary)">COMMAND_CHAIN</span></h1>
            <div class="meta" style="color:var(--dim)">SERVER: ONLINE</div>
        </header>

        <div class="director-container">
            <div class="node node-director" id="node-graves">
                <span class="role-label">COMMANDER</span>
                <div class="agent-name">[CHARGEMENT...]</div>
                <a href="#" class="btn-link">DOSSIER MAÎTRE</a>
            </div>
        </div>

        <div class="tree-line-vert"></div>
        <div class="tree-line-horiz"></div>

        <div class="ltn-container">
            <div class="node node-ltn" id="node-javier">
                <span class="role-label">LIEUTENANT (ARMOR)</span>
                <div class="agent-name">[CHARGEMENT...]</div>
                <a href="#" class="btn-link">PROFIL ></a>
            </div>

            <div class="node node-ltn" id="node-ji">
                <span class="role-label">LIEUTENANT (SPEC-OPS)</span>
                <div class="agent-name">[CHARGEMENT...]</div>
                <a href="#" class="btn-link">PROFIL ></a>
            </div>
        </div>

        <div class="tree-line-vert" style="height: 40px;"></div>
        <div class="squad-label">// UNITÉS SPÉCIALISÉES & SOUTIEN</div>

        <div class="squad-grid" id="squad-grid">
            </div>

        <div style="text-align: center; margin-top: 60px;">
             <a href="../index.html" class="btn-link" style="border-color: var(--danger); color: var(--danger);">[ DÉCONNEXION ]</a>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const gridContainer = document.getElementById('squad-grid');
            
            // Références aux boites fixes (Chefs)
            const boxGraves = document.getElementById('node-graves');
            const boxJavier = document.getElementById('node-javier');
            const boxJi = document.getElementById('node-ji');

            try {
                const response = await fetch('/api/read?resource=agents');
                const rawData = await response.json();

                // Gestion format données
                let agents = rawData.agents || rawData.rows || (Array.isArray(rawData) ? rawData : []);

                if (agents.length > 0) {
                    let gridHTML = '';
                    agents.sort((a, b) => a.id - b.id);

                    agents.forEach(agent => {
                        // URL propre
                        let cleanUrl = (agent.profile_url || '#').replace(/^\//, '');

                        // --- 1. REMPLIR LES CHEFS (ID FIXES) ---
                        if (agent.id === 1) { // Graves
                            boxGraves.querySelector('.agent-name').textContent = agent.name;
                            boxGraves.querySelector('a').href = cleanUrl;
                            return;
                        }
                        if (agent.id === 3) { // Javier
                            boxJavier.querySelector('.agent-name').textContent = agent.name;
                            boxJavier.querySelector('a').href = cleanUrl;
                            return;
                        }
                        if (agent.id === 18) { // Ji / Jackal
                            boxJi.querySelector('.agent-name').textContent = agent.name;
                            boxJi.querySelector('a').href = cleanUrl;
                            return;
                        }

                        // --- 2. REMPLIR LA GRILLE (SOLDATS) ---
                        
                        // Déterminer la couleur de la bordure et le rôle
                        let borderClass = '';
                        let roleTitle = 'OPÉRATEUR';
                        let btnText = 'VOIR >';
                        let btnStyle = '';

                        // Logique de style basée sur la classe CSS de la DB
                        if (agent.css_class === 'decrypted') {
                            borderClass = 'border-green';
                            roleTitle = 'ACTIF';
                        } else if (agent.css_class === 'corrupted' || (agent.status_text && agent.status_text.includes('SCELLÉ'))) {
                            borderClass = 'border-red';
                            roleTitle = 'RESTREINT';
                            btnText = 'HACK >';
                            btnStyle = 'color:var(--danger); border-color:var(--danger);';
                        } else {
                            // Par défaut (Gris)
                            roleTitle = 'INFANTERIE';
                        }

                        // Cas spéciaux pour simuler l'image (optionnel, basé sur le nom)
                        if(agent.name.includes("Cazares")) { borderClass = 'border-yellow'; roleTitle = "ADMINISTRATION"; }
                        if(agent.name.includes("Wei")) { borderClass = 'border-green'; roleTitle = "RECONNAISSANCE"; }
                        if(agent.name.includes("Nyx")) { borderClass = 'border-red'; roleTitle = "CYBER-WARFARE"; }

                        // Création de la carte HTML
                        gridHTML += `
                            <div class="node node-soldier ${borderClass}">
                                <span class="role-label">${roleTitle}</span>
                                <div class="agent-name">${agent.name}</div>
                                <div class="sub-info">ID: SC-${agent.id}</div>
                                <a href="${cleanUrl}" class="btn-link" style="${btnStyle}">${btnText}</a>
                            </div>
                        `;
                    });

                    gridContainer.innerHTML = gridHTML;
                } else {
                    gridContainer.innerHTML = '<div style="color:red">AUCUNE DONNÉE</div>';
                }

            } catch (e) {
                console.error(e);
                gridContainer.innerHTML = '<div style="color:red">ERREUR CONNEXION</div>';
            }
        });
    </script>

</body>
</html>