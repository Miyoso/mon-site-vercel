<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - Carte Tactique</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=JetBrains+Mono:wght@400;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    
    <link rel="stylesheet" href="/css/style-mo.css"> 

    <style>
        /* Ajustements de layout pour la carte */
        .terminal {
            max-width: 95vw; /* Plus large pour la carte */
            height: 90vh;
            padding: 1.5rem;
        }

        #map-container {
            flex-grow: 1;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            /* Filtre global sur la carte pour l'assombrir et la teinter */
            filter: sepia(20%) hue-rotate(180deg) contrast(110%) saturate(80%); 
        }

        /* --- STYLES DES CONTRÔLES (INPUTS) --- */
        #intel-controls {
            background: rgba(10, 15, 20, 0.8);
            border: 1px solid var(--dim);
            padding: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
            backdrop-filter: blur(5px);
        }

        .control-group label {
            color: var(--secondary);
            font-size: 0.8rem;
            font-family: var(--font-code);
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            display: block;
        }

        .intel-input, .intel-select {
            font-family: var(--font-ui);
            background: rgba(0,0,0,0.5); 
            color: #fff; 
            border: 1px solid var(--dim); 
            padding: 0.5rem; 
            font-size: 1rem;
            width: 100%;
            transition: all 0.3s ease;
        }

        .intel-input:focus, .intel-select:focus { 
            outline: none; 
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 255, 157, 0.2); 
        }

        /* Indicateur de mode */
        #add-mode-indicator { 
            color: var(--dim); 
            font-family: var(--font-code);
            font-size: 0.8rem;
            margin: 0.5rem 0;
            border-left: 2px solid var(--dim);
            padding-left: 10px;
            transition: color 0.3s;
        }
        #add-mode-indicator.active { 
            color: var(--primary); 
            border-color: var(--primary);
            text-shadow: 0 0 8px var(--primary);
            animation: blink 1.5s infinite; 
        }

        /* --- OVERRIDE LEAFLET (Thème Dark) --- */
        
        /* Popups */
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: rgba(15, 20, 25, 0.95);
            border: 1px solid var(--primary);
            color: #eee;
            border-radius: 0;
            font-family: var(--font-ui);
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.1);
        }
        .leaflet-popup-content h4 {
            font-family: var(--font-code);
            color: var(--secondary);
            border-bottom-color: var(--dim) !important;
        }
        .leaflet-container a.leaflet-popup-close-button {
            color: var(--danger);
        }

        /* Boutons de Zoom et Draw */
        .leaflet-bar { border: none; box-shadow: none; }
        .leaflet-bar a {
            background-color: rgba(10, 15, 20, 0.9) !important;
            border: 1px solid var(--dim) !important;
            color: var(--primary) !important;
            border-radius: 0 !important;
        }
        .leaflet-bar a:hover {
            border-color: var(--secondary) !important;
            color: #fff !important;
            background-color: rgba(255,255,255,0.1) !important;
        }
        
        /* Custom Markers */
        .custom-marker {
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: #000; font-weight: 800; font-size: 10px; border: 2px solid #000;
        }
        .imp-1 { background: var(--primary); box-shadow: 0 0 10px var(--primary); }
        .imp-2 { background: var(--warning); box-shadow: 0 0 10px var(--warning); }
        .imp-3 { background: #ff9900; box-shadow: 0 0 10px #ff9900; }
        .imp-4 { background: var(--danger); box-shadow: 0 0 15px var(--danger); animation: pulse-red 2s infinite; }

        @keyframes pulse-red { 0% {box-shadow: 0 0 0 0 rgba(255, 51, 51, 0.7);} 70% {box-shadow: 0 0 0 10px rgba(255, 51, 51, 0);} 100% {box-shadow: 0 0 0 0 rgba(255, 51, 51, 0);} }

        /* Agent Info */
        .current-agent-info { 
            color: var(--secondary); 
            font-family: var(--font-code);
            border: 1px solid var(--secondary); 
            padding: 0.5rem 1rem; 
            background: rgba(0, 243, 255, 0.05);
        }

        /* Boutons Actions */
        .delete-btn {
            background: rgba(255, 51, 51, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 8px;
            margin-top: 10px;
            width: 100%;
            font-family: var(--font-code);
            cursor: pointer;
            transition: all 0.2s;
        }
        .delete-btn:hover {
            background: var(--danger);
            color: #000;
            box-shadow: 0 0 10px var(--danger);
        }

        /* Toolbar Draw Icons - Inversion couleur pour matcher le thème */
        .leaflet-draw-toolbar a {
            filter: invert(1) hue-rotate(90deg); /* Tente de rendre les icones noires un peu vertes/cyan */
        }
        
        .leaflet-draw-actions { left: 35px !important; }
        .leaflet-draw-actions li a { 
            background-color: var(--bg-dark) !important; 
            color: var(--primary) !important;
            border-left: 1px solid var(--dim) !important;
        }
    </style>
</head>
<body>

    <div class="crt-overlay"></div>

    <div class="terminal-wrapper">
        <div class="terminal">
            
            <div class="header-strip">
                <div>
                    <h1>RENSEIGNEMENT <span>TACTIQUE</span></h1>
                    <div style="color: var(--primary); font-size: 0.9rem; letter-spacing: 2px;">VUE SATELLITE - SECTEUR 04</div>
                </div>
                <div class="meta-data">
                    <div id="clock">00:00:00</div>
                    <div style="color: var(--danger)">[CRYPTAGE: ACTIF]</div>
                </div>
            </div>

            <div id="intel-controls">
                <div class="current-agent-info" id="current-agent-display">[IDENTIFICATION...]</div>
                
                <div class="control-group" style="flex-grow: 2;">
                    <label>DONNÉES INTEL (DESCRIPTION)</label>
                    <input type="text" id="point-desc" class="intel-input" placeholder="Entrez description pour activer les outils..." autocomplete="off">
                </div>
                
                <div class="control-group" style="min-width: 150px;">
                    <label>NIVEAU DE MENACE</label>
                    <select id="point-importance" class="intel-select">
                        <option value="1" style="color:var(--primary)">NIV 1 - INFO</option>
                        <option value="2" style="color:var(--warning)">NIV 2 - ATTENTION</option>
                        <option value="3" style="color:#ff9900">NIV 3 - DANGER</option>
                        <option value="4" style="color:var(--danger)">NIV 4 - CRITIQUE</option>
                    </select>
                </div>
            </div>

            <div id="add-mode-indicator">EN ATTENTE... ENTREZ UNE DESCRIPTION POUR DÉVERROUILLER L'INTERFACE DESSIN.</div>
            
            <div id="map-container"></div>
            
            <div class="portal-footer">
                <a href="/index.html" class="back-link">[ < REVENIR AU DASHBOARD ]</a>
                <span style="color: var(--dim); font-size: 0.8rem; margin-left: 20px;">SAS-INTEL-V3.6 (SECURE)</span>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <script>
        // --- PETIT SCRIPT POUR L'HORLOGE ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('fr-FR');
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- CONFIGURATION CARTE EXISTANTE ---
        const mapExtent = [0, 0, 8192, 8192];
        const mapMaxZoom = 5;
        const crs = L.CRS.Simple;
        crs.transformation = new L.Transformation(1, 0, 1, 0);
        crs.scale = (zoom) => Math.pow(2, zoom) / (Math.pow(2, mapMaxZoom) * 1.0);
        crs.zoom = (scale) => Math.log(scale * (Math.pow(2, mapMaxZoom) * 1.0)) / Math.LN2;

        const imageBounds = [[0, 0], [8192, 8192]];

        // Fond de carte noir par défaut (couleur du container)
        
        const map = L.map('map-container', {
            maxZoom: mapMaxZoom, 
            minZoom: 1, 
            crs: crs,
            attributionControl: false, 
            zoomControl: false, 
            doubleClickZoom: false,
            center: [4096, 4096],
            zoom: 2
        });

        L.control.zoom({ position: 'topright' }).addTo(map);
        
        // Note: Assurez-vous que l'image existe. Sinon le fond sera noir tactique.
        L.imageOverlay('/assets/carte-satellite-gta-5.jpg', imageBounds).addTo(map);
        
        map.setMaxBounds([[-8000, -8000], [16000, 16000]]); 

        let pointsLayer = L.layerGroup().addTo(map);
        let drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        let currentAgent = null;

        // Configuration des couleurs de dessin pour matcher le thème
        const drawControl = new L.Control.Draw({
            draw: {
                polyline: { shapeOptions: { color: '#00ff9d', weight: 3 } }, // var(--primary)
                polygon: { shapeOptions: { color: '#00ff9d' }, allowIntersection: false, showArea: true },
                rectangle: { shapeOptions: { color: '#eebb00', weight: 2 } }, // var(--warning)
                circle: false, marker: false, circlemarker: false
            },
            edit: false
        });

        async function init() {
            const username = localStorage.getItem('sas_user');
            // Simulation pour le test si pas de login
            // const username = "Ghost"; 
            
            if (!username) { window.location.href = '/login.html'; return; }
            
            try {
                const response = await fetch('/api/read?resource=agents'); 
                const data = await response.json();
                currentAgent = data.agents.find(a => a.name === username);
                
                const display = document.getElementById('current-agent-display');
                if (currentAgent) {
                    display.innerHTML = `[AGENT: <span style="color:#fff">${currentAgent.name.toUpperCase()}</span>]`;
                    display.style.borderColor = 'var(--primary)';
                    display.style.color = 'var(--primary)';
                } else {
                     display.textContent = `[ERREUR IDENTIFICATION]`;
                     display.style.borderColor = 'var(--danger)';
                     display.style.color = 'var(--danger)';
                }
                loadPoints();
                loadDrawings();
            } catch (error) { console.error("Erreur init:", error); }
        }

        async function loadPoints() {
            try {
                const response = await fetch('/api/read?resource=points');
                const data = await response.json();
                pointsLayer.clearLayers();
                data.points.forEach(point => {
                    const y = 8192 - point.map_y;
                    const x = point.map_x;
                    const imp = point.importance_level || 1;
                    const icon = L.divIcon({ className: `custom-marker imp-${imp}`, html: imp, iconSize: [20+(imp*2), 20+(imp*2)], iconAnchor: [10+imp, 10+imp] });
                    
                    // Contenu Popup Stylisé
                    const popupContent = `
                        <div style="min-width: 200px">
                            <h4 style="margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px dashed #555;">
                                INTEL #${point.id}
                            </h4>
                            <p style="margin: 5px 0; font-size: 0.85rem;"><b>SOURCE:</b> <span style="color:var(--primary)">${point.creator_name || 'Inconnu'}</span></p>
                            <div style="background:rgba(0,0,0,0.3); padding: 8px; margin-top: 5px; border-left: 2px solid var(--primary); color: #ccc; font-size: 0.9rem;">
                                ${point.description}
                            </div>
                            <div style="text-align:right; font-size:0.7em; color:var(--dim); margin-top:5px;">
                                ${new Date(point.created_at).toLocaleString()}
                            </div>
                            <button onclick="deletePoint(${point.id})" class="delete-btn">SUPPRIMER MARQUEUR</button>
                        </div>
                    `;

                    L.marker([y, x], {icon: icon}).addTo(pointsLayer).bindPopup(popupContent);
                });
            } catch (e) { console.error("Erreur points:", e); }
        }

        async function loadDrawings() {
            try {
                const response = await fetch('/api/read?resource=drawings');
                const data = await response.json();
                drawnItems.clearLayers();
                data.drawings.forEach(drawing => {
                    let color = '#00ff9d'; // primary
                    const imp = drawing.importance_level || 1;
                    if (imp === 2) color = '#eebb00'; // warning
                    if (imp === 3) color = '#ff9900';
                    if (imp === 4) color = '#ff3333'; // danger

                    const layer = L.geoJSON(drawing.geojson, {
                        style: function (feature) { return { color: color, weight: 3 }; }
                    });
                    layer.eachLayer(function (l) {
                        l.bindPopup(`
                            <div style="min-width: 200px;">
                                <h4 style="margin: 0 0 10px 0; border-bottom: 1px dashed ${color};">
                                    ZONE TACTIQUE #${drawing.id}
                                </h4>
                                <p style="font-size: 0.85rem;"><b>OPÉRATEUR:</b> <span style="color:var(--primary)">${drawing.creator_name || 'Inconnu'}</span></p>
                                <div style="background:rgba(0,0,0,0.3); padding: 8px; margin-top: 5px; border-left: 2px solid ${color}; color: #ccc;">
                                    ${drawing.description || 'Aucune description'}
                                </div>
                                <button onclick="deleteDrawing(${drawing.id})" class="delete-btn">EFFACER ZONE</button>
                            </div>
                        `);
                        drawnItems.addLayer(l);
                    });
                });
            } catch (e) { console.error("Erreur drawings:", e); }
        }

        window.deletePoint = async function(id) {
            if (!confirm("CONFIRMER SUPPRESSION DU POINT ?")) return;
            try {
                const response = await fetch('/api/execute-action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete_point', point_id: id })
                });
                if (response.ok) loadPoints();
            } catch (error) { console.error("Erreur delete point:", error); }
        };

        window.deleteDrawing = async function(id) {
            if (!confirm("CONFIRMER SUPPRESSION DE LA ZONE ?")) return;
            try {
                const response = await fetch('/api/execute-action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete_drawing', drawing_id: id })
                });
                if (response.ok) loadDrawings();
            } catch (error) { console.error("Erreur delete drawing:", error); }
        };

        map.on(L.Draw.Event.CREATED, async function (e) {
            const description = document.getElementById('point-desc').value;
            if (!description || !currentAgent) { alert("ERREUR: Description requise."); drawnItems.removeLayer(e.layer); return; }
            
            const importance_level = document.getElementById('point-importance').value;
            const type = e.layerType;
            const layer = e.layer;
            drawnItems.addLayer(layer);
            const geojson = layer.toGeoJSON();
            
            try {
                await fetch('/api/execute-action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'add_drawing',
                        drawing_creator_id: currentAgent.id,
                        type: type,
                        geojson: geojson,
                        description: description,
                        importance_level: importance_level
                    })
                });
                document.getElementById('point-desc').value = '';
                updateMode();
                loadDrawings();
            } catch (error) { console.error("Erreur sauvegarde dessin:", error); }
        });

        document.getElementById('point-desc').addEventListener('input', updateMode);
        
        let drawControlAdded = false;
        function updateMode() {
            const desc = document.getElementById('point-desc').value;
            const indicator = document.getElementById('add-mode-indicator');
            
            if (desc && currentAgent) {
                indicator.textContent = ">> MODE AJOUT ACTIF : CLIQUEZ OU DESSINEZ SUR LA CARTE <<";
                indicator.classList.add('active');
                if (!drawControlAdded) {
                    map.addControl(drawControl);
                    drawControlAdded = true;
                }
            } else {
                indicator.textContent = "EN ATTENTE... ENTREZ UNE DESCRIPTION POUR DÉVERROUILLER L'INTERFACE.";
                indicator.classList.remove('active');
                if (drawControlAdded) {
                    map.removeControl(drawControl);
                    drawControlAdded = false;
                }
            }
        }

        map.on('click', async function(e) {
            if (drawControl._toolbars.draw._activeMode) return;

            const description = document.getElementById('point-desc').value;
            if (!description || !currentAgent) return;
            const importance_level = document.getElementById('point-importance').value;
            const x = e.latlng.lng;
            const y = 8192 - e.latlng.lat;
            try {
                const response = await fetch('/api/execute-action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'add_point', creator_id: currentAgent.id, map_x: x, map_y: y, description, importance_level })
                });
                if (response.ok) {
                    document.getElementById('point-desc').value = '';
                    updateMode();
                    loadPoints();
                }
            } catch (error) { console.error("Erreur ajout point:", error); }
        });

        init();
        setInterval(loadPoints, 10000);
        setInterval(loadDrawings, 5000);
    </script>
</body>
</html>