<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAS :: TACTICAL MAP</title>

<script> const REQUIRED_LEVEL = 2; </script>
<script src="/js/security.js" onerror="console.log('Security Module Bypass: Local Mode')"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Rajdhani:wght@500;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

<style>
    :root {
        --primary: #00ff9d;
        --secondary: #00f3ff;
        --danger: #ff3333;
        --warning: #eebb00;
        --dim: #445566;
        --bg: #020202;
        --panel: rgba(10, 15, 20, 0.95);
    }

    body {
        background-color: var(--bg); color: #eee; margin: 0; padding: 0;
        height: 100vh; overflow: hidden; font-family: 'Share Tech Mono', monospace;
        user-select: none;
    }

    .terminal-wrapper {
        width: 100vw; height: 100vh; display: flex; flex-direction: column;
        background: #000;
    }

    .header-strip {
        display: flex; justify-content: space-between; align-items: flex-end;
        padding: 15px 20px; background: rgba(0,0,0,0.8); border-bottom: 1px solid var(--dim);
        z-index: 1000;
    }
    .main-title {
        font-size: 2rem; font-family: 'Rajdhani', sans-serif; font-weight: 800; margin: 0;
        text-transform: uppercase; color: #fff;
    }

    #intel-controls {
        position: absolute; 
        top: 100px; right: 20px;
        z-index: 999;
        background: var(--panel); 
        border: 1px solid var(--dim); 
        border-right: 4px solid var(--primary);
        padding: 20px; display: flex; flex-direction: column; gap: 15px; width: 320px;
        backdrop-filter: blur(5px); box-shadow: -10px 10px 40px rgba(0,0,0,0.8);
        text-align: right;
        transition: opacity 0.3s;
    }

    .control-group label {
        color: var(--secondary); font-family: 'Rajdhani'; font-weight: bold; font-size: 0.8rem; letter-spacing: 1px; display: block; margin-bottom: 5px;
    }

    .intel-input, .intel-select {
        background: rgba(0,0,0,0.5); color: #fff; border: 1px solid var(--dim);
        padding: 10px; font-family: 'Share Tech Mono'; width: 100%; box-sizing: border-box;
        text-align: right; font-size: 1rem;
    }
    .intel-input:focus, .intel-select:focus { outline: none; border-color: var(--primary); background: rgba(0, 255, 157, 0.05); }

    #add-mode-indicator {
        margin-top: 10px; font-size: 0.75rem; color: #666; border-top: 1px solid #333; padding-top: 10px;
    }
    #add-mode-indicator.active { color: var(--primary); animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.5; } }

    #map-container { flex-grow: 1; width: 100%; background: #050505; z-index: 1; }

    .custom-marker {
        border-radius: 50%; display: flex; justify-content: center; align-items: center;
        color: #000; font-weight: 800; font-size: 10px; border: 2px solid #fff;
    }
    .imp-1 { background: var(--primary); box-shadow: 0 0 10px var(--primary); }
    .imp-2 { background: var(--warning); box-shadow: 0 0 10px var(--warning); }
    .imp-3 { background: #ff9900; box-shadow: 0 0 10px #ff9900; }
    .imp-4 { background: var(--danger); box-shadow: 0 0 15px var(--danger); animation: pulse 1s infinite; }
    @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(255, 50, 50, 0.7);} 100% {box-shadow: 0 0 0 10px rgba(255, 50, 50, 0);} }

    .leaflet-popup-content-wrapper {
        background: rgba(10, 15, 20, 0.95); border: 1px solid var(--primary);
        border-radius: 0; color: #eee; font-family: 'Share Tech Mono';
    }
    .leaflet-popup-tip { background: var(--primary); }
    .leaflet-popup-content h4 { margin: 0 0 5px 0; font-family: 'Rajdhani'; border-bottom: 1px solid #333; padding-bottom: 5px; }

    .delete-btn {
        background: rgba(255, 50, 50, 0.1); border: 1px solid var(--danger); color: var(--danger);
        padding: 5px; cursor: pointer; margin-top: 8px; font-size: 0.75rem; width: 100%; font-family: 'JetBrains Mono';
        transition: 0.2s;
    }
    .delete-btn:hover { background: var(--danger); color: #000; }

    .status-bar {
        position: absolute; bottom: 0; left: 0; width: 100%;
        background: rgba(0,0,0,0.9); padding: 5px 20px;
        display: flex; justify-content: space-between; font-size: 0.8rem; color: #666;
        z-index: 1000; pointer-events: none;
    }

    .leaflet-top.leaflet-right { display: none; }
</style>
</head>
<body>

<div class="terminal-wrapper">
    <div class="header-strip">
        <div>
            <h1 class="main-title">TACTICAL <span style="color: var(--danger);">MAP</span></h1>
            <div style="color: var(--primary); font-size: 0.8rem; letter-spacing: 2px;">LIVE UPLINK // IMAGE MODE</div>
        </div>
        <div style="text-align: right;">
            <div id="clock" style="font-size: 1.2rem; font-weight: bold;">00:00:00</div>
            <div id="connection-status" style="color: var(--warning); font-size: 0.8rem;">[ INITIALIZING ]</div>
        </div>
    </div>

    <div id="intel-controls">
        <div id="agent-display" style="color:var(--primary); font-weight:bold; border-bottom:1px solid #333; padding-bottom:5px;">
            AGENT: ...
        </div>
        
        <div class="control-group">
            <label>DESCRIPTION INTEL</label>
            <input type="text" id="point-desc" class="intel-input" placeholder="Saisir info..." autocomplete="off">
        </div>
        
        <div class="control-group">
            <label>NIVEAU DE MENACE</label>
            <select id="point-importance" class="intel-select" dir="rtl">
                <option value="1" style="color:var(--primary)">NIV 1 - INFO</option>
                <option value="2" style="color:var(--warning)">NIV 2 - SUSPECT</option>
                <option value="3" style="color:#ff9900">NIV 3 - DANGER</option>
                <option value="4" style="color:var(--danger)">NIV 4 - CRITIQUE</option>
            </select>
        </div>
        
        <div id="add-mode-indicator">
            STANDBY. SAISISSEZ UNE DESCRIPTION.
        </div>
    </div>

    <div id="map-container"></div>

    <div class="status-bar">
        <span>COORDS: <span id="mouse-coords">0, 0</span></span>
        <span>DATABASE: <span style="color:var(--primary)">CONNECTED</span></span>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
    // Gestion de l'identité locale
    if(!localStorage.getItem('sas_user')) {
        localStorage.setItem('sas_user', 'COMMANDER');
    }

    // Bases de données locales (Fallback offline)
    let localPoints = [];
    let localDrawings = [];

    // Mock API pour gérer les modes Connecté/Offline
    const api = {
        async post(data) {
            try {
                // Tentative de connexion à une API réelle (échouera en local)
                const res = await fetch('/api/execute-action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if(res.ok) return await res.json();
                throw new Error("Serveur muet");
            } catch (err) {
                // Fallback : on enregistre dans la mémoire JS temporaire
                if(data.action === 'add_point') {
                    data.id = Date.now();
                    localPoints.push({
                        id: data.id, map_x: data.map_x, map_y: data.map_y, 
                        description: data.description, importance_level: data.importance_level,
                        creator_name: localStorage.getItem('sas_user')
                    });
                }
                if(data.action === 'add_drawing') {
                    data.id = Date.now();
                    localDrawings.push({
                        id: data.id, geojson: data.geojson,
                        description: data.description, importance_level: data.importance_level,
                        creator_name: localStorage.getItem('sas_user')
                    });
                }
                if(data.action === 'delete_point') {
                    localPoints = localPoints.filter(p => p.id !== data.point_id);
                }
                if(data.action === 'delete_drawing') {
                    localDrawings = localDrawings.filter(d => d.id !== data.drawing_id);
                }
                return { success: true };
            }
        },
        async get(resource) {
            try {
                const res = await fetch(`/api/read?resource=${resource}`);
                if(res.ok) return await res.json();
                throw new Error("Offline");
            } catch (e) {
                // Fallback offline
                if(resource === 'points') return { points: localPoints };
                if(resource === 'drawings') return { drawings: localDrawings };
                if(resource === 'agents') return { agents: [{id: 1, name: localStorage.getItem('sas_user')}] };
                return {};
            }
        }
    };

    // --- CONFIGURATION CARTE LEAFLET ---
    const map = L.map('map-container', {
        crs: L.CRS.Simple, // Système de coordonnées simple pour image plate
        minZoom: -1,
        maxZoom: 3,
        zoomControl: false, 
        attributionControl: false,
        maxBoundsViscosity: 1.0 
    });

    L.control.zoom({ position: 'topleft' }).addTo(map);

    // Dimensions de l'image (à adapter selon votre fichier carte.jpg)
    const imageHeight = 5000; 
    const imageWidth = 4000;  
    const bounds = [[0, 0], [imageHeight, imageWidth]];
    const imagePath = 'carte.jpg'; // L'image doit être dans le même dossier

    L.imageOverlay(imagePath, bounds).addTo(map);
    map.fitBounds(bounds);
    map.setMaxBounds(bounds);

    const itemsLayer = L.featureGroup().addTo(map);

    // --- OUTILS DE DESSIN ---
    const drawControl = new L.Control.Draw({
        draw: {
            polyline: { shapeOptions: { color: '#00ff9d' } },
            polygon: { shapeOptions: { color: '#00ff9d' }, showArea: false },
            rectangle: { shapeOptions: { color: '#eebb00' } },
            circle: { shapeOptions: { color: '#ff3333' } },
            marker: false, circlemarker: false
        },
        edit: false, position: 'topleft'
    });

    let drawControlAdded = false;
    const descInput = document.getElementById('point-desc');
    const indic = document.getElementById('add-mode-indicator');

    // Active les outils de dessin seulement si une description est saisie
    function updateInterface() {
        if(descInput.value.trim().length > 0) {
            indic.innerHTML = "<span style='color:var(--primary); font-weight:bold; animation: blink 1s infinite;'>[ SYSTÈMES ARMÉS ]</span><br>CLIQUEZ SUR LA CARTE.";
            descInput.style.borderColor = "var(--primary)";
            if(!drawControlAdded) { map.addControl(drawControl); drawControlAdded = true; }
        } else {
            indic.innerHTML = "STANDBY. SAISISSEZ UNE DESCRIPTION.";
            descInput.style.borderColor = "var(--dim)";
            if(drawControlAdded) { map.removeControl(drawControl); drawControlAdded = false; }
        }
    }
    descInput.addEventListener('input', updateInterface);

    // --- GESTION DES CLICS (Ajout de points) ---
    map.on('click', async (e) => {
        // Si on utilise un outil de dessin (polygone etc), on ignore le clic simple
        if(drawControl._toolbars.draw._activeMode) return;

        const desc = descInput.value;
        if(!desc) { 
            descInput.focus();
            descInput.style.borderColor = "var(--danger)";
            return; 
        }

        await api.post({
            action: 'add_point',
            map_x: e.latlng.lng,
            map_y: e.latlng.lat,
            description: desc,
            importance_level: document.getElementById('point-importance').value
        });

        descInput.value = '';
        updateInterface();
        loadAllData();
    });

    // --- GESTION DES DESSINS (Zones) ---
    map.on(L.Draw.Event.CREATED, async (e) => {
        const desc = descInput.value;
        if(!desc) return;

        await api.post({
            action: 'add_drawing',
            type: e.layerType,
            geojson: e.layer.toGeoJSON(),
            description: desc,
            importance_level: document.getElementById('point-importance').value
        });

        descInput.value = '';
        updateInterface();
        loadAllData();
    });

    // Suppression globale
    window.deleteItem = async (type, id) => {
        if(!confirm("SUPPRIMER ?")) return;
        await api.post({
            action: type === 'point' ? 'delete_point' : 'delete_drawing',
            point_id: type === 'point' ? id : undefined,
            drawing_id: type === 'drawing' ? id : undefined
        });
        loadAllData();
    };

    // --- RENDU VISUEL ---
    function addMarkerToMap(pt) {
        const y = pt.map_y || pt.lat;
        const x = pt.map_x || pt.lng;
        const imp = pt.importance_level || 1;
        
        // Icône CSS pure
        const icon = L.divIcon({ 
            className: `custom-marker imp-${imp}`, html: imp, 
            iconSize: [20+(imp*4), 20+(imp*4)], iconAnchor: [10+(imp*2), 10+(imp*2)] 
        });
        
        const m = L.marker([y, x], {icon: icon});
        
        let color = 'var(--primary)';
        if(imp > 2) color = 'var(--danger)';
        
        m.bindPopup(`
            <div style="min-width:180px">
                <h4 style="color:${color}; margin:0; border-bottom:1px solid #333">INTEL #${pt.id}</h4>
                <div style="font-size:0.75rem; color:#888;">OP: ${pt.creator_name}</div>
                <p style="margin:10px 0; font-size:0.9rem;">${pt.description}</p>
                <button class="delete-btn" onclick="deleteItem('point', ${pt.id})">SUPPRIMER</button>
            </div>
        `);
        itemsLayer.addLayer(m);
    }

    function addDrawingToMap(dw) {
        const imp = dw.importance_level || 1;
        let color = '#00ff9d';
        if(imp == 2) color = '#eebb00';
        if(imp == 3) color = '#ff9900';
        if(imp == 4) color = '#ff3333';

        const l = L.geoJSON(dw.geojson, { style: { color: color, weight: 2, fillOpacity: 0.2 } });
        
        l.bindPopup(`
            <div style="min-width:180px">
                <h4 style="color:${color}; margin:0; border-bottom:1px solid #333">ZONE #${dw.id}</h4>
                <div style="font-size:0.75rem; color:#888;">OP: ${dw.creator_name}</div>
                <p style="margin:10px 0; font-size:0.9rem;">${dw.description}</p>
                <button class="delete-btn" onclick="deleteItem('drawing', ${dw.id})">EFFACER</button>
            </div>
        `);
        itemsLayer.addLayer(l);
    }

    async function loadAllData() {
        itemsLayer.clearLayers();
        const ptData = await api.get('points');
        const dwData = await api.get('drawings');
        
        if(ptData && ptData.points) ptData.points.forEach(p => addMarkerToMap(p));
        if(dwData && dwData.drawings) dwData.drawings.forEach(d => addDrawingToMap(d));
    }

    async function initSystem() {
        document.getElementById('connection-status').innerText = "[ INITIALIZED ]";
        document.getElementById('agent-display').innerText = "AGENT: " + localStorage.getItem('sas_user');
        loadAllData();
    }

    initSystem();

    // UI Updates
    map.on('mousemove', (e) => {
        document.getElementById('mouse-coords').innerText = `X:${Math.round(e.latlng.lng)} Y:${Math.round(e.latlng.lat)}`;
    });
    setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);
    
    // Auto refresh des données
    setInterval(loadAllData, 5000);

</script>
</body>
</html>