<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - Salle des Preuves</title>
    <script> const REQUIRED_LEVEL = 2; </script>
    <script src="/js/security.js"></script>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/style-evidence.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
</head>
<body>
    <main class="terminal">
        <h1>SALLE DES PREUVES<span class="blinker">_</span></h1>
        <p class="status">ACCES: <span class="restricted" id="agent-name-display"></span> :: NIVEAU 2</p>

        <div id="evidence-controls">
            <h3 class="category-title" style="margin-top: 0;">//: ENREGISTRER NOUVELLE PREUVE</h3>
            <form id="upload-form" class="form-grid">
                <div class="form-group">
                    <label>DOSSIER D'ENQUÊTE</label>
                    <input type="text" name="dossier" class="form-input" required placeholder="Ex: Affaire Cartel, Enquête Docks...">
                </div>
                <div class="form-group">
                    <label>TAGS (séparés par virgule)</label>
                    <input type="text" name="tags" class="form-input" placeholder="Ex: #Arme, #Lieu, #Plaque">
                </div>
                <div class="form-group full-width">
                    <label>FICHIER IMAGE (SCREENSHOT)</label>
                    <input type="file" name="file" class="form-input" required accept="image/png, image/jpeg">
                </div>
                <button type="submit" class="form-button full-width" id="submit-btn">&gt;&gt; SCELLER LA PREUVE</button>
                <p id="form-message" class="form-message full-width"></p>
            </form>
        </div>

        <div class="report-content" style="background: transparent; border: none; padding: 0;">
            <div id="evidence-grid">
                <p style="color: #00ff00;">[CHARGEMENT DES DONNÉES...]</p>
            </div>
        </div>

        <footer class="portal-footer">
            <a href="/index.html" class="back-link">&lt;&lt; RETURN_TO_MAINFRAME</a>
        </footer>
    </main>

    <div id="lightbox-overlay" onclick="closeLightbox()">
        <img src="" id="lightbox-image" alt="Preuve en gros plan">
    </div>

    <script>
        const agentName = localStorage.getItem('sas_user') || 'UNKNOWN';
        document.getElementById('agent-name-display').textContent = agentName;
        const grid = document.getElementById('evidence-grid');
        const form = document.getElementById('upload-form');
        const msg = document.getElementById('form-message');
        const submitBtn = document.getElementById('submit-btn');

        const lightbox = document.getElementById('lightbox-overlay');
        const lightboxImg = document.getElementById('lightbox-image');

        function openLightbox(url) {
            lightboxImg.src = url;
            lightbox.classList.add('active');
        }
        function closeLightbox() {
            lightbox.classList.remove('active');
        }

        async function loadEvidence() {
            try {
                const res = await fetch('/api/read?resource=evidence');
                const data = await res.json();
                grid.innerHTML = '';

                if (data.evidence.length === 0) {
                    grid.innerHTML = '<p style="color: #888;">[AUCUNE PREUVE ENREGISTRÉE]</p>';
                    return;
                }

                data.evidence.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'evidence-card';
                    card.id = `evidence-${item.id}`;
                    
                    const tagsHtml = (item.tags || '')
                        .split(',')
                        .filter(tag => tag.trim() !== '')
                        .map(tag => `<span class="evidence-tag">${tag.trim()}</span>`)
                        .join('');

                    card.innerHTML = `
                        <img src="${item.image_url}" alt="Preuve" class="evidence-image" onclick="openLightbox('${item.image_url}')">
                        <div class="evidence-meta">
                            <div class="evidence-dossier">${item.dossier.toUpperCase()}</div>
                            <div class="evidence-tags">${tagsHtml || '<span style="color: #555; font-size: 0.8rem;">Aucun tag</span>'}</div>
                            <div class="evidence-chain">
                                Déposé par: ${item.agent_name}<br>
                                Le: ${new Date(item.created_at).toLocaleString()}
                            </div>
                        </div>
                        <button class="delete-evidence" onclick="deleteEvidence(${item.id})">X</button>
                    `;
                    grid.appendChild(card);
                });
            } catch (err) {
                grid.innerHTML = '<p style="color: #ff4141;">[ERREUR DE CONNEXION AU SERVEUR]</p>';
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            msg.textContent = 'Envoi en cours...';
            msg.className = 'form-message';
            submitBtn.disabled = true;

            const formData = new FormData(form);
            formData.append('agent_name', agentName);

            try {
                const res = await fetch('/api/upload-evidence', {
                    method: 'POST',
                    body: formData
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Erreur inconnue');
                }

                msg.textContent = 'Preuve enregistrée !';
                msg.className = 'form-message success';
                form.reset();
                loadEvidence();

            } catch (err) {
                msg.textContent = `Erreur: ${err.message}`;
                msg.className = 'form-message error';
            } finally {
                submitBtn.disabled = false;
            }
        });

        async function deleteEvidence(id) {
            if (!confirm("Voulez-vous vraiment détruire cette preuve ?")) return;
            
            try {
                await fetch('/api/execute-action', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'delete_evidence', id })
                });
                document.getElementById(`evidence-${id}`).remove();
            } catch (err) {
                alert('Erreur lors de la suppression.');
            }
        }

        loadEvidence();
    </script>
</body>
</html>