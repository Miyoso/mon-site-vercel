<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS :: INVESTIGATION WALL</title>
    
    <script> const REQUIRED_LEVEL = 2; </script>
    <script>if(typeof checkSecurity === 'undefined') { window.checkSecurity = function() { console.log("Sec Check Bypass"); } }</script>
    <script src="/js/security.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Rajdhani:wght@500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style-mo.css">

    <style>
        /* --- CONFIGURATION GLOBALE --- */
        body {
            margin: 0; padding: 0;
            background-color: #050505;
            width: 100vw; height: 100vh;
            overflow: hidden; /* Le pan/zoom gère le mouvement */
            cursor: crosshair;
        }

        /* Grille de fond tactique */
        #grid-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none; z-index: -1;
        }

        /* --- COUCHE MONDE (PAN & ZOOM) --- */
        #world-layer {
            position: absolute; top: 0; left: 0;
            transform-origin: 0 0;
            width: 100%; height: 100%;
        }

        /* --- ITEMS (DOSSIERS / NOTES) --- */
        .board-item {
            position: absolute;
            background: rgba(10, 15, 20, 0.9);
            border: 1px solid var(--dim);
            padding: 15px;
            width: 220px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            transition: box-shadow 0.2s, transform 0.1s;
            user-select: none;
            /* Clip path pour le style tech */
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
        }

        .board-item:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.2);
            z-index: 100 !important;
        }

        /* Types d'items */
        .item-suspect { border-top: 3px solid var(--danger); }
        .item-suspect img { width: 100%; height: 150px; object-fit: cover; border: 1px solid #333; margin-bottom: 10px; filter: grayscale(0.5); }
        .item-note { border-top: 3px solid var(--warning); background: rgba(255, 200, 0, 0.05); }

        .item-content { font-family: 'Share Tech Mono'; color: #eee; font-size: 0.9rem; line-height: 1.4; word-wrap: break-word; }
        
        /* Header Item */
        .item-header {
            font-family: 'Rajdhani'; font-weight: bold; font-size: 0.8rem; color: var(--dim);
            margin-bottom: 5px; display: flex; justify-content: space-between;
        }

        /* --- LIENS SVG --- */
        #connections-layer path {
            stroke-width: 2;
            fill: none;
            pointer-events: stroke;
            transition: stroke-width 0.2s;
        }
        #connections-layer path:hover { stroke-width: 4; filter: drop-shadow(0 0 5px currentColor); }
        .link-red { stroke: var(--danger); }
        .link-green { stroke: var(--primary); }
        .link-blue { stroke: var(--secondary); }

        /* --- UI HUD (INTERFACE) --- */
        .hud-overlay {
            position: fixed; pointer-events: none; width: 100%; height: 100%; z-index: 500;
        }

        /* Indicateur Aide */
        .help-indicator {
            position: absolute; bottom: 20px; left: 20px;
            font-family: 'Share Tech Mono'; font-size: 0.8rem; color: var(--dim);
            background: rgba(0,0,0,0.7); padding: 5px 10px; border: 1px solid #333;
        }

        /* Barre d'outils Flottante */
        .toolbar {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; pointer-events: auto;
            background: rgba(10, 15, 20, 0.9); border: 1px solid var(--dim);
            padding: 10px; border-radius: 4px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .tool-btn {
            background: transparent; border: 1px solid var(--dim); color: var(--dim);
            padding: 8px 15px; font-family: 'JetBrains Mono'; font-size: 0.8rem;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: #fff; }
        .tool-btn.active { border-color: var(--primary); color: var(--primary); }

        .separator { width: 1px; background: var(--dim); margin: 0 5px; }

        /* Menu Contextuel */
        #context-menu {
            position: fixed; background: rgba(15, 20, 25, 0.95); border: 1px solid var(--primary);
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.1); z-index: 1000;
            display: none; flex-direction: column; min-width: 180px; backdrop-filter: blur(5px);
        }
        .ctx-item {
            padding: 10px 15px; color: #ccc; cursor: pointer; font-family: 'Share Tech Mono'; font-size: 0.9rem;
            border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.2s;
        }
        .ctx-item:hover { background: var(--primary); color: #000; }
        .ctx-item.delete:hover { background: var(--danger); color: #fff; }

        /* --- MODAL D'ÉDITION --- */
        .edit-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 2000;
            pointer-events: auto;
        }
        .edit-modal {
            background: #0b1015; border: 1px solid var(--primary); padding: 30px; width: 450px;
            box-shadow: 0 0 50px rgba(0, 255, 157, 0.1); position: relative;
        }
        .edit-modal::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: var(--primary);
        }
        
        .edit-input {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--dim);
            color: #fff; padding: 10px; margin-bottom: 15px; font-family: 'Share Tech Mono';
        }
        .edit-input:focus { outline: none; border-color: var(--primary); }

    </style>
</head>
<body>

    <div id="grid-bg"></div>

    <div class="hud-overlay">
        <div class="toolbar">
            <button class="tool-btn" onclick="window.location.href='/index.html'">[ RETOUR ]</button>
            <div class="separator"></div>
            <button class="tool-btn" onclick="openEditModal('new', 'suspect')">
                <span style="color:var(--danger)">+</span> SUSPECT
            </button>
            <button class="tool-btn" onclick="openEditModal('new', 'note')">
                <span style="color:var(--warning)">+</span> NOTE
            </button>
            <div class="separator"></div>
            <button class="tool-btn" onclick="resetView()">RECADRER VUE</button>
        </div>

        <div class="help-indicator">
            [ CLIC GAUCHE : DÉPLACER | CLIC DROIT : ACTIONS | MOLETTE : ZOOM ]
        </div>
    </div>

    <div id="world-layer">
        <svg id="connections-layer" style="overflow: visible; position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></svg>
        <div id="items-layer"></div>
    </div>

    <div id="context-menu">
        <div class="ctx-item" onclick="contextAction('edit')">ÉDITER</div>
        <div class="ctx-item" onclick="contextAction('link')">LIER À...</div>
        <div class="ctx-item" onclick="contextAction('color')">CHANGER COULEUR</div>
        <div class="ctx-item delete" onclick="contextAction('delete')">SUPPRIMER</div>
    </div>

    <div class="edit-modal-overlay" id="editModal">
        <div class="edit-modal">
            <h3 style="color:var(--primary); font-family:'Rajdhani'; font-size:1.5rem; margin-top:0;">//: DOSSIER</h3>
            <input type="hidden" id="modal-mode">
            <input type="hidden" id="modal-type">
            <input type="hidden" id="modal-id">
            
            <label style="color:var(--secondary); font-family:'JetBrains Mono'; font-size:0.8rem;">CONTENU / NOM</label>
            <textarea id="modal-label" class="edit-input" rows="4"></textarea>
            
            <div id="modal-image-group">
                <label style="color:var(--secondary); font-family:'JetBrains Mono'; font-size:0.8rem;">URL PHOTO (SUSPECT)</label>
                <input type="text" id="modal-image" class="edit-input" placeholder="/assets/...">
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                <button class="tool-btn" onclick="document.getElementById('editModal').style.display='none'">ANNULER</button>
                <button class="tool-btn active" onclick="saveModalData()" style="border-color:var(--primary); color:var(--primary);">SAUVEGARDER</button>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABLES ---
        let items = [];
        let links = [];
        let viewState = { x: 0, y: 0, scale: 1 };
        let isPanning = false;
        let startPanX, startPanY;
        
        let dragItem = null;
        let dragOffsetX, dragOffsetY;
        let isDragging = false;

        let contextTargetId = null;
        let linkingFromId = null;

        // DOM
        const worldLayer = document.getElementById('world-layer');
        const itemsLayer = document.getElementById('items-layer');
        const svgLayer = document.getElementById('connections-layer');
        const ctxMenu = document.getElementById('context-menu');
        const editModal = document.getElementById('editModal');

        // --- CORE FUNCTIONS ---
        async function loadBoard() {
            try {
                const res = await fetch('/api/read?resource=investigation');
                const data = await res.json();
                items = data.items || [];
                links = data.links || [];
                renderBoard();
            } catch (error) { console.error("Erreur chargement:", error); }
        }

        function renderBoard() {
            itemsLayer.innerHTML = '';
            svgLayer.innerHTML = '';

            // ITEMS
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = `board-item item-${item.type}`;
                el.style.left = item.x + 'px';
                el.style.top = item.y + 'px';
                el.id = `item-${item.id}`;
                el.dataset.id = item.id;

                // Style Note Couleur
                if (item.type === 'note' && item.color) {
                    el.style.borderTopColor = item.color;
                }

                // HTML Interne
                let contentHtml = '';
                if (item.type === 'suspect') {
                    const img = item.image_url || '/assets/unknown.jpg';
                    contentHtml = `<img src="${img}" draggable="false">`;
                }
                contentHtml += `<div class="item-header"><span>ID: ${item.id}</span><span>${item.type.toUpperCase()}</span></div>`;
                contentHtml += `<div class="item-content">${item.label}</div>`;
                
                el.innerHTML = contentHtml;

                // Events
                el.onmousedown = (e) => { if(e.button === 0) startItemDrag(e, item); };
                el.oncontextmenu = (e) => openContextMenu(e, item.id);

                itemsLayer.appendChild(el);
            });

            // LIENS
            links.forEach(link => {
                const from = items.find(i => i.id === link.from_id);
                const to = items.find(i => i.id === link.to_id);
                if (from && to) drawLink(from, to, link.type, link.id);
            });
        }

        function drawLink(item1, item2, type, id) {
            // Calcul du centre des boites
            const x1 = item1.x + 110; // 220px / 2
            const y1 = item1.y + 50;
            const x2 = item2.x + 110;
            const y2 = item2.y + 50;

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            // Courbe de Bézier quadratique
            const cx = (x1 + x2) / 2;
            const cy = Math.min(y1, y2) - 50; // Courbure vers le haut
            
            const d = `M ${x1} ${y1} Q ${cx} ${cy} ${x2} ${y2}`;
            path.setAttribute("d", d);
            path.setAttribute("class", `link-${type}`);
            
            // Suppression double-clic
            path.ondblclick = async () => {
                if(confirm("Couper ce lien ?")) {
                    await apiCall({ action: 'del_inv_link', id });
                    loadBoard();
                }
            };

            svgLayer.appendChild(path);
        }

        // --- NAVIGATION ---
        document.addEventListener('mousedown', (e) => {
            // Si clic sur interface, on ignore le pan
            if(e.target.closest('.board-item') || e.target.closest('.toolbar') || e.target.closest('.edit-modal-overlay') || e.target.closest('#context-menu')) return;
            
            ctxMenu.style.display = 'none';
            
            if(e.button === 0) {
                isPanning = true;
                startPanX = e.clientX - viewState.x;
                startPanY = e.clientY - viewState.y;
                document.body.style.cursor = 'grabbing';
            }
        });

        document.addEventListener('mousemove', (e) => {
            if(isPanning) {
                e.preventDefault();
                viewState.x = e.clientX - startPanX;
                viewState.y = e.clientY - startPanY;
                updateTransform();
            } else if(isDragging && dragItem) {
                handleItemDrag(e);
            }
        });

        document.addEventListener('mouseup', async () => {
            if(isPanning) {
                isPanning = false;
                document.body.style.cursor = 'crosshair';
            }
            if(isDragging) {
                await stopItemDrag();
            }
        });

        document.addEventListener('wheel', (e) => {
            if (e.target.closest('.board-item')) return;
            e.preventDefault();
            const zoomSpeed = 0.1;
            const newScale = viewState.scale + (e.deltaY > 0 ? -zoomSpeed : zoomSpeed);
            viewState.scale = Math.min(Math.max(0.4, newScale), 2.5);
            updateTransform();
        }, { passive: false });

        function updateTransform() {
            worldLayer.style.transform = `translate(${viewState.x}px, ${viewState.y}px) scale(${viewState.scale})`;
        }

        function resetView() {
            viewState = { x: 0, y: 0, scale: 1 };
            updateTransform();
        }

        // --- DRAG ITEMS ---
        function startItemDrag(e, item) {
            e.stopPropagation();
            ctxMenu.style.display = 'none';
            isDragging = true;
            dragItem = item;
            
            dragOffsetX = (e.clientX - viewState.x) / viewState.scale - item.x;
            dragOffsetY = (e.clientY - viewState.y) / viewState.scale - item.y;
            
            document.getElementById(`item-${item.id}`).style.zIndex = 1000;
        }

        function handleItemDrag(e) {
            if(!dragItem) return;
            const mouseWorldX = (e.clientX - viewState.x) / viewState.scale;
            const mouseWorldY = (e.clientY - viewState.y) / viewState.scale;

            dragItem.x = mouseWorldX - dragOffsetX;
            dragItem.y = mouseWorldY - dragOffsetY;

            const el = document.getElementById(`item-${dragItem.id}`);
            el.style.left = dragItem.x + 'px';
            el.style.top = dragItem.y + 'px';
            
            // On rafraichit les liens en temps réel (optionnel, peut être lourd)
            // renderBoard(); 
        }

        async function stopItemDrag() {
            if(dragItem) {
                document.getElementById(`item-${dragItem.id}`).style.zIndex = "";
                await apiCall({ action: 'move_inv_item', id: dragItem.id, x: parseInt(dragItem.x), y: parseInt(dragItem.y) });
                renderBoard(); 
            }
            isDragging = false; dragItem = null;
        }

        // --- CONTEXT MENU ---
        function openContextMenu(e, id) {
            e.preventDefault(); e.stopPropagation();
            contextTargetId = parseInt(id);
            ctxMenu.style.display = 'flex';
            ctxMenu.style.left = e.clientX + 'px';
            ctxMenu.style.top = e.clientY + 'px';
        }

        async function contextAction(action) {
            ctxMenu.style.display = 'none';
            if(!contextTargetId) return;
            const item = items.find(i => i.id === contextTargetId);

            if (action === 'delete') {
                if(confirm("Supprimer ce dossier ?")) {
                    await apiCall({ action: 'del_inv_item', id: contextTargetId });
                    loadBoard();
                }
            } else if (action === 'edit') {
                openEditModal('edit', item.type, item);
            } else if (action === 'link') {
                if (linkingFromId === null) {
                    linkingFromId = contextTargetId;
                    const el = document.getElementById(`item-${contextTargetId}`);
                    el.style.boxShadow = "0 0 30px var(--primary)";
                    alert("Source sélectionnée. Clic-Droit sur la Cible > 'LIER À...'");
                } else {
                    if(linkingFromId === contextTargetId) return alert("Liaison impossible sur le même item.");
                    const type = prompt("Type de lien ? (red, green, blue)", "red");
                    await apiCall({ action: 'add_inv_link', from_id: linkingFromId, to_id: contextTargetId, type: type || 'red' });
                    linkingFromId = null;
                    loadBoard();
                }
            } else if (action === 'color') {
                const colors = ['#ff3333', '#00ff9d', '#00f3ff', '#eebb00', '#ffffff'];
                const newColor = colors[Math.floor(Math.random() * colors.length)];
                await apiCall({ action: 'update_inv_item_text', id: contextTargetId, label: item.label, color: newColor });
                loadBoard();
            }
        }

        // --- MODAL ---
        function openEditModal(mode, type, itemData = null) {
            editModal.style.display = 'flex';
            document.getElementById('modal-mode').value = mode;
            document.getElementById('modal-type').value = type;
            
            document.getElementById('modal-image-group').style.display = (type === 'note') ? 'none' : 'block';

            if (mode === 'edit' && itemData) {
                document.getElementById('modal-id').value = itemData.id;
                document.getElementById('modal-label').value = itemData.label;
                document.getElementById('modal-image').value = itemData.image_url || '';
            } else {
                document.getElementById('modal-label').value = '';
                document.getElementById('modal-image').value = '';
            }
        }

        async function saveModalData() {
            const mode = document.getElementById('modal-mode').value;
            const type = document.getElementById('modal-type').value;
            const label = document.getElementById('modal-label').value;
            const image_url = document.getElementById('modal-image').value;
            const id = document.getElementById('modal-id').value;

            if (!label) return alert("Contenu requis.");
            editModal.style.display = 'none';

            if (mode === 'new') {
                // Centre de l'écran
                const x = (window.innerWidth/2 - viewState.x) / viewState.scale - 110;
                const y = (window.innerHeight/2 - viewState.y) / viewState.scale - 100;
                await apiCall({ action: 'add_inv_item', type, label, image_url, x: parseInt(x), y: parseInt(y), color: '#eebb00' });
            } else {
                await apiCall({ action: 'update_inv_item_text', id: parseInt(id), label, image_url });
            }
            loadBoard();
        }

        async function apiCall(data) {
            const res = await fetch('/api/execute-action', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
            });
            return await res.json();
        }

        // Start
        loadBoard();
        document.addEventListener('click', (e) => { if (!e.target.closest('#context-menu')) ctxMenu.style.display = 'none'; });

    </script>
</body>
</html>