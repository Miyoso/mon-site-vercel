<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS :: INVESTIGATION WALL v2.4</title>
    
    <script> const REQUIRED_LEVEL = 2; </script>
    <script>if(typeof checkSecurity === 'undefined') { window.checkSecurity = function() { console.log("Sec Check Bypass"); } }</script>
    <script src="/js/security.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Rajdhani:wght@500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        /* --- CONFIGURATION GLOBALE --- */
        :root {
            --primary: #00ff9d;
            --secondary: #00f3ff;
            --danger: #ff3333;
            --warning: #eebb00;
            --purple: #b026ff;
            --white: #eeeeee;
            --dim: #445566;
            --bg: #050505;
            --panel: #0a0f14;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            width: 100vw; height: 100vh;
            overflow: hidden;
            cursor: crosshair;
            font-family: 'Share Tech Mono', monospace;
            color: #eee;
            user-select: none;
        }

        #grid-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none; z-index: -1;
        }

        #world-layer {
            position: absolute; top: 0; left: 0;
            transform-origin: 0 0;
            width: 100%; height: 100%;
            will-change: transform;
        }

        /* --- ITEMS --- */
        .board-item {
            position: absolute;
            background: var(--panel);
            border: 1px solid var(--dim);
            padding: 10px;
            width: 220px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: box-shadow 0.2s, border-color 0.2s; 
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
            border-top: 4px solid var(--dim);
        }

        .board-item:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.1);
            z-index: 100;
        }

        .item-header {
            font-family: 'Rajdhani'; font-weight: bold; font-size: 0.75rem; color: var(--dim);
            margin-bottom: 5px; display: flex; justify-content: space-between; text-transform: uppercase;
        }
        .item-suspect img { width: 100%; height: 140px; object-fit: cover; border: 1px solid #333; margin-bottom: 8px; filter: sepia(0.2) contrast(1.1); pointer-events: none; }
        .item-content { font-size: 0.85rem; line-height: 1.3; white-space: pre-wrap; pointer-events: none; }

        /* --- LIENS SVG --- */
        #connections-layer { overflow: visible; position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
        #connections-layer path {
            stroke-width: 3; fill: none; transition: stroke-width 0.2s, stroke 0.2s; 
            pointer-events: visibleStroke; cursor: pointer; opacity: 0.8;
        }
        #connections-layer path:hover { stroke-width: 6; filter: drop-shadow(0 0 5px currentColor); opacity: 1; }
        
        /* Couleurs des liens */
        .link-red { stroke: var(--danger); }
        .link-green { stroke: var(--primary); }
        .link-blue { stroke: var(--secondary); }
        .link-warning { stroke: var(--warning); }
        .link-purple { stroke: var(--purple); }
        .link-white { stroke: var(--white); }
        
        .link-temp { stroke: #fff; stroke-dasharray: 5,5; opacity: 0.5; stroke-width: 2 !important; }

        /* --- UI / HUD --- */
        .hud-overlay { position: fixed; pointer-events: none; width: 100%; height: 100%; z-index: 500; }
        .toolbar {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; pointer-events: auto;
            background: var(--panel); border: 1px solid var(--dim); padding: 8px; border-radius: 4px;
        }
        .tool-btn {
            background: rgba(255,255,255,0.03); border: 1px solid transparent; color: #aaa;
            padding: 6px 12px; font-family: 'JetBrains Mono'; font-size: 0.75rem; cursor: pointer;
            display: flex; align-items: center; gap: 6px;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: #555; }
        .help-indicator {
            position: absolute; bottom: 20px; left: 20px; font-size: 0.75rem; color: #888;
            background: rgba(0,0,0,0.8); padding: 5px 10px; border-left: 2px solid var(--primary);
        }

        /* --- CONTEXT MENU & MODAL --- */
        #context-menu {
            position: fixed; background: #0f1419; border: 1px solid var(--dim);
            z-index: 2000; display: none; flex-direction: column; min-width: 180px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .ctx-palette {
            display: flex; gap: 8px; padding: 12px 10px; border-bottom: 1px solid #222; justify-content: center; background: rgba(0,0,0,0.3);
        }
        .color-swatch {
            width: 18px; height: 18px; border-radius: 50%; cursor: pointer; border: 1px solid #444; transition: transform 0.2s;
        }
        .color-swatch:hover { transform: scale(1.3); border-color: #fff; }
        .ctx-item { padding: 12px 15px; cursor: pointer; font-size: 0.8rem; color: #ccc; border-bottom: 1px solid #222; }
        .ctx-item:hover { background: var(--primary); color: #000; }
        .ctx-item.delete:hover { background: var(--danger); color: #fff; }

        .edit-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 3000; pointer-events: auto;
        }
        .edit-modal {
            background: #0b1015; border: 1px solid var(--dim); border-top: 4px solid var(--primary);
            padding: 30px; width: 400px;
        }
        .edit-input {
            width: 100%; background: #151a20; border: 1px solid #333; color: #fff; padding: 10px; margin-bottom: 15px;
            font-family: inherit; box-sizing: border-box;
        }
    </style>
</head>
<body>

    <div id="grid-bg"></div>

    <div class="hud-overlay">
        <div class="toolbar">
            <button class="tool-btn" onclick="window.location.reload()">[ RECHARGER ]</button>
            <span style="width:1px; background:#333; margin:0 5px;"></span>
            <button class="tool-btn" onclick="openEditModal('new', 'suspect')"><span style="color:var(--danger)">■</span> SUSPECT</button>
            <button class="tool-btn" onclick="openEditModal('new', 'note')"><span style="color:var(--warning)">■</span> NOTE</button>
            <span style="width:1px; background:#333; margin:0 5px;"></span>
            <button class="tool-btn" onclick="resetView()">RESET VUE</button>
        </div>
        <div class="help-indicator">
            [ CLIC GAUCHE: BOUGER | CLIC DROIT: COULEUR (ITEM/LIEN) | SHIFT+GLISSER: LIER ]
        </div>
    </div>

    <div id="world-layer">
        <svg id="connections-layer"></svg>
        <div id="items-layer"></div>
    </div>

    <div id="context-menu">
        <div class="ctx-palette">
            <div class="color-swatch" style="background:var(--danger)" onclick="applyColor('#ff3333')"></div>
            <div class="color-swatch" style="background:var(--warning)" onclick="applyColor('#eebb00')"></div>
            <div class="color-swatch" style="background:var(--primary)" onclick="applyColor('#00ff9d')"></div>
            <div class="color-swatch" style="background:var(--secondary)" onclick="applyColor('#00f3ff')"></div>
            <div class="color-swatch" style="background:var(--purple)" onclick="applyColor('#b026ff')"></div>
            <div class="color-swatch" style="background:var(--white)" onclick="applyColor('#eeeeee')"></div>
        </div>
        <div class="ctx-item" onclick="contextAction('edit')">ÉDITER</div>
        <div class="ctx-item delete" onclick="contextAction('delete')">SUPPRIMER</div>
    </div>

    <div class="edit-modal-overlay" id="editModal">
        <div class="edit-modal">
            <h3 style="margin-top:0; color:var(--primary)">//: DONNÉES</h3>
            <input type="hidden" id="modal-mode">
            <input type="hidden" id="modal-type">
            <input type="hidden" id="modal-id">
            
            <label style="font-size:0.7rem; color:#666;">CONTENU</label>
            <textarea id="modal-label" class="edit-input" rows="3"></textarea>
            
            <div id="modal-image-group">
                <label style="font-size:0.7rem; color:#666;">IMAGE URL</label>
                <input type="text" id="modal-image" class="edit-input" placeholder="/assets/...">
            </div>

            <div style="text-align: right;">
                <button class="tool-btn" onclick="closeModal()" style="display:inline-block">ANNULER</button>
                <button class="tool-btn" onclick="saveModalData()" style="display:inline-block; border-color:var(--primary); color:var(--primary)">SAUVEGARDER</button>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABLES ---
        let items = [];
        let links = [];
        let view = { x: 0, y: 0, scale: 1 };
        
        let isPanning = false;
        let isDragging = false;
        let isLinking = false;
        
        let lastMouse = { x: 0, y: 0 };
        let dragItem = null;
        let dragOffset = { x: 0, y: 0 };
        let linkStartItem = null;
        let tempLinkPath = null;
        
        // Context Logic
        let contextTargetId = null;
        let contextTargetType = 'item'; // 'item' ou 'link'

        const world = document.getElementById('world-layer');
        const itemsLayer = document.getElementById('items-layer');
        const svgLayer = document.getElementById('connections-layer');
        const ctxMenu = document.getElementById('context-menu');
        const editModal = document.getElementById('editModal');

        // --- API ---
        const API = {
            async read() {
                try {
                    const res = await fetch('/api/read?resource=investigation');
                    return await res.json();
                } catch(e) { console.error("API Read Error", e); return {items:[], links:[]}; }
            },
            async exec(cmd) {
                try {
                    const res = await fetch('/api/execute-action', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(cmd)
                    });
                    return await res.json();
                } catch(e) { console.error("API Exec Error", e); }
            }
        };

        // --- INIT ---
        async function init() {
            const data = await API.read();
            items = data.items || [];
            links = data.links || [];
            renderBoard();
            if(view.scale === 1 && view.x === 0) centerView();
        }

        // --- RENDER ---
        function renderBoard() {
            itemsLayer.innerHTML = '';
            svgLayer.innerHTML = '';
            
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = `board-item item-${item.type}`;
                el.id = `item-${item.id}`;
                el.dataset.id = item.id;
                el.style.left = item.x + 'px';
                el.style.top = item.y + 'px';
                if(item.color) el.style.borderTopColor = item.color;

                let html = `<div class="item-header"><span>#${item.id}</span><span>${item.type}</span></div>`;
                if(item.type === 'suspect') html += `<img src="${item.image_url || ''}" draggable="false">`;
                html += `<div class="item-content">${item.label}</div>`;
                el.innerHTML = html;

                el.onmousedown = (e) => onMouseDownItem(e, item);
                el.ondblclick = (e) => { e.stopPropagation(); openEditModal('edit', item.type, item); };
                el.oncontextmenu = (e) => openContextMenu(e, item.id, 'item');

                itemsLayer.appendChild(el);
            });

            links.forEach(link => {
                const from = items.find(i => i.id === link.from_id);
                const to = items.find(i => i.id === link.to_id);
                if(from && to) drawLink(link, from, to);
            });
        }

        function drawLink(link, item1, item2) {
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("class", `link-${link.type || 'red'}`); // Défaut rouge
            path.dataset.id = link.id;
            path.setAttribute("d", getPathD(item1, item2));
            
            // Double clic = supprimer
            path.ondblclick = async (e) => {
                e.stopPropagation();
                if(confirm("Couper ce lien ?")) {
                    await API.exec({ action: 'del_inv_link', id: link.id });
                    init();
                }
            };
            
            // Clic droit = menu couleur
            path.oncontextmenu = (e) => openContextMenu(e, link.id, 'link');

            svgLayer.appendChild(path);
        }

        function getPathD(i1, i2) {
            const x1 = i1.x + 110; const y1 = i1.y + 60;
            const x2 = i2.x + 110; const y2 = i2.y + 60;
            const cx = (x1 + x2) / 2;
            const cy = Math.min(y1, y2) - 50;
            return `M ${x1} ${y1} Q ${cx} ${cy} ${x2} ${y2}`;
        }

        // --- INPUTS ---
        document.addEventListener('mousedown', (e) => {
            if(!e.target.closest('.board-item') && !e.target.closest('.toolbar') && !e.target.closest('.edit-modal') && !e.target.closest('#context-menu')) {
                isPanning = true;
                lastMouse = { x: e.clientX, y: e.clientY };
                document.body.style.cursor = 'grabbing';
                ctxMenu.style.display = 'none';
            }
        });

        document.addEventListener('mousemove', (e) => {
            if(isPanning) {
                view.x += e.clientX - lastMouse.x;
                view.y += e.clientY - lastMouse.y;
                lastMouse = { x: e.clientX, y: e.clientY };
                updateView();
            } else if(isDragging && dragItem) {
                const worldX = (e.clientX - view.x) / view.scale;
                const worldY = (e.clientY - view.y) / view.scale;
                dragItem.x = worldX - dragOffset.x;
                dragItem.y = worldY - dragOffset.y;
                const el = document.getElementById(`item-${dragItem.id}`);
                if(el) { el.style.left = dragItem.x + 'px'; el.style.top = dragItem.y + 'px'; }
                refreshLinks(dragItem);
            } else if(isLinking && linkStartItem) {
                const worldX = (e.clientX - view.x) / view.scale;
                const worldY = (e.clientY - view.y) / view.scale;
                if(tempLinkPath) tempLinkPath.setAttribute("d", `M ${linkStartItem.x + 110} ${linkStartItem.y + 60} L ${worldX} ${worldY}`);
            }
        });

        document.addEventListener('mouseup', async (e) => {
            if(isPanning) { isPanning = false; document.body.style.cursor = 'crosshair'; }
            if(isDragging && dragItem) {
                dragItem.x = Math.round(dragItem.x / 20) * 20;
                dragItem.y = Math.round(dragItem.y / 20) * 20;
                const el = document.getElementById(`item-${dragItem.id}`);
                if(el) { el.style.zIndex = ''; el.style.left = dragItem.x + 'px'; el.style.top = dragItem.y + 'px'; }
                refreshLinks(dragItem);
                await API.exec({ action: 'move_inv_item', id: dragItem.id, x: dragItem.x, y: dragItem.y });
                isDragging = false; dragItem = null;
            }
            if(isLinking) {
                const targetEl = e.target.closest('.board-item');
                if(targetEl) {
                    const targetId = parseInt(targetEl.dataset.id);
                    if(linkStartItem && targetId !== linkStartItem.id) {
                        await API.exec({ action: 'add_inv_link', from_id: linkStartItem.id, to_id: targetId, type: 'red' });
                        init();
                    }
                }
                cancelLink();
            }
        });

        function onMouseDownItem(e, item) {
            e.stopPropagation(); ctxMenu.style.display = 'none';
            if(e.shiftKey) {
                isLinking = true; linkStartItem = item;
                tempLinkPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                tempLinkPath.setAttribute("class", "link-temp");
                svgLayer.appendChild(tempLinkPath);
            } else if(e.button === 0) {
                isDragging = true; dragItem = item;
                const worldX = (e.clientX - view.x) / view.scale; const worldY = (e.clientY - view.y) / view.scale;
                dragOffset.x = worldX - item.x; dragOffset.y = worldY - item.y;
                document.getElementById(`item-${item.id}`).style.zIndex = 1000;
            }
        }
        function cancelLink() { isLinking = false; linkStartItem = null; if(tempLinkPath) { tempLinkPath.remove(); tempLinkPath = null; } }
        function refreshLinks(movedItem) {
            links.filter(l => l.from_id === movedItem.id || l.to_id === movedItem.id).forEach(l => {
                const path = document.querySelector(`path[data-id="${l.id}"]`);
                const i1 = items.find(i => i.id === l.from_id);
                const i2 = items.find(i => i.id === l.to_id);
                if(path && i1 && i2) path.setAttribute("d", getPathD(i1, i2));
            });
        }
        document.addEventListener('wheel', (e) => {
            if(e.target.closest('.edit-modal')) return; e.preventDefault();
            const delta = -Math.sign(e.deltaY) * 0.1; const newScale = Math.min(Math.max(0.2, view.scale + delta), 4);
            const mouseX = (e.clientX - view.x) / view.scale; const mouseY = (e.clientY - view.y) / view.scale;
            view.x = e.clientX - mouseX * newScale; view.y = e.clientY - mouseY * newScale; view.scale = newScale;
            updateView();
        }, { passive: false });
        function updateView() { world.style.transform = `translate(${view.x}px, ${view.y}px) scale(${view.scale})`; }
        function centerView() { view.x = window.innerWidth/2 - 500; view.y = window.innerHeight/2 - 400; updateView(); }
        function resetView() { view = {x:0,y:0,scale:1}; updateView(); }

        // --- CONTEXT & COLOR ---
        function openContextMenu(e, id, type) {
            e.preventDefault(); e.stopPropagation();
            contextTargetId = id;
            contextTargetType = type; // On stocke si c'est un ITEM ou un LINK
            ctxMenu.style.display = 'flex';
            ctxMenu.style.left = e.clientX + 'px';
            ctxMenu.style.top = e.clientY + 'px';
        }

        async function applyColor(color) {
            ctxMenu.style.display = 'none';
            if(!contextTargetId) return;

            if(contextTargetType === 'item') {
                // UPDATE ITEM
                const item = items.find(i => i.id === contextTargetId);
                if(item) {
                    item.color = color;
                    const el = document.getElementById(`item-${item.id}`);
                    if(el) el.style.borderTopColor = color;
                    await API.exec({ action: 'update_inv_item_text', id: item.id, color: color });
                }
            } else if (contextTargetType === 'link') {
                // UPDATE LINK (Convert Hex -> Class Name)
                let typeName = 'red';
                if(color === '#00ff9d') typeName = 'green';
                if(color === '#00f3ff') typeName = 'blue';
                if(color === '#eebb00') typeName = 'warning';
                if(color === '#b026ff') typeName = 'purple';
                if(color === '#eeeeee') typeName = 'white';

                const path = document.querySelector(`path[data-id="${contextTargetId}"]`);
                if(path) path.setAttribute('class', `link-${typeName}`);
                
                // On met à jour le lien dans la BDD (on utilise une commande d'update lien simulée si besoin ou existante)
                // Comme 'update_inv_link' n'était pas dans la liste initiale, on suppose qu'il faut recréer ou utiliser une commande custom.
                // Pour simplifier ici: on va appeler update_inv_link (à implémenter côté serveur si inexistant, ou recréer).
                // Solution robuste: Supprimer + Recréer (car API souvent limitée) ou Update si supporté.
                // Ici je tente un update direct.
                await API.exec({ action: 'update_inv_link', id: contextTargetId, type: typeName });
            }
        }

        async function contextAction(action) {
            ctxMenu.style.display = 'none';
            if(!contextTargetId) return;

            if(action === 'delete') {
                if(contextTargetType === 'item') {
                    if(confirm("Supprimer dossier ?")) {
                        await API.exec({ action: 'del_inv_item', id: contextTargetId });
                        init();
                    }
                } else if(contextTargetType === 'link') {
                    if(confirm("Supprimer lien ?")) {
                        await API.exec({ action: 'del_inv_link', id: contextTargetId });
                        init();
                    }
                }
            } else if(action === 'edit' && contextTargetType === 'item') {
                const item = items.find(i => i.id === contextTargetId);
                openEditModal('edit', item.type, item);
            }
        }

        // --- MODAL ---
        function openEditModal(mode, type, data=null) {
            editModal.style.display = 'flex';
            document.getElementById('modal-mode').value = mode;
            document.getElementById('modal-type').value = type;
            const imgGroup = document.getElementById('modal-image-group');
            if(mode === 'edit' && data) {
                document.getElementById('modal-id').value = data.id;
                document.getElementById('modal-label').value = data.label;
                document.getElementById('modal-image').value = data.image_url || '';
                imgGroup.style.display = (data.type === 'suspect') ? 'block' : 'none';
            } else {
                document.getElementById('modal-label').value = '';
                document.getElementById('modal-image').value = '';
                imgGroup.style.display = (type === 'suspect') ? 'block' : 'none';
            }
        }
        function closeModal() { editModal.style.display = 'none'; }

        async function saveModalData() {
            const mode = document.getElementById('modal-mode').value;
            const type = document.getElementById('modal-type').value;
            const label = document.getElementById('modal-label').value;
            const img = document.getElementById('modal-image').value;
            const id = parseInt(document.getElementById('modal-id').value);
            closeModal();
            if(mode === 'new') {
                const cx = (window.innerWidth/2 - view.x)/view.scale - 110;
                const cy = (window.innerHeight/2 - view.y)/view.scale - 100;
                await API.exec({ action: 'add_inv_item', type, label, image_url: img, x: parseInt(cx), y: parseInt(cy), color: '#eebb00' });
            } else {
                await API.exec({ action: 'update_inv_item_text', id, label, image_url: img });
            }
            init();
        }

        document.addEventListener('click', (e) => {
            if(!e.target.closest('#context-menu')) ctxMenu.style.display = 'none';
            if(e.target === editModal) closeModal();
        });

        init();
    </script>
</body>
</html>