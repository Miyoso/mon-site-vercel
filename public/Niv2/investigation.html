<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS :: INVESTIGATION WALL v2.0</title>
    
    <script> const REQUIRED_LEVEL = 2; </script>
    <script>if(typeof checkSecurity === 'undefined') { window.checkSecurity = function() { console.log("Sec Check Bypass"); } }</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Rajdhani:wght@500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        /* --- CONFIGURATION GLOBALE --- */
        :root {
            --primary: #00ff9d;
            --secondary: #00f3ff;
            --danger: #ff3333;
            --warning: #eebb00;
            --dim: #445566;
            --bg: #050505;
            --panel: rgba(10, 15, 20, 0.95);
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            width: 100vw; height: 100vh;
            overflow: hidden;
            cursor: crosshair;
            font-family: 'Share Tech Mono', monospace;
            color: #eee;
        }

        /* Grille de fond tactique */
        #grid-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none; z-index: -1;
        }

        /* --- COUCHE MONDE --- */
        #world-layer {
            position: absolute; top: 0; left: 0;
            transform-origin: 0 0; /* Important pour le calcul manuel du zoom */
            width: 100%; height: 100%;
        }

        /* --- ITEMS --- */
        .board-item {
            position: absolute;
            background: var(--panel);
            border: 1px solid var(--dim);
            padding: 10px;
            width: 220px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: box-shadow 0.2s, border-color 0.2s; /* Pas de transition sur top/left pour la fluidité du drag */
            user-select: none;
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
        }

        .board-item:hover {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.15);
            z-index: 100;
        }

        /* Types d'items */
        .item-suspect { border-top: 3px solid var(--danger); }
        .item-suspect img { width: 100%; height: 140px; object-fit: cover; border: 1px solid #333; margin-bottom: 8px; filter: sepia(0.2) contrast(1.1); pointer-events: none; }
        .item-note { border-top: 3px solid var(--warning); background: rgba(255, 200, 0, 0.02); }

        .item-content { font-size: 0.85rem; line-height: 1.3; white-space: pre-wrap; }
        .item-header {
            font-family: 'Rajdhani'; font-weight: bold; font-size: 0.75rem; color: var(--dim);
            margin-bottom: 5px; display: flex; justify-content: space-between; text-transform: uppercase;
        }

        /* --- LIENS SVG --- */
        #connections-layer { overflow: visible; position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
        
        #connections-layer path {
            stroke-width: 2; fill: none;
            transition: stroke-width 0.2s, filter 0.2s;
            pointer-events: visibleStroke; cursor: pointer;
        }
        #connections-layer path:hover { stroke-width: 4; filter: drop-shadow(0 0 4px currentColor); }
        
        .link-red { stroke: var(--danger); }
        .link-green { stroke: var(--primary); }
        .link-blue { stroke: var(--secondary); }
        .link-temp { stroke: #fff; stroke-dasharray: 5,5; opacity: 0.5; }

        /* --- UI HUD --- */
        .hud-overlay { position: fixed; pointer-events: none; width: 100%; height: 100%; z-index: 500; }

        .help-indicator {
            position: absolute; bottom: 20px; left: 20px;
            font-size: 0.75rem; color: #888;
            background: rgba(0,0,0,0.8); padding: 5px 10px; border-left: 2px solid var(--primary);
        }

        .toolbar {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; pointer-events: auto;
            background: var(--panel); border: 1px solid var(--dim);
            padding: 8px; border-radius: 4px;
        }

        .tool-btn {
            background: rgba(255,255,255,0.03); border: 1px solid transparent; color: #aaa;
            padding: 6px 12px; font-family: 'JetBrains Mono'; font-size: 0.75rem;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: #555; }
        .separator { width: 1px; background: #333; margin: 0 4px; }

        /* Context Menu & Modal (Style simplifié) */
        #context-menu {
            position: fixed; background: #0f1419; border: 1px solid var(--primary);
            z-index: 1000; display: none; flex-direction: column; min-width: 160px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.8);
        }
        .ctx-item { padding: 10px 15px; cursor: pointer; font-size: 0.8rem; color: #ccc; border-bottom: 1px solid #222; }
        .ctx-item:hover { background: var(--primary); color: #000; }

        .edit-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 2000;
            pointer-events: auto; backdrop-filter: blur(2px);
        }
        .edit-modal {
            background: #0b1015; border: 1px solid var(--dim); border-top: 4px solid var(--primary);
            padding: 30px; width: 400px; box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        .edit-input {
            width: 100%; background: #151a20; border: 1px solid #333;
            color: #fff; padding: 10px; margin-bottom: 15px; font-family: inherit; resize: vertical; box-sizing: border-box;
        }
        .edit-input:focus { outline: none; border-color: var(--primary); }

    </style>
</head>
<body>

    <div id="grid-bg"></div>

    <div class="hud-overlay">
        <div class="toolbar">
            <button class="tool-btn" onclick="location.reload()">[ RECHARGER ]</button>
            <div class="separator"></div>
            <button class="tool-btn" onclick="openEditModal('new', 'suspect')"><span style="color:var(--danger)">■</span> SUSPECT</button>
            <button class="tool-btn" onclick="openEditModal('new', 'note')"><span style="color:var(--warning)">■</span> NOTE</button>
            <div class="separator"></div>
            <button class="tool-btn" onclick="resetView()">RESET VUE</button>
        </div>

        <div class="help-indicator">
            [ GAUCHE : BOUGER | MOLETTE : ZOOM CURSEUR | SHIFT+DRAG : LIER | DOUBLE-CLIC : ÉDITER ]
        </div>
    </div>

    <div id="world-layer">
        <svg id="connections-layer"></svg>
        <div id="items-layer"></div>
    </div>

    <div id="context-menu">
        <div class="ctx-item" onclick="contextAction('edit')">ÉDITER</div>
        <div class="ctx-item" onclick="contextAction('color')">CHANGER COULEUR</div>
        <div class="ctx-item" onclick="contextAction('delete')" style="color:var(--danger)">SUPPRIMER</div>
    </div>

    <div class="edit-modal-overlay" id="editModal">
        <div class="edit-modal">
            <h3 style="margin-top:0; color:var(--primary)">//: SAISIE DONNÉES</h3>
            <input type="hidden" id="modal-mode">
            <input type="hidden" id="modal-type">
            <input type="hidden" id="modal-id">
            
            <label style="font-size:0.7rem; color:#666;">LABEL / DESCRIPTION</label>
            <textarea id="modal-label" class="edit-input" rows="3"></textarea>
            
            <div id="modal-image-group">
                <label style="font-size:0.7rem; color:#666;">IMAGE URL</label>
                <input type="text" id="modal-image" class="edit-input" placeholder="http://...">
            </div>

            <div style="text-align: right; margin-top: 10px;">
                <button class="tool-btn" onclick="closeModal()" style="display:inline-block">ANNULER</button>
                <button class="tool-btn" onclick="saveModalData()" style="display:inline-block; border-color:var(--primary); color:var(--primary)">CONFIRMER</button>
            </div>
        </div>
    </div>

    <script>
        // --- ÉTAT DU SYSTÈME ---
        let items = [];
        let links = [];
        
        // Navigation
        let view = { x: 0, y: 0, scale: 1 };
        let isPanning = false;
        let lastMouse = { x: 0, y: 0 };

        // Interaction Items
        let dragItem = null;
        let dragOffset = { x: 0, y: 0 };
        let isDragging = false;

        // Interaction Links (Nouveau: Shift+Drag)
        let isLinking = false;
        let linkStartItem = null;
        let tempLinkPath = null;

        // DOM Cache
        const world = document.getElementById('world-layer');
        const itemsLayer = document.getElementById('items-layer');
        const svgLayer = document.getElementById('connections-layer');
        const ctxMenu = document.getElementById('context-menu');
        const editModal = document.getElementById('editModal');

        // --- MOCK API (Pour que ça marche sans backend) ---
        // Dans la version réelle, remplacez par vos fetch()
        const API = {
            data: {
                items: [
                    { id: 1, type: 'suspect', x: 400, y: 300, label: 'Cible Alpha', image_url: 'https://placehold.co/200x150/111/FFF?text=ALPHA' },
                    { id: 2, type: 'note', x: 700, y: 400, label: 'Vu au port à 22h', color: '#eebb00' }
                ],
                links: [{ id: 101, from_id: 1, to_id: 2, type: 'red' }]
            },
            async read() { return this.data; },
            async exec(cmd) {
                console.log("API:", cmd);
                // Simulation logique locale
                if(cmd.action === 'move') { 
                    const i = this.data.items.find(x => x.id === cmd.id);
                    if(i) { i.x = cmd.x; i.y = cmd.y; }
                }
                if(cmd.action === 'add_link') {
                    this.data.links.push({ id: Date.now(), from_id: cmd.from_id, to_id: cmd.to_id, type: cmd.type });
                }
                if(cmd.action === 'del_link') {
                    this.data.links = this.data.links.filter(l => l.id !== cmd.id);
                }
                if(cmd.action === 'update_text') {
                    const i = this.data.items.find(x => x.id === cmd.id);
                    if(i) { i.label = cmd.label; i.image_url = cmd.image_url; if(cmd.color) i.color = cmd.color; }
                }
                if(cmd.action === 'add_item') {
                    this.data.items.push({ id: Date.now(), type: cmd.type, label: cmd.label, image_url: cmd.image_url, x: cmd.x, y: cmd.y, color: cmd.color });
                }
                if(cmd.action === 'del_item') {
                    this.data.items = this.data.items.filter(x => x.id !== cmd.id);
                    this.data.links = this.data.links.filter(l => l.from_id !== cmd.id && l.to_id !== cmd.id);
                }
                return { success: true };
            }
        };

        // --- CORE ---
        async function init() {
            const data = await API.read();
            items = data.items;
            links = data.links;
            renderAll();
            centerView();
        }

        function renderAll() {
            itemsLayer.innerHTML = '';
            svgLayer.innerHTML = ''; // Nettoyage total
            
            // 1. Rendu Items
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = `board-item item-${item.type}`;
                el.id = `item-${item.id}`;
                el.dataset.id = item.id;
                // Positionnement initial
                updateItemDOMPosition(el, item.x, item.y);

                if(item.type === 'note' && item.color) el.style.borderTopColor = item.color;

                let html = `<div class="item-header"><span>#${item.id}</span><span>${item.type}</span></div>`;
                if(item.type === 'suspect') html += `<img src="${item.image_url || ''}" draggable="false">`;
                html += `<div class="item-content">${item.label}</div>`;
                
                el.innerHTML = html;

                // EVENTS ITEM
                el.onmousedown = (e) => handleItemMouseDown(e, item);
                el.ondblclick = (e) => { e.stopPropagation(); openEditModal('edit', item.type, item); };
                el.oncontextmenu = (e) => openContextMenu(e, item.id);
                
                // Pour le Shift+Drag Link (Drop target)
                el.onmouseup = (e) => handleLinkDrop(e, item);

                itemsLayer.appendChild(el);
            });

            // 2. Rendu Liens
            links.forEach(link => createSvgLink(link));
        }

        function createSvgLink(link) {
            const from = items.find(i => i.id === link.from_id);
            const to = items.find(i => i.id === link.to_id);
            if(!from || !to) return;

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("class", `link-${link.type}`);
            path.dataset.id = link.id;
            path.dataset.from = link.from_id;
            path.dataset.to = link.to_id;
            
            // Calcul initial
            const d = calculatePathD(from, to);
            path.setAttribute("d", d);

            path.ondblclick = async (e) => {
                e.stopPropagation();
                if(confirm("Couper la liaison ?")) {
                    await API.exec({ action: 'del_link', id: link.id });
                    init();
                }
            };

            svgLayer.appendChild(path);
        }

        function updateItemDOMPosition(el, x, y) {
            el.style.left = x + 'px';
            el.style.top = y + 'px';
        }

        // --- GESTION VUE (ZOOM/PAN) ---
        
        // Pan
        document.addEventListener('mousedown', (e) => {
            if(e.target.closest('.board-item') || e.target.closest('.toolbar') || e.target.closest('.edit-modal')) return;
            // Si pas sur un item, on pan
            if(e.button === 0 || e.button === 1) { // Click gauche (sur fond) ou molette
                isPanning = true;
                lastMouse = { x: e.clientX, y: e.clientY };
                document.body.style.cursor = 'grabbing';
                ctxMenu.style.display = 'none';
            }
        });

        document.addEventListener('mousemove', (e) => {
            // Pan Logic
            if(isPanning) {
                const dx = e.clientX - lastMouse.x;
                const dy = e.clientY - lastMouse.y;
                view.x += dx;
                view.y += dy;
                lastMouse = { x: e.clientX, y: e.clientY };
                updateTransform();
            }
            
            // Drag Item Logic
            if(isDragging && dragItem) {
                handleDragMove(e);
            }

            // Link Creation Logic
            if(isLinking) {
                handleLinkMove(e);
            }
        });

        document.addEventListener('mouseup', async () => {
            if(isPanning) {
                isPanning = false;
                document.body.style.cursor = 'crosshair';
            }
            if(isDragging) {
                await stopItemDrag();
            }
            if(isLinking) {
                stopLinking(); // Annulation si relâché dans le vide
            }
        });

        // Zoom au curseur (Ergonomie moderne)
        document.addEventListener('wheel', (e) => {
            if (e.target.closest('.edit-modal')) return; // Scroll dans modale
            e.preventDefault();

            const zoomIntensity = 0.1;
            const delta = -Math.sign(e.deltaY) * zoomIntensity;
            const newScale = Math.min(Math.max(0.2, view.scale + delta), 4);

            // Calcul pour zoomer vers la souris
            const mouseX = (e.clientX - view.x) / view.scale;
            const mouseY = (e.clientY - view.y) / view.scale;

            view.x = e.clientX - mouseX * newScale;
            view.y = e.clientY - mouseY * newScale;
            view.scale = newScale;

            updateTransform();
        }, { passive: false });

        function updateTransform() {
            world.style.transform = `translate(${view.x}px, ${view.y}px) scale(${view.scale})`;
        }

        function centerView() {
            view.x = window.innerWidth/2 - 500;
            view.y = window.innerHeight/2 - 400;
            updateTransform();
        }
        function resetView() { view = {x:0, y:0, scale:1}; updateTransform(); }

        // --- DRAG & DROP ITEMS (Amélioré) ---
        
        function handleItemMouseDown(e, item) {
            e.stopPropagation();
            ctxMenu.style.display = 'none';

            // Feature: SHIFT + Click = Créer Lien
            if(e.shiftKey) {
                startLinking(e, item);
                return;
            }

            if(e.button === 0) {
                isDragging = true;
                dragItem = item;
                
                // Position souris dans le monde
                const worldX = (e.clientX - view.x) / view.scale;
                const worldY = (e.clientY - view.y) / view.scale;
                
                dragOffset.x = worldX - item.x;
                dragOffset.y = worldY - item.y;
                
                // Z-Index up
                const el = document.getElementById(`item-${item.id}`);
                el.style.zIndex = 1000;
                el.style.transition = 'none'; // Désactive transition pour réactivité immédiate
            }
        }

        function handleDragMove(e) {
            const worldX = (e.clientX - view.x) / view.scale;
            const worldY = (e.clientY - view.y) / view.scale;
            
            // Raw movement
            dragItem.x = worldX - dragOffset.x;
            dragItem.y = worldY - dragOffset.y;

            // Update Item DOM
            const el = document.getElementById(`item-${dragItem.id}`);
            updateItemDOMPosition(el, dragItem.x, dragItem.y);

            // LIVE LINK UPDATE (Performance)
            updateRelatedLinks(dragItem);
        }

        async function stopItemDrag() {
            if(!dragItem) return;
            
            // SNAP TO GRID (Ergonomie: Alignement automatique)
            const gridSize = 20;
            dragItem.x = Math.round(dragItem.x / gridSize) * gridSize;
            dragItem.y = Math.round(dragItem.y / gridSize) * gridSize;
            
            // Final DOM update + Animation restore
            const el = document.getElementById(`item-${dragItem.id}`);
            el.style.transition = ''; 
            el.style.zIndex = '';
            updateItemDOMPosition(el, dragItem.x, dragItem.y);
            
            updateRelatedLinks(dragItem); // Final link snap

            // Save
            await API.exec({ action: 'move', id: dragItem.id, x: dragItem.x, y: dragItem.y });
            
            isDragging = false; dragItem = null;
        }

        // --- LOGIQUE DES LIENS ---

        function calculatePathD(item1, item2) {
            // Centre des boites (largeur 220, hauteur variable ~100-200)
            // On approxime le centre Y à +60px
            const x1 = item1.x + 110; 
            const y1 = item1.y + 60; 
            const x2 = item2.x + 110; 
            const y2 = item2.y + 60;

            const cx = (x1 + x2) / 2;
            const cy = Math.min(y1, y2) - 50; // Courbure légère
            return `M ${x1} ${y1} Q ${cx} ${cy} ${x2} ${y2}`;
        }

        function updateRelatedLinks(item) {
            // On cherche tous les paths SVG qui sont liés à cet ID
            const relatedPaths = document.querySelectorAll(`path[data-from="${item.id}"], path[data-to="${item.id}"]`);
            relatedPaths.forEach(path => {
                const fid = parseInt(path.dataset.from);
                const tid = parseInt(path.dataset.to);
                const fItem = items.find(i => i.id === fid);
                const tItem = items.find(i => i.id === tid);
                if(fItem && tItem) {
                    path.setAttribute('d', calculatePathD(fItem, tItem));
                }
            });
        }

        // --- SYSTEME SHIFT+DRAG LINK ---
        function startLinking(e, item) {
            isLinking = true;
            linkStartItem = item;
            
            // Créer ligne temporaire
            tempLinkPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
            tempLinkPath.setAttribute("class", "link-temp");
            svgLayer.appendChild(tempLinkPath);
        }

        function handleLinkMove(e) {
            if(!linkStartItem) return;
            const worldX = (e.clientX - view.x) / view.scale;
            const worldY = (e.clientY - view.y) / view.scale;

            const startX = linkStartItem.x + 110;
            const startY = linkStartItem.y + 60;

            // Ligne droite simple pour la visu temporaire
            tempLinkPath.setAttribute("d", `M ${startX} ${startY} L ${worldX} ${worldY}`);
        }

        async function handleLinkDrop(e, targetItem) {
            if(isLinking && linkStartItem && targetItem.id !== linkStartItem.id) {
                // Création du lien !
                await API.exec({ 
                    action: 'add_link', 
                    from_id: linkStartItem.id, 
                    to_id: targetItem.id, 
                    type: 'red' // Défaut rouge
                });
                stopLinking();
                init(); // Reload propre
            }
        }

        function stopLinking() {
            isLinking = false;
            linkStartItem = null;
            if(tempLinkPath) {
                tempLinkPath.remove();
                tempLinkPath = null;
            }
        }

        // --- UI & MENUS ---
        let contextTargetId = null;

        function openContextMenu(e, id) {
            e.preventDefault();
            contextTargetId = id;
            ctxMenu.style.display = 'flex';
            ctxMenu.style.left = e.clientX + 'px';
            ctxMenu.style.top = e.clientY + 'px';
        }

        async function contextAction(action) {
            ctxMenu.style.display = 'none';
            if(!contextTargetId) return;
            const item = items.find(i => i.id === contextTargetId);

            if(action === 'delete') {
                if(confirm("Supprimer dossier ?")) {
                    await API.exec({ action: 'del_item', id: contextTargetId });
                    init();
                }
            } else if(action === 'edit') {
                openEditModal('edit', item.type, item);
            } else if(action === 'color') {
                const c = prompt("Couleur Hex ?", "#00ff9d");
                if(c) {
                    await API.exec({ action: 'update_text', id: item.id, label: item.label, color: c });
                    init();
                }
            }
        }

        function openEditModal(mode, type, data=null) {
            editModal.style.display = 'flex';
            document.getElementById('modal-mode').value = mode;
            document.getElementById('modal-type').value = type;
            const grp = document.getElementById('modal-image-group');
            
            if(mode === 'edit' && data) {
                document.getElementById('modal-id').value = data.id;
                document.getElementById('modal-label').value = data.label;
                document.getElementById('modal-image').value = data.image_url || '';
                grp.style.display = (data.type === 'suspect') ? 'block' : 'none';
            } else {
                document.getElementById('modal-label').value = '';
                document.getElementById('modal-image').value = '';
                grp.style.display = (type === 'suspect') ? 'block' : 'none';
            }
        }

        function closeModal() { editModal.style.display = 'none'; }

        async function saveModalData() {
            const mode = document.getElementById('modal-mode').value;
            const type = document.getElementById('modal-type').value;
            const label = document.getElementById('modal-label').value;
            const img = document.getElementById('modal-image').value;
            const id = parseInt(document.getElementById('modal-id').value);

            closeModal();

            if(mode === 'new') {
                // Centre de l'écran par défaut
                const cx = (window.innerWidth/2 - view.x)/view.scale - 110;
                const cy = (window.innerHeight/2 - view.y)/view.scale - 100;
                await API.exec({ action: 'add_item', type, label, image_url: img, x: parseInt(cx), y: parseInt(cy), color: '#eebb00' });
            } else {
                await API.exec({ action: 'update_text', id, label, image_url: img });
            }
            init();
        }

        // Fermer les menus au clic ailleurs
        document.addEventListener('click', (e) => {
            if(!e.target.closest('#context-menu')) ctxMenu.style.display = 'none';
            if(e.target === editModal) closeModal();
        });

        // Start
        init();

    </script>
</body>
</html>