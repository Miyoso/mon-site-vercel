<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - Inventaire (Niv 3)</title>
    <script>
        const REQUIRED_LEVEL = 3;
    </script>
    <script src="/js/security.js"></script>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
</head>
<body>
    <main class="terminal">
        <h1>INVENTAIRE (NIV 3)<span class="blinker">_</span></h1>
        <p class="status">STATUS: <span class="secure">DECRYPTED</span> :: ACCES: <span class="restricted" id="agent-name-display"></span></p>
        <div class="report-content" id="inventory-container">
            <p>[CHARGEMENT DE L'INVENTAIRE...]</p>
        </div>
        <div class="report-content" id="forms-container">
            <h3 class="category-title" id="form-title-add">//: AJOUTER UN NOUVEL OBJET</h3>
            <form id="add-item-form" class="form-grid">
                <div class="form-group">
                    <label for="add-category">Catégorie</label>
                    <input type="text" id="add-category" name="category" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="add-item-name">Nom de l'objet</label>
                    <input type="text" id="add-item-name" name="item_name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="add-serial">N° de série</label>
                    <input type="text" id="add-serial" name="serial_number" class="form-input">
                </div>
                <div class="form-group">
                    <label for="add-status">Statut initial</label>
                    <select id="add-status" name="status" class="form-select" required>
                        <option value="Opérationnel">Opérationnel</option>
                        <option value="Stock">Stock</option>
                        <option value="En maintenance">En maintenance</option>
                    </select>
                </div>
                <button type="submit" class="form-button full-width">&gt;&gt; AJOUTER L'OBJET</button>
                <p id="add-form-message" class="form-message full-width"></p>
            </form>
            <h3 class="category-title" id="form-title-update">//: METTRE À JOUR UN OBJET</h3>
            <form id="update-item-form" class="assignment-form">
                <label for="update-item-select">//: 1. SÉLECTIONNER L'OBJET</label>
                <select id="update-item-select" name="itemId" class="form-select" required>
                    <option value="">-- En attente de l'API... --</option>
                </select>
                <label for="update-agent-select">//: 2. ASSIGNER À</label>
                <select id="update-agent-select" name="agentName" class="form-select" required>
                    <option value="">-- En attente de l'API... --</option>
                </select>
                <label for="update-status-select">//: 3. CHANGER STATUT</label>
                <select id="update-status-select" name="status" class="form-select" required>
                    <option value="Opérationnel">Opérationnel</option>
                    <option value="Stock">Stock</option>
                    <option value="En maintenance">En maintenance</option>
                    <option value="Perdu">Perdu</option>
                </select>
                <button type="submit" class="form-button">&gt;&gt; CONFIRMER LA MISE À JOUR</button>
                <p id="update-form-message" class="form-message"></p>
            </form>
            <h3 class="category-title" id="form-title-delete">//: SUPPRIMER UN OBJET (IRRÉVERSIBLE)</h3>
            <form id="delete-item-form" class="assignment-form">
                <label for="delete-item-select">//: SÉLECTIONNER L'OBJET À SUPPRIMER</label>
                <select id="delete-item-select" name="itemId" class="form-select" required>
                    <option value="">-- En attente de l'API... --</option>
                </select>
                <button type="submit" class="form-button delete">&gt;&gt; SUPPRIMER DÉFINITIVEMENT</button>
                <p id="delete-form-message" class="form-message"></p>
            </form>
        </div>
        <footer class="portal-footer">
            <a href="/index.html" class="back-link">&lt;&lt; RETURN_TO_MAINFRAME</a>
        </footer>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const agentName = localStorage.getItem('sas_user') || 'UNKNOWN';
            document.getElementById('agent-name-display').textContent = agentName;
            const inventoryContainer = document.getElementById('inventory-container');
            const updateItemSelect = document.getElementById('update-item-select');
            const updateAgentSelect = document.getElementById('update-agent-select');
            const deleteItemSelect = document.getElementById('delete-item-select');

            async function fetchAndDisplayInventory() {
                try {
                    const response = await fetch('/api/read?resource=inventory');
                    const data = await response.json();
                    if (!data.items) throw new Error('Données d\'inventaire non reçues');

                    inventoryContainer.innerHTML = '';
                    let htmlToInsert = '';
                    let currentCategory = '';
                    let itemOptionsHTML = '<option value="">-- Sélectionner un objet --</option>';

                    data.items.forEach(item => {
                        if (item.category !== currentCategory) {
                            if (currentCategory !== '') htmlToInsert += `</ul>`;
                            currentCategory = item.category;
                            htmlToInsert += `<h3 class="category-title">//: ${currentCategory.toUpperCase()}</h3><ul class="inventory-list">`;
                        }
                        htmlToInsert += `
                            <li>
                                <span class="item-name">${item.item_name}</span>
                                <ul class="item-details">
                                    <li><span class="detail-label">N° de série:</span> ${item.serial_number || 'N/A'}</li>
                                    <li><span class="detail-label">Attribution:</span> ${item.assigned_to || 'Aucune'}</li>
                                    <li><span class="detail-label">Statut:</span> ${item.status}</li>
                                </ul>
                            </li>
                        `;
                        itemOptionsHTML += `<option value="${item.id}">${item.item_name} (N°: ${item.serial_number})</option>`;
                    });
                    htmlToInsert += `</ul>`;
                    inventoryContainer.innerHTML = htmlToInsert;
                    updateItemSelect.innerHTML = itemOptionsHTML;
                    deleteItemSelect.innerHTML = itemOptionsHTML;

                } catch (error) {
                    console.error('Erreur:', error);
                    inventoryContainer.innerHTML = '<p>[ERREUR DE CONNEXION AU MAINFRAME]</p>';
                }
            }

            async function fetchAgentsForForm() {
                try {
                    const response = await fetch('/api/read?resource=agents');
                    const data = await response.json();
                    if (!data.agents) throw new Error('Agents non reçus');
                    let agentOptionsHTML = '<option value="Réserve SAS">-- Réserve SAS --</option>';
                    data.agents.forEach(agent => {
                        agentOptionsHTML += `<option value="${agent.name}">${agent.name} (Niv ${agent.level})</option>`;
                    });
                    updateAgentSelect.innerHTML = agentOptionsHTML;
                } catch (error) {
                    console.error('Erreur agents:', error);
                    updateAgentSelect.innerHTML = '<option value="">Erreur API</option>';
                }
            }

            const addForm = document.getElementById('add-item-form');
            const addMessageEl = document.getElementById('add-form-message');
            addForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                addMessageEl.textContent = 'Ajout en cours...';
                addMessageEl.className = 'form-message';
                try {
                    const formData = new FormData(addForm);
                    const data = Object.fromEntries(formData.entries());
                    
                    const response = await fetch('/api/execute-action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...data, action: 'add_item' })
                    });

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error);
                    addMessageEl.textContent = 'Objet ajouté ! Mise à jour...';
                    addMessageEl.className = 'form-message success';
                    addForm.reset();
                    setTimeout(fetchAndDisplayInventory, 500);
                } catch (error) {
                    addMessageEl.textContent = `Erreur: ${error.message}`;
                    addMessageEl.className = 'form-message error';
                }
            });

            const updateForm = document.getElementById('update-item-form');
            const updateMessageEl = document.getElementById('update-form-message');
            updateForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                updateMessageEl.textContent = 'Mise à jour en cours...';
                updateMessageEl.className = 'form-message';
                try {
                    const response = await fetch('/api/execute-action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'update_item',
                            itemId: updateForm.itemId.value,
                            agentName: updateForm.agentName.value,
                            status: updateForm.status.value
                        })
                    });

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error);
                    updateMessageEl.textContent = 'Objet mis à jour ! Mise à jour...';
                    updateMessageEl.className = 'form-message success';
                    setTimeout(fetchAndDisplayInventory, 500);
                } catch (error) {
                    updateMessageEl.textContent = `Erreur: ${error.message}`;
                    updateMessageEl.className = 'form-message error';
                }
            });

            const deleteForm = document.getElementById('delete-item-form');
            const deleteMessageEl = document.getElementById('delete-form-message');
            deleteForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const itemId = deleteForm.itemId.value;
                if (!confirm("Voulez-vous vraiment supprimer cet objet ?\nCette action est IRRÉVERSIBLE.")) return;
                deleteMessageEl.textContent = 'Suppression en cours...';
                deleteMessageEl.className = 'form-message';
                try {
                    const response = await fetch('/api/execute-action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'delete_item', itemId })
                    });

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error);
                    deleteMessageEl.textContent = 'Objet supprimé ! Mise à jour...';
                    deleteMessageEl.className = 'form-message success';
                    setTimeout(fetchAndDisplayInventory, 500);
                } catch (error) {
                    deleteMessageEl.textContent = `Erreur: ${error.message}`;
                    deleteMessageEl.className = 'form-message error';
                }
            });

            fetchAndDisplayInventory();
            fetchAgentsForForm();
        });
    </script>
</body>
</html>