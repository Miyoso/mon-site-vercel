<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>SAS - Gestion √âquipement</title>
    <script> const REQUIRED_LEVEL = 3; </script>
    <script src="/js/security.js"></script>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* --- STYLES DRAG & DROP --- */
        .equipment-grid {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
            background: rgba(0, 20, 0, 0.3);
            padding: 20px;
            border: 1px dashed #004400;
        }

        .equip-slot {
            width: 120px;
            height: 120px;
            border: 2px solid #333;
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s;
        }
        
        .equip-slot.drag-over {
            border-color: #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }

        .slot-label {
            font-size: 0.7rem;
            color: #555;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .inventory-item-card {
            background: #111;
            border: 1px solid #003300;
            padding: 10px;
            margin: 5px;
            cursor: grab;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .inventory-item-card:active { cursor: grabbing; }
        .inventory-item-card:hover { border-color: #00ff00; }

        .item-icon { font-size: 1.5rem; }
        
        /* Indicateur visuel d'un objet √©quip√© */
        .equipped-badge {
            position: absolute;
            top: -5px; right: -5px;
            background: #00ff00;
            color: #000;
            font-size: 0.7rem;
            padding: 2px 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <main class="terminal">
        <h1>GESTION D'√âQUIPEMENT<span class="blinker">_</span></h1>
        <p class="status">AGENT: <span class="secure" id="agent-display"></span></p>

        <div class="equipment-grid">
            <div class="equip-slot" data-slot="access_card" ondrop="drop(event)" ondragover="allowDrop(event)">
                <div class="slot-content">VIDE</div>
                <span class="slot-label">BADGE ACC√àS</span>
            </div>
            <div class="equip-slot" data-slot="weapon" ondrop="drop(event)" ondragover="allowDrop(event)">
                <div class="slot-content">VIDE</div>
                <span class="slot-label">ARME</span>
            </div>
            <div class="equip-slot" data-slot="gadget" ondrop="drop(event)" ondragover="allowDrop(event)">
                <div class="slot-content">VIDE</div>
                <span class="slot-label">GADGET</span>
            </div>
        </div>

        <h3 class="category-title">//: R√âSERVE DISPONIBLE</h3>
        <div id="inventory-list" class="report-content" style="min-height: 200px;">
            </div>

        <footer class="portal-footer">
            <a href="/index.html" class="back-link"><< RETOUR</a>
        </footer>
    </main>

    <script>
        const currentUser = localStorage.getItem('sas_user') || 'UNKNOWN';
        document.getElementById('agent-display').textContent = currentUser;

        // --- 1. CHARGEMENT DES DONN√âES ---
        async function loadInventory() {
            const res = await fetch('/api/read?resource=inventory');
            const data = await res.json();
            
            const listContainer = document.getElementById('inventory-list');
            const slots = document.querySelectorAll('.equip-slot');
            
            // Reset visuel
            listContainer.innerHTML = '';
            slots.forEach(s => {
                s.querySelector('.slot-content').innerHTML = '<span style="color:#333; font-size:2rem;">+</span>';
                s.classList.remove('has-item');
            });

            data.items.forEach(item => {
                // Si l'objet est assign√© √† l'agent actuel ET marqu√© comme "Equipped" (statut sp√©cial)
                // Note: Tu devras adapter ta logique selon comment tu stockes "√©quip√©" vs "dans la poche"
                if (item.assigned_to === currentUser && item.status === 'EQUIPPED') {
                    placeItemInSlot(item);
                } else if (item.status !== 'Perdu') {
                    createDraggableItem(item, listContainer);
                }
            });
        }

        function createDraggableItem(item, container) {
            const div = document.createElement('div');
            div.className = 'inventory-item-card';
            div.draggable = true;
            div.id = `item-${item.id}`;
            // On stocke les donn√©es importantes dans des attributs data
            div.dataset.id = item.id;
            div.dataset.category = item.category; // ex: 'access_card', 'weapon'
            div.dataset.name = item.item_name;
            
            // Ic√¥ne selon cat√©gorie (simple exemple)
            let icon = 'üì¶';
            if(item.category.includes('Badge')) icon = 'üí≥';
            if(item.category.includes('Arme')) icon = 'üî´';
            
            div.innerHTML = `<span class="item-icon">${icon}</span> <span>${item.item_name}</span>`;
            
            div.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData("text/plain", item.id);
                e.dataTransfer.setData("category", item.category); // Pour v√©rifier la compatibilit√© du slot
            });
            
            container.appendChild(div);
        }

        function placeItemInSlot(item) {
            // Trouve le slot correspondant (logique simplifi√©e ici)
            let slotType = 'gadget';
            if (item.category.toLowerCase().includes('badge') || item.item_name.includes('Carte')) slotType = 'access_card';
            else if (item.category.toLowerCase().includes('arme')) slotType = 'weapon';

            const slot = document.querySelector(`.equip-slot[data-slot="${slotType}"]`);
            if (slot) {
                slot.querySelector('.slot-content').innerHTML = `
                    <div style="color:#00ff00; text-align:center;">
                        <div style="font-size:1.5rem;">üõ°Ô∏è</div>
                        <div style="font-size:0.8rem;">${item.item_name}</div>
                        <button onclick="unequipItem(${item.id})" style="font-size:0.6rem; color:#ff4141; background:none; border:1px solid #ff4141; cursor:pointer; margin-top:5px;">RETIRER</button>
                    </div>
                `;
                slot.classList.add('has-item');
            }
        }

        // --- 2. GESTION DRAG & DROP ---
        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
        }

        function drop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            
            const itemId = ev.dataTransfer.getData("text/plain");
            // Ici on pourrait v√©rifier si la cat√©gorie match avec ev.dataTransfer.getData("category")
            
            equipItem(itemId);
        }
        
        // Nettoyage visuel si on sort de la zone
        document.querySelectorAll('.equip-slot').forEach(slot => {
            slot.addEventListener('dragleave', () => slot.classList.remove('drag-over'));
        });

        // --- 3. API CALLS ---
        async function equipItem(id) {
            await fetch('/api/execute-action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    action: 'equip_item', 
                    itemId: id, 
                    agentName: currentUser 
                })
            });
            loadInventory(); // Rafra√Æchir l'affichage
        }

        async function unequipItem(id) {
            await fetch('/api/execute-action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    action: 'unequip_item', 
                    itemId: id 
                })
            });
            loadInventory();
        }

        loadInventory();
    </script>
</body>
</html>