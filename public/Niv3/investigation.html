<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUR D'ENQUÊTE v2.0</title>
    <script> const REQUIRED_LEVEL = 3; </script>
    <script src="/js/security.js"></script>
    <link rel="stylesheet" href="/css/style-investigation.css">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Indie+Flower&display=swap" rel="stylesheet">
</head>
<body>

    <div class="help-indicator">
        [ CLIC-DROIT : MENU | GLISSER FOND : PAN | MOLETTE : ZOOM ]
    </div>

    <div id="world-layer" style="transform: translate(0px, 0px) scale(1);">
        <svg id="connections-layer" style="overflow: visible;"></svg>
        <div id="items-layer"></div>
    </div>

    <div class="toolbar">
        <button class="tool-btn" onclick="window.location.href='/index.html'">&lt;&lt; RETOUR</button>
        <div style="width: 1px; height: 30px; background: #333; margin: 0 10px;"></div>
        <button class="tool-btn" onclick="openEditModal('new', 'suspect')">+ SUSPECT</button>
        <button class="tool-btn" onclick="openEditModal('new', 'note')">+ NOTE</button>
        <div style="width: 1px; height: 30px; background: #333; margin: 0 10px;"></div>
        <button class="tool-btn" id="btn-reset-view" onclick="resetView()">RECADRER VUE</button>
    </div>

    <div id="context-menu">
        <div class="ctx-item" onclick="contextAction('edit')">ÉDITER</div>
        <div class="ctx-item" onclick="contextAction('link')">LIER À...</div>
        <div class="ctx-item" onclick="contextAction('color')">CHANGER COULEUR</div>
        <div class="ctx-item delete" onclick="contextAction('delete')">SUPPRIMER</div>
    </div>

    <div class="edit-modal-overlay" id="editModal">
        <div class="edit-modal">
            <h3 id="modal-title">//: NOUVEAU DOSSIER</h3>
            <input type="hidden" id="modal-mode">
            <input type="hidden" id="modal-type">
            <input type="hidden" id="modal-id">
            
            <label style="color:#888; font-size:0.8rem;">LABEL / CONTENU</label>
            <textarea id="modal-label" class="edit-input" rows="3"></textarea>
            
            <div id="modal-image-group">
                <label style="color:#888; font-size:0.8rem;">URL IMAGE (Optionnel)</label>
                <input type="text" id="modal-image" class="edit-input" placeholder="/assets/...">
            </div>

            <div class="modal-btns">
                <button class="tool-btn" onclick="closeEditModal()">ANNULER</button>
                <button class="tool-btn active" onclick="saveModalData()">VALIDER</button>
            </div>
        </div>
    </div>

    <script>
        let items = [];
        let links = [];
        let viewState = { x: 0, y: 0, scale: 1 };
        let isPanning = false;
        let startPanX, startPanY;
        let contextTargetId = null;
        let linkingFromId = null;
        let dragItem = null;
        let dragOffsetX, dragOffsetY;

        const worldLayer = document.getElementById('world-layer');
        const itemsLayer = document.getElementById('items-layer');
        const svgLayer = document.getElementById('connections-layer');
        const ctxMenu = document.getElementById('context-menu');
        const editModal = document.getElementById('editModal');
        const modalLabel = document.getElementById('modal-label');
        const modalImage = document.getElementById('modal-image');
        const modalMode = document.getElementById('modal-mode');
        const modalType = document.getElementById('modal-type');
        const modalId = document.getElementById('modal-id');

        async function loadBoard() {
            try {
                const res = await fetch('/api/read?resource=investigation');
                const data = await res.json();
                if (data.items) items = data.items;
                if (data.links) links = data.links;
                renderBoard();
            } catch (error) { console.error("Erreur:", error); }
        }

        function renderBoard() {
            itemsLayer.innerHTML = '';
            svgLayer.innerHTML = '';

            items.forEach(item => {
                const el = document.createElement('div');
                el.className = `board-item item-${item.type}`;
                if(item.type === 'note') {
                    el.classList.add(item.color || 'yellow');
                    el.innerHTML += '<div class="pin"></div>';
                } else {
                    el.innerHTML += '<div class="tape"></div>';
                }
                
                el.style.left = item.x + 'px';
                el.style.top = item.y + 'px';
                el.id = `item-${item.id}`;
                el.dataset.id = item.id;

                const rot = (item.id % 6) - 3; 
                const scale = item.scale || 1;
                el.style.transform = `rotate(${rot}deg) scale(${scale})`;

                if(item.type === 'suspect') {
                    const imgUrl = item.image_url || '/assets/petit.jpg';
                    el.innerHTML += `<img src="${imgUrl}" draggable="false"><div class="label">${item.label}</div>`;
                } else {
                    el.innerHTML += `<div style="margin-top:10px;">${item.label}</div>`;
                }

                el.onmousedown = (e) => startItemDrag(e, item);
                el.oncontextmenu = (e) => openContextMenu(e, item.id);

                itemsLayer.appendChild(el);
            });

            links.forEach(link => {
                const from = items.find(i => i.id === link.from_id);
                const to = items.find(i => i.id === link.to_id);
                if(from && to) drawLink(from, to, link.type, link.id);
            });
        }

        function drawLink(item1, item2, type, id) {
            const x1 = item1.x + 100;
            const y1 = item1.y + 100;
            const x2 = item2.x + 100;
            const y2 = item2.y + 100;

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            
            const cx = (x1 + x2) / 2;
            const cy = Math.min(y1, y2) - 50;
            
            const d = `M ${x1} ${y1} Q ${cx} ${cy} ${x2} ${y2}`;
            path.setAttribute("d", d);
            path.setAttribute("class", `link-${type}`);
            
            path.ondblclick = async () => {
                if(confirm("Couper ce lien ?")) {
                    await fetch('/api/execute-action', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ action: 'del_inv_link', id })
                    });
                    loadBoard();
                }
            };

            svgLayer.appendChild(path);
        }

        document.addEventListener('wheel', (e) => {
            if (e.target.closest('.board-item')) return;
            e.preventDefault();
            const zoomIntensity = 0.1;
            const newScale = viewState.scale + (e.deltaY > 0 ? -zoomIntensity : zoomIntensity);
            viewState.scale = Math.min(Math.max(0.2, newScale), 3);
            updateTransform();
        }, { passive: false });

        document.addEventListener('mousedown', (e) => {
            if(e.target.closest('.board-item') || e.target.closest('.tool-btn') || e.target.closest('.edit-modal-overlay')) return;
            
            ctxMenu.style.display = 'none';
            
            isPanning = true;
            startPanX = e.clientX - viewState.x;
            startPanY = e.clientY - viewState.y;
            document.body.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', (e) => {
            if(!isPanning) return;
            e.preventDefault();
            viewState.x = e.clientX - startPanX;
            viewState.y = e.clientY - startPanY;
            updateTransform();
        });

        document.addEventListener('mouseup', () => {
            isPanning = false;
            document.body.style.cursor = 'default';
        });

        function updateTransform() {
            worldLayer.style.transform = `translate(${viewState.x}px, ${viewState.y}px) scale(${viewState.scale})`;
        }

        function resetView() {
            viewState = { x: 0, y: 0, scale: 1 };
            updateTransform();
        }

        function startItemDrag(e, item) {
            if (e.button !== 0) return;
            e.stopPropagation();
            
            dragItem = item;
            
            dragOffsetX = (e.clientX - viewState.x) / viewState.scale - item.x;
            dragOffsetY = (e.clientY - viewState.y) / viewState.scale - item.y;
            
            document.addEventListener('mousemove', onItemDrag);
            document.addEventListener('mouseup', endItemDrag);
        }

        function onItemDrag(e) {
            if (!dragItem) return;
            const mouseWorldX = (e.clientX - viewState.x) / viewState.scale;
            const mouseWorldY = (e.clientY - viewState.y) / viewState.scale;

            dragItem.x = mouseWorldX - dragOffsetX;
            dragItem.y = mouseWorldY - dragOffsetY;

            const el = document.getElementById(`item-${dragItem.id}`);
            el.style.left = dragItem.x + 'px';
            el.style.top = dragItem.y + 'px';
        }

        async function endItemDrag() {
            if(dragItem) {
                await fetch('/api/execute-action', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'move_inv_item', id: dragItem.id, x: parseInt(dragItem.x), y: parseInt(dragItem.y) })
                });
                renderBoard();
            }
            dragItem = null;
            document.removeEventListener('mousemove', onItemDrag);
            document.removeEventListener('mouseup', endItemDrag);
        }

        function openContextMenu(e, id) {
            e.preventDefault();
            e.stopPropagation();
            contextTargetId = id;
            ctxMenu.style.display = 'flex';
            ctxMenu.style.left = e.clientX + 'px';
            ctxMenu.style.top = e.clientY + 'px';
        }

        async function contextAction(action) {
            ctxMenu.style.display = 'none';
            if(!contextTargetId) return;
            const item = items.find(i => i.id === contextTargetId);

            if (action === 'delete') {
                if(confirm("Supprimer cet élément ?")) {
                    await fetch('/api/execute-action', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ action: 'del_inv_item', id: contextTargetId })
                    });
                    loadBoard();
                }
            } else if (action === 'edit') {
                openEditModal('edit', item.type, item);
            } else if (action === 'link') {
                if (linkingFromId === null) {
                    linkingFromId = contextTargetId;
                    alert("Sélectionnez maintenant la cible (Clic Droit -> Lier)");
                } else {
                    const type = prompt("Type de lien (red, green, blue) ?", "red");
                    await fetch('/api/execute-action', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ action: 'add_inv_link', from_id: linkingFromId, to_id: contextTargetId, type: type || 'red' })
                    });
                    linkingFromId = null;
                    loadBoard();
                }
            } else if (action === 'color') {
                const colors = ['yellow', 'pink', 'blue', 'green', 'white'];
                const newColor = colors[Math.floor(Math.random() * colors.length)];
                await fetch('/api/execute-action', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'update_inv_item_text', id: contextTargetId, label: item.label, color: newColor })
                });
                loadBoard();
            }
        }

        function openEditModal(mode, type, itemData = null) {
            editModal.style.display = 'flex';
            modalMode.value = mode;
            modalType.value = type;
            
            if (type === 'note') {
                document.getElementById('modal-image-group').style.display = 'none';
            } else {
                document.getElementById('modal-image-group').style.display = 'block';
            }

            if (mode === 'edit' && itemData) {
                modalId.value = itemData.id;
                modalLabel.value = itemData.label;
                modalImage.value = itemData.image_url || '';
                document.getElementById('modal-title').innerText = `//: ÉDITION ${itemData.type.toUpperCase()}`;
            } else {
                modalLabel.value = '';
                modalImage.value = '';
                document.getElementById('modal-title').innerText = `//: NOUVEAU ${type.toUpperCase()}`;
            }
        }

        function closeEditModal() {
            editModal.style.display = 'none';
        }

        async function saveModalData() {
            const mode = modalMode.value;
            const type = modalType.value;
            const label = modalLabel.value;
            const image_url = modalImage.value;

            if (!label) return alert("Texte requis");
            closeEditModal();

            if (mode === 'new') {
                const x = (window.innerWidth/2 - viewState.x) / viewState.scale - 100;
                const y = (window.innerHeight/2 - viewState.y) / viewState.scale - 100;

                await fetch('/api/execute-action', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        action: 'add_inv_item', 
                        type, label, image_url, 
                        x: parseInt(x), y: parseInt(y), 
                        color: 'yellow' 
                    })
                });
            } else {
                const id = modalId.value;
                await fetch('/api/execute-action', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        action: 'update_inv_item_text', 
                        id, label, image_url 
                    })
                });
            }
            loadBoard();
        }

        loadBoard();

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#context-menu')) ctxMenu.style.display = 'none';
        });

    </script>
</body>
</html>