<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUR D'ENQUÊTE</title>
    <script> const REQUIRED_LEVEL = 3; </script>
    <script src="/js/security.js"></script>
    <link rel="stylesheet" href="/css/style-investigation.css">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Indie+Flower&display=swap" rel="stylesheet">
    <style>
        /* --- CORRECTIF D'AFFICHAGE --- */
        
        /* On remonte la barre pour que les pastilles en dessous soient visibles */
        .toolbar {
            bottom: 70px !important; 
            height: 60px !important;
            overflow: visible !important; /* CRUCIAL : Permet aux pastilles de dépasser */
            z-index: 9000 !important;
            display: flex;
            align-items: center;
        }

        /* Conteneur du bouton + pastilles */
        .tool-group {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        /* La barre de pastilles (Toujours visible) */
        .color-selector {
            position: absolute;
            top: 65px; /* Juste en dessous du bouton */
            left: 50%;
            transform: translateX(-50%);
            
            background: #000;
            border: 1px solid #00ff00;
            padding: 5px 10px;
            border-radius: 20px;
            display: flex;
            gap: 8px;
            
            z-index: 9999; /* Au-dessus de tout */
            box-shadow: 0 5px 15px rgba(0,0,0,0.8);
            white-space: nowrap;
        }

        /* Petite flèche de liaison */
        .color-selector::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-left: -1px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent #00ff00 transparent;
        }

        /* Les ronds de couleur */
        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #fff;
            cursor: pointer;
            transition: transform 0.1s;
            
            /* Pour centrer le texte (lettres tampons) */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: black;
            text-shadow: none;
        }
        
        .color-dot:hover {
            transform: scale(1.3);
            z-index: 10;
        }

        /* Définition des couleurs */
        .dot-white { background: #fff; }
        .dot-yellow { background: #ffeb3b; }
        .dot-red { background: #ff4141; }
        .dot-pink { background: #ff80ab; }
        .dot-blue { background: #80d8ff; }
        .dot-green { background: #69f0ae; }

        /* Couleurs spéciales Tampons */
        .stamp-dot-wanted { background: #d32f2f; color: white; border-color: red; }
        .stamp-dot-jailed { background: #f57c00; color: black; }
        .stamp-dot-dead { background: #000; color: white; border: 1px solid #555; }
        .stamp-dot-clear { background: #388e3c; color: white; }
        .stamp-dot-none { background: #555; color: white; }

        /* Bouton Actif */
        #btn-stamp.active {
            background: #ff0000 !important;
            color: white !important;
            box-shadow: 0 0 15px #ff0000 !important;
        }
    </style>
</head>
<body>

    <div class="help-indicator">
        [ MOLETTE : ZOOM | DOUBLE-CLIC : ÉDITER ]
    </div>

    <div id="board-container">
        <svg id="connections-layer"></svg>
        <div id="items-layer"></div>
    </div>

    <div class="toolbar">
        <button class="tool-btn" onclick="window.location.href='/index.html'">&lt;&lt; RETOUR</button>
        
        <div style="width: 1px; height: 30px; background: #333; margin: 0 10px;"></div>
        
        <div class="tool-group">
            <button class="tool-btn" onclick="addItem('suspect')">+ SUSPECT</button>
            </div>

        <div style="width: 10px;"></div>

        <div class="tool-group">
            <button class="tool-btn" onclick="addItem('note')">+ NOTE</button>
            <div class="color-selector">
                <div class="color-dot dot-yellow" onclick="addItem('note', 'yellow')" title="Jaune"></div>
                <div class="color-dot dot-pink" onclick="addItem('note', 'pink')" title="Rose"></div>
                <div class="color-dot dot-blue" onclick="addItem('note', 'blue')" title="Bleu"></div>
                <div class="color-dot dot-green" onclick="addItem('note', 'green')" title="Vert"></div>
            </div>
        </div>
        
        <div style="width: 1px; height: 30px; background: #333; margin: 0 10px;"></div>

        <button class="tool-btn" id="btn-link-red" onclick="toggleLinkMode('red')">GUERRE</button>
        <button class="tool-btn" id="btn-link-green" onclick="toggleLinkMode('green')">ALLIÉ</button>
        <button class="tool-btn" id="btn-link-blue" onclick="toggleLinkMode('blue')">SUB</button>
        
        <div style="width: 1px; height: 30px; background: #333; margin: 0 10px;"></div>

        <div class="tool-group">
            <button class="tool-btn" id="btn-stamp" onclick="activateStampMode(null)">TAMPONNER</button>
            <div class="color-selector">
                <div class="color-dot stamp-dot-wanted" onclick="activateStampMode('WANTED')" title="WANTED">W</div>
                <div class="color-dot stamp-dot-jailed" onclick="activateStampMode('JAILED')" title="PRISON">P</div>
                <div class="color-dot stamp-dot-dead" onclick="activateStampMode('DECEASED')" title="MORT">†</div>
                <div class="color-dot stamp-dot-clear" onclick="activateStampMode('CLEARED')" title="CLEAN">OK</div>
                <div class="color-dot stamp-dot-none" onclick="activateStampMode('NONE')" title="EFFACER">X</div>
            </div>
        </div>
    </div>

    <script>
        let items = [];
        let links = [];
        let linkMode = null; 
        let stampMode = false; 
        let currentStampType = null;
        let linkSourceId = null;
        let resizeTimeout;

        const board = document.getElementById('items-layer');
        const svgLayer = document.getElementById('connections-layer');

        // --- CHARGEMENT ---
        async function loadBoard() {
            try {
                const res = await fetch('/api/read?resource=investigation');
                const data = await res.json();
                if (data.items) items = data.items;
                if (data.links) links = data.links;
                renderBoard();
            } catch (error) { console.error("Erreur:", error); }
        }

        // --- RENDU ---
        function renderBoard() {
            board.innerHTML = '';
            svgLayer.innerHTML = '';

            items.forEach(item => {
                const el = document.createElement('div');
                el.className = `board-item item-${item.type}`;
                if(item.type === 'note' && item.color) el.classList.add(item.color);
                
                el.style.left = item.x + 'px';
                el.style.top = item.y + 'px';
                el.id = `item-${item.id}`;
                el.dataset.id = item.id;

                const currentScale = item.scale || 1.0;
                const rotation = item.type === 'suspect' ? -2 : 2; 
                el.style.transform = `scale(${currentScale}) rotate(${rotation}deg)`;
                el.dataset.scale = currentScale;

                if(item.type === 'suspect') {
                    const imgUrl = item.image_url || '/assets/petit.jpg';
                    el.innerHTML = `<img src="${imgUrl}" draggable="false"><div class="label">${item.label}</div>`;
                } else {
                    el.innerText = item.label;
                }

                // Affichage du Tampon
                if (item.status && item.status !== 'NONE') {
                    const stamp = document.createElement('div');
                    stamp.className = `stamp stamp-${item.status}`;
                    stamp.innerText = item.status;
                    el.appendChild(stamp);
                }

                const delBtn = document.createElement('div');
                delBtn.className = 'delete-btn';
                delBtn.innerText = 'X';
                delBtn.onclick = (e) => { e.stopPropagation(); deleteItem(item.id); };
                el.appendChild(delBtn);

                // Événements souris
                el.onmousedown = startDrag;
                el.onclick = (e) => handleItemClick(e, item.id);
                el.onwheel = (e) => handleResize(e, item);
                el.ondblclick = (e) => editItem(e, item);

                board.appendChild(el);
            });

            // Dessin des liens
            links.forEach(link => {
                const fromItem = items.find(i => i.id === link.from_id);
                const toItem = items.find(i => i.id === link.to_id);
                if(fromItem && toItem) drawLine(fromItem, toItem, link.type, link.id);
            });
        }

        function drawLine(item1, item2, type, id) {
            const w1 = item1.type === 'suspect' ? 180 : 200;
            const h1 = item1.type === 'suspect' ? 200 : 150;
            const x1 = item1.x + (w1 * (item1.scale||1)) / 2;
            const y1 = item1.y + (h1 * (item1.scale||1)) / 2;

            const w2 = item2.type === 'suspect' ? 180 : 200;
            const h2 = item2.type === 'suspect' ? 200 : 150;
            const x2 = item2.x + (w2 * (item2.scale||1)) / 2;
            const y2 = item2.y + (h2 * (item2.scale||1)) / 2;

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            const cx = (x1 + x2) / 2;
            const cy = (y1 + y2) / 2 + 40;
            const d = `M ${x1} ${y1} Q ${cx} ${cy} ${x2} ${y2}`;

            path.setAttribute("d", d);
            path.setAttribute("class", `link-${type}`);
            
            path.onclick = () => {
                if(confirm("Couper ce lien ?")) deleteLink(id);
            };
            svgLayer.appendChild(path);
        }

        // --- MODES ET CLICS ---

        function disableAllModes() {
            linkMode = null;
            linkSourceId = null;
            stampMode = false;
            currentStampType = null;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.board-item').forEach(i => i.classList.remove('linking-source'));
        }

        function toggleLinkMode(color) {
            disableAllModes(); 
            linkMode = color;
            document.getElementById(`btn-link-${color}`).classList.add('active');
        }

        window.activateStampMode = function(type) {
            disableAllModes();
            stampMode = true;
            currentStampType = type; 
            document.getElementById('btn-stamp').classList.add('active');
            console.log("Mode tampon activé :", type);
        };

        window.addItem = async function(type, chosenColor) {
            let label, image_url, color;
            
            if (!chosenColor) chosenColor = (type === 'suspect') ? 'white' : 'yellow';
            color = chosenColor;

            if(type === 'suspect') {
                label = prompt("Nom du Suspect :");
                if(!label) return;
                image_url = prompt("URL photo (facultatif) :");
            } else {
                label = prompt("Texte de la note :");
                if(!label) return;
            }

            const x = window.innerWidth/2 - 100 + (Math.random()*50);
            const y = window.innerHeight/2 - 100 + (Math.random()*50);

            await fetch('/api/execute-action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'add_inv_item', type, label, image_url, x: parseInt(x), y: parseInt(y), color })
            });
            loadBoard();
        };

        async function handleItemClick(e, id) {
            if (stampMode) {
                let statusToApply = "";
                if (currentStampType) {
                    statusToApply = currentStampType === 'NONE' ? '' : currentStampType;
                } else {
                    const stat = prompt("STATUT MANUEL (WANTED, JAILED...) :");
                    if (stat) statusToApply = stat.toUpperCase();
                    else return;
                }
                await updateItemData(id, { status: statusToApply });
                // On reste en mode tampon pour enchaîner si besoin
                return;
            }

            if (linkMode) {
                if(linkSourceId === null) {
                    linkSourceId = id;
                    document.getElementById(`item-${id}`).classList.add('linking-source');
                } else {
                    if(linkSourceId !== id) {
                        await fetch('/api/execute-action', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ action: 'add_inv_link', from_id: linkSourceId, to_id: id, type: linkMode })
                        });
                    }
                    toggleLinkMode(linkMode); // On coupe après un lien
                    loadBoard();
                }
            }
        }

        // --- DRAG & DROP ---
        let activeDrag = null;
        let offsetX, offsetY;

        function startDrag(e) {
            if(linkMode || stampMode) return;
            activeDrag = e.currentTarget;
            activeDrag.style.zIndex = 1000;
            const rect = activeDrag.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
        }

        function doDrag(e) {
            if (!activeDrag) return;
            activeDrag.style.left = (e.clientX - offsetX) + 'px';
            activeDrag.style.top = (e.clientY - offsetY) + 'px';
        }

        async function stopDrag(e) {
            if (!activeDrag) return;
            const id = activeDrag.dataset.id;
            const x = parseInt(activeDrag.style.left);
            const y = parseInt(activeDrag.style.top);
            activeDrag.style.zIndex = "";
            
            await fetch('/api/execute-action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'move_inv_item', id, x, y })
            });

            const item = items.find(i => i.id == id);
            if(item) { item.x = x; item.y = y; }
            renderBoard(); // Redessiner les lignes

            document.removeEventListener('mousemove', doDrag);
            document.removeEventListener('mouseup', stopDrag);
            activeDrag = null;
        }

        // --- UTILS ---
        async function updateItemData(id, payload) {
            await fetch('/api/execute-action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'update_inv_item_text', id, ...payload })
            });
            loadBoard();
        }

        async function deleteItem(id) {
            if(!confirm("Supprimer ?")) return;
            await fetch('/api/execute-action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'del_inv_item', id })
            });
            loadBoard();
        }

        async function deleteLink(id) {
            await fetch('/api/execute-action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'del_inv_link', id })
            });
            loadBoard();
        }

        async function editItem(e, item) {
            e.stopPropagation();
            const choice = prompt("1. Texte\n2. Image/Couleur");
            if(choice === '1') {
                const val = prompt("Nouveau texte :", item.label);
                if(val) updateItemData(item.id, { label: val });
            } else if(choice === '2') {
                if(item.type === 'suspect') {
                    const val = prompt("URL Image :", item.image_url);
                    if(val) updateItemData(item.id, { image_url: val });
                } else {
                    const val = prompt("Couleur (yellow, pink, blue, green) :", item.color);
                    if(val) updateItemData(item.id, { color: val });
                }
            }
        }

        function handleResize(e, item) {
            e.preventDefault();
            const el = document.getElementById(`item-${item.id}`);
            let scale = parseFloat(el.dataset.scale);
            scale += (e.deltaY > 0 ? -0.1 : 0.1);
            scale = Math.min(Math.max(scale, 0.5), 3.0);
            
            const rotation = item.type === 'suspect' ? -2 : 2; 
            el.style.transform = `scale(${scale}) rotate(${rotation}deg)`;
            el.dataset.scale = scale;

            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(async () => {
                await fetch('/api/execute-action', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'resize_inv_item', id: item.id, scale: scale })
                });
                const it = items.find(i => i.id === item.id);
                if(it) it.scale = scale;
                renderBoard();
            }, 500);
        }

        loadBoard();
    </script>
</body>
</html>