<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUR D'ENQUÊTE</title>
    <script> const REQUIRED_LEVEL = 3; </script>
    <script src="/js/security.js"></script>
    <link rel="stylesheet" href="/css/style-investigation.css">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Indie+Flower&display=swap" rel="stylesheet">
    <style>
     
        #btn-stamp.active {
            background: #ff0000;
            color: white;
            border-color: #ff0000;
            box-shadow: 0 0 20px #ff0000;
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red { 
            0% { box-shadow: 0 0 10px #ff0000; } 
            50% { box-shadow: 0 0 25px #ff0000; } 
            100% { box-shadow: 0 0 10px #ff0000; } 
        }

        .tool-group {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .color-tooltip {
            position: absolute;
            bottom: 100%; /* Au-dessus du bouton */
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 15px;
            
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid #00ff00;
            padding: 8px 12px;
            border-radius: 50px;
            display: flex;
            gap: 10px;
            
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            pointer-events: none;
            z-index: 9999;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
            white-space: nowrap; /* Empêche le retour à la ligne */
        }

        /* Flèche de la bulle */
        .color-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: #00ff00 transparent transparent transparent;
        }

        /* Apparition au survol */
        .tool-group:hover .color-tooltip {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            margin-bottom: 20px;
        }

        /* Styles des points */
        .color-dot {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: #000;
            text-shadow: none;
        }
        .color-dot:hover {
            transform: scale(1.4);
            border-color: #fff;
            z-index: 2;
        }

        /* Couleurs Notes */
        .dot-yellow { background: #ffeb3b; box-shadow: 0 0 8px #ffeb3b; }
        .dot-pink { background: #ff80ab; box-shadow: 0 0 8px #ff80ab; }
        .dot-blue { background: #80d8ff; box-shadow: 0 0 8px #80d8ff; }
        .dot-green { background: #69f0ae; box-shadow: 0 0 8px #69f0ae; }

        /* Couleurs Tampons */
        .stamp-dot-wanted { background: #d32f2f; box-shadow: 0 0 8px #d32f2f; color: #fff; } /* WANTED */
        .stamp-dot-jailed { background: #f57c00; box-shadow: 0 0 8px #f57c00; } /* PRISON */
        .stamp-dot-dead { background: #000000; border: 1px solid #555; box-shadow: 0 0 8px #fff; color: #fff; } /* MORT */
        .stamp-dot-clear { background: #388e3c; box-shadow: 0 0 8px #388e3c; color: #fff; } /* CLEAN */
        .stamp-dot-none { background: #555; color: #fff; } /* GOMME */

    </style>
</head>
<body>

    <div class="help-indicator">
        [ MOLETTE : ZOOM | DOUBLE-CLIC : ÉDITER ]
    </div>

    <div id="board-container">
        <svg id="connections-layer"></svg>
        <div id="items-layer"></div>
    </div>

    <div class="toolbar">
        <button class="tool-btn" onclick="window.location.href='/index.html'">&lt;&lt; RETOUR</button>
        
        <div style="width: 1px; background: #333; margin: 0 5px;"></div>
        
        <button class="tool-btn" onclick="addItem('suspect')">+ SUSPECT</button>

        <div class="tool-group">
            <button class="tool-btn" onclick="addItem('note')">+ NOTE</button>
            <div class="color-tooltip">
                <div class="color-dot dot-yellow" onclick="addItem('note', 'yellow')" title="Jaune"></div>
                <div class="color-dot dot-pink" onclick="addItem('note', 'pink')" title="Rose"></div>
                <div class="color-dot dot-blue" onclick="addItem('note', 'blue')" title="Bleu"></div>
                <div class="color-dot dot-green" onclick="addItem('note', 'green')" title="Vert"></div>
            </div>
        </div>
        
        <div style="width: 1px; background: #333; margin: 0 5px;"></div>

        <button class="tool-btn" id="btn-link-red" onclick="toggleLinkMode('red')">LIEN GUERRE</button>
        <button class="tool-btn" id="btn-link-green" onclick="toggleLinkMode('green')">LIEN ALLIÉ</button>
        <button class="tool-btn" id="btn-link-blue" onclick="toggleLinkMode('blue')">LIEN SUB</button>
        
        <div style="width: 1px; background: #333; margin: 0 5px;"></div>

        <div class="tool-group">
            <button class="tool-btn" id="btn-stamp" onclick="activateStampMode(null)">TAMPONNER</button>
            <div class="color-tooltip">
                <div class="color-dot stamp-dot-wanted" onclick="activateStampMode('WANTED')" title="WANTED">W</div>
                <div class="color-dot stamp-dot-jailed" onclick="activateStampMode('JAILED')" title="PRISON">P</div>
                <div class="color-dot stamp-dot-dead" onclick="activateStampMode('DECEASED')" title="DÉCÉDÉ">†</div>
                <div class="color-dot stamp-dot-clear" onclick="activateStampMode('CLEARED')" title="INNOCENT">OK</div>
                <div class="color-dot stamp-dot-none" onclick="activateStampMode('NONE')" title="EFFACER">X</div>
            </div>
        </div>
    </div>

    <script>
        let items = [];
        let links = [];
        let linkMode = null; 
        let stampMode = false; 
        let currentStampType = null; 
        let linkSourceId = null;
        let resizeTimeout;

        const board = document.getElementById('items-layer');
        const svgLayer = document.getElementById('connections-layer');

        async function loadBoard() {
            try {
                const res = await fetch('/api/read?resource=investigation');
                if (!res.ok) throw new Error(`Erreur API: ${res.status}`);
                const data = await res.json();
                if (!data.items || !data.links) return;
                
                items = data.items;
                links = data.links;
                renderBoard();
            } catch (error) {
                console.error("Erreur chargement:", error);
            }
        }

        function renderBoard() {
            board.innerHTML = '';
            svgLayer.innerHTML = '';

            items.forEach(item => {
                const el = document.createElement('div');
                el.className = `board-item item-${item.type}`;
                if(item.type === 'note' && item.color) el.classList.add(item.color);
                
                el.style.left = item.x + 'px';
                el.style.top = item.y + 'px';
                el.id = `item-${item.id}`;
                el.dataset.id = item.id;

                const currentScale = item.scale || 1.0;
                const rotation = item.type === 'suspect' ? -2 : 2; 
                el.style.transform = `scale(${currentScale}) rotate(${rotation}deg)`;
                el.dataset.scale = currentScale;

                if(item.type === 'suspect') {
                    const imgUrl = item.image_url || '/assets/petit.jpg';
                    el.innerHTML = `<img src="${imgUrl}" draggable="false"><div class="label">${item.label}</div>`;
                } else {
                    el.innerText = item.label;
                }

                if (item.status && item.status !== 'NONE') {
                    const stamp = document.createElement('div');
                    stamp.className = `stamp stamp-${item.status}`;
                    stamp.innerText = item.status;
                    el.appendChild(stamp);
                }

                const delBtn = document.createElement('div');
                delBtn.className = 'delete-btn';
                delBtn.innerText = 'X';
                delBtn.title = "Supprimer";
                delBtn.onclick = (e) => { e.stopPropagation(); deleteItem(item.id); };
                el.appendChild(delBtn);

                el.onmousedown = startDrag;
                el.onclick = (e) => handleItemClick(e, item.id);
                el.onwheel = (e) => handleResize(e, item);
                el.ondblclick = (e) => editItem(e, item);

                board.appendChild(el);
            });

            links.forEach(link => {
                const fromItem = items.find(i => i.id === link.from_id);
                const toItem = items.find(i => i.id === link.to_id);
                if(fromItem && toItem) {
                    drawLine(fromItem, toItem, link.type, link.id);
                }
            });
        }

        function drawLine(item1, item2, type, id) {
            const w1 = item1.type === 'suspect' ? 180 : 200;
            const h1 = item1.type === 'suspect' ? 200 : 150;
            const x1 = item1.x + (w1 * (item1.scale||1)) / 2;
            const y1 = item1.y + (h1 * (item1.scale||1)) / 2;

            const w2 = item2.type === 'suspect' ? 180 : 200;
            const h2 = item2.type === 'suspect' ? 200 : 150;
            const x2 = item2.x + (w2 * (item2.scale||1)) / 2;
            const y2 = item2.y + (h2 * (item2.scale||1)) / 2;

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            const cx = (x1 + x2) / 2;
            const cy = (y1 + y2) / 2 + 40;
            const d = `M ${x1} ${y1} Q ${cx} ${cy} ${x2} ${y2}`;

            path.setAttribute("d", d);
            path.setAttribute("class", `link-${type}`);
            
            path.onclick = (e) => {
                path.style.stroke = "#fff";
                setTimeout(() => {
                    if(confirm("Couper ce lien ?")) deleteLink(id);
                    else path.style.stroke = "";
                }, 50);
            };

            svgLayer.appendChild(path);
        }

        function toggleLinkMode(color) {
            disableAllModes(); 
            if(linkMode === color) {
                linkMode = null; 
            } else {
                linkMode = color;
                document.getElementById(`btn-link-${color}`).classList.add('active');
            }
        }


        function activateStampMode(type) {
            
            if (type === null) {
                if (stampMode) { 
                    disableAllModes(); 
                } else {
                    disableAllModes();
                    stampMode = true;
                    currentStampType = null; 
                    document.getElementById('btn-stamp').classList.add('active');
                }
                return;
            }

       
            disableAllModes();
            stampMode = true;
            currentStampType = type; 
            document.getElementById('btn-stamp').classList.add('active');
        }

        function disableAllModes() {
            linkMode = null;
            linkSourceId = null;
            stampMode = false;
            currentStampType = null;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.board-item').forEach(i => i.classList.remove('linking-source'));
        }

        async function handleItemClick(e, id) {
       
            if (stampMode) {
                let statusToApply = "";

                if (currentStampType) {
             
                    statusToApply = currentStampType === 'NONE' ? '' : currentStampType;
                } else {
             
                    const stat = prompt("TAMPON MANUEL :\nEcrivez le statut (WANTED, DECEASED, NONE...) :");
                    if (stat) {
                        statusToApply = stat.toUpperCase() === 'NONE' ? '' : stat.toUpperCase();
                    } else {
                        return; // Annulé
                    }
                }

                await updateItemData(id, { status: statusToApply });
                
       
                return;
            }

          
            if (linkMode) {
                if(linkSourceId === null) {
                    linkSourceId = id;
                    document.getElementById(`item-${id}`).classList.add('linking-source');
                } else {
                    if(linkSourceId === id) return;
                    await fetch('/api/execute-action', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            action: 'add_inv_link', 
                            from_id: linkSourceId, 
                            to_id: id, 
                            type: linkMode 
                        })
                    });
                    toggleLinkMode(linkMode);
                    loadBoard();
                }
                return;
            }
        }

        let activeDrag = null;
        let offsetX, offsetY;

        function startDrag(e) {
            if(linkMode || stampMode) return;
            activeDrag = e.currentTarget;
            activeDrag.style.zIndex = 1000;
            const rect = activeDrag.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
        }

        function doDrag(e) {
            if (!activeDrag) return;
            const x = e.clientX - offsetX;
            const y = e.clientY - offsetY;
            activeDrag.style.left = x + 'px';
            activeDrag.style.top = y + 'px';
        }

        async function stopDrag(e) {
            if (!activeDrag) return;
            const id = activeDrag.dataset.id;
            const x = parseInt(activeDrag.style.left);
            const y = parseInt(activeDrag.style.top);
            
            activeDrag.style.zIndex = "";

            await fetch('/api/execute-action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'move_inv_item', id, x, y })
            });

            const item = items.find(i => i.id == id);
            if(item) { item.x = x; item.y = y; }
            renderBoard();

            document.removeEventListener('mousemove', doDrag);
            document.removeEventListener('mouseup', stopDrag);
            activeDrag = null;
        }

        async function addItem(type, chosenColor) {
            let label, image_url, color;
            
            if (!chosenColor) {
                chosenColor = type === 'suspect' ? 'white' : 'yellow';
            }
            color = chosenColor;

            if(type === 'suspect') {
                label = prompt("Nom du Suspect :");
                if(!label) return;
                image_url = prompt("URL de la photo (laisser vide pour défaut) :");
            } else {
                label = prompt("Contenu de la note :");
                if(!label) return;
            }

            const x = window.innerWidth/2 - 100 + (Math.random()*50);
            const y = window.innerHeight/2 - 100 + (Math.random()*50);

            await fetch('/api/execute-action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'add_inv_item', type, label, image_url, x: parseInt(x), y: parseInt(y), color })
            });
            loadBoard();
        }

        async function editItem(e, item) {
            e.stopPropagation();
        
            const choice = prompt("MODIFIER :\n1. Texte\n2. Image/Couleur");

            if (choice === '1') {
                const newLabel = prompt("Nouveau texte :", item.label);
                if (newLabel) updateItemData(item.id, { label: newLabel });
            } 
            else if (choice === '2') {
                if (item.type === 'suspect') {
                    const newImg = prompt("Nouvelle URL image :", item.image_url);
                    if (newImg) updateItemData(item.id, { label: item.label, image_url: newImg });
                } else {
                    const newCol = prompt("Nouvelle couleur (yellow, pink, blue, green) :", item.color);
                    if (newCol) updateItemData(item.id, { label: item.label, color: newCol });
                }
            }
        }

        async function updateItemData(id, payload) {
            await fetch('/api/execute-action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'update_inv_item_text', id: id, ...payload })
            });
            loadBoard();
        }

        async function deleteItem(id) {
            if(!confirm("Supprimer cet élément ?")) return;
            await fetch('/api/execute-action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'del_inv_item', id })
            });
            loadBoard();
        }

        async function deleteLink(id) {
            await fetch('/api/execute-action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'del_inv_link', id })
            });
            loadBoard();
        }

        function handleResize(e, item) {
            e.preventDefault();
            const el = document.getElementById(`item-${item.id}`);
            let scale = parseFloat(el.dataset.scale);
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            scale = Math.min(Math.max(scale + delta, 0.5), 3.0);

            const rotation = item.type === 'suspect' ? -2 : 2;
            el.style.transform = `scale(${scale}) rotate(${rotation}deg)`;
            el.dataset.scale = scale;

            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(async () => {
                await fetch('/api/execute-action', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'resize_inv_item', id: item.id, scale: scale })
                });
                const it = items.find(i => i.id === item.id);
                if(it) it.scale = scale;
                renderBoard();
            }, 500);
        }

        loadBoard();
    </script>
</body>
</html>