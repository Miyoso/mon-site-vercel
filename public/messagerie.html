<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - Messagerie Sécurisée</title>
    <script> const REQUIRED_LEVEL = 1; </script>
    <script src="/js/security.js"></script>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/nvx.css">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        .mail-layout { display: grid; grid-template-columns: 250px 1fr; gap: 20px; min-height: 600px; border: 1px solid #333; background: rgba(0,0,0,0.5); }
        .sidebar { background: #0a0a0a; border-right: 1px solid #333; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .sidebar button { text-align: left; background: transparent; border: 1px solid #333; color: #888; padding: 10px; cursor: pointer; font-family: inherit; transition: 0.2s; }
        .sidebar button:hover, .sidebar button.active { border-color: #00ff00; color: #00ff00; background: rgba(0, 255, 0, 0.05); }
        .btn-compose { background: #003300 !important; color: #00ff00 !important; border-color: #00ff00 !important; text-align: center !important; margin-bottom: 20px; }
        
        .mail-list { overflow-y: auto; max-height: 600px; }
        .mail-item { padding: 15px; border-bottom: 1px solid #222; cursor: pointer; transition: 0.2s; position: relative; }
        .mail-item:hover { background: rgba(255, 255, 255, 0.05); }
        .mail-item.unread { border-left: 3px solid #00ff00; background: rgba(0, 255, 0, 0.02); }
        .mail-sender { font-weight: bold; color: #00ccff; font-size: 0.9rem; }
        .mail-subject { color: #eaeaea; margin: 5px 0; }
        .mail-date { font-size: 0.7rem; color: #666; position: absolute; top: 15px; right: 15px; }

        .mail-content { padding: 20px; display: none; flex-direction: column; height: 100%; }
        .mail-content.active { display: flex; }
        .mail-header { border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 20px; }
        .mail-body { white-space: pre-wrap; color: #ccc; flex-grow: 1; line-height: 1.5; }
        
        .compose-modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .compose-box { width: 600px; background: #050505; border: 1px solid #00ff00; padding: 20px; box-shadow: 0 0 30px rgba(0,255,0,0.1); }
        .form-group { margin-bottom: 15px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; background: #111; border: 1px solid #333; color: #fff; padding: 10px; font-family: inherit; }
    </style>
</head>
<body>
    <main class="terminal" style="max-width: 1200px;">
        <div class="ops-header">
            <h1>MESSAGERIE SÉCURISÉE<span class="blinker">_</span></h1>
            <p class="status">AGENT: <span class="secure" id="agent-name"></span></p>
        </div>

        <div class="mail-layout">
            <div class="sidebar">
                <button class="btn-compose" onclick="openCompose()">+ NOUVEAU MESSAGE</button>
                <button class="active" onclick="loadMails('inbox')">>> BOÎTE DE RÉCEPTION</button>
                <button onclick="loadMails('sent')">>> ENVOYÉS</button>
            </div>

            <div id="inbox-view" class="mail-list">
                <div style="padding:20px; text-align:center; color:#666;">Chargement...</div>
            </div>

            <div id="read-view" class="mail-content">
                <div class="mail-header">
                    <button onclick="closeMail()" style="float:right; background:none; border:1px solid #333; color:#666; cursor:pointer;">X FERMER</button>
                    <h2 id="view-subject" style="color:#fff; margin-bottom:10px;">Sujet</h2>
                    <div style="color:#00ccff;">DE: <span id="view-sender"></span></div>
                    <div style="color:#666; font-size:0.8rem;">LE: <span id="view-date"></span></div>
                </div>
                <div id="view-body" class="mail-body"></div>
                <div style="margin-top:20px; border-top:1px solid #333; padding-top:10px;">
                    <button id="btn-delete" style="color:#ff4141; background:none; border:1px solid #ff4141; padding:5px 10px; cursor:pointer;">SUPPRIMER</button>
                </div>
            </div>
        </div>

        <footer class="portal-footer">
            <a href="/index.html" class="back-link">&lt;&lt; RETURN_TO_MAINFRAME</a>
        </footer>
    </main>

    <div class="compose-modal" id="composeModal">
        <div class="compose-box">
            <h3 style="color:#00ff00; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:20px;">NOUVEAU MESSAGE</h3>
            <form id="composeForm">
                <div class="form-group">
                    <label>DESTINATAIRE</label>
                    <select id="compose-recipient" required>
                        <option value="">Chargement des agents...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>SUJET</label>
                    <input type="text" id="compose-subject" required placeholder="Ex: Rapport mission...">
                </div>
                <div class="form-group">
                    <label>MESSAGE</label>
                    <textarea id="compose-body" rows="8" required></textarea>
                </div>
                <div style="text-align:right; gap:10px; display:flex; justify-content:flex-end;">
                    <button type="button" onclick="closeCompose()" style="background:transparent; border:1px solid #666; color:#888; padding:8px 15px; cursor:pointer;">ANNULER</button>
                    <button type="submit" style="background:#003300; border:1px solid #00ff00; color:#00ff00; padding:8px 15px; cursor:pointer;">ENVOYER</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const user = localStorage.getItem('sas_user');
        document.getElementById('agent-name').innerText = user;
        
        let currentBox = 'inbox';

        async function loadAgents() {
            const res = await fetch('/api/read?resource=agents');
            const data = await res.json();
            const select = document.getElementById('compose-recipient');
            select.innerHTML = '<option value="">-- Choisir un agent --</option>';
            data.agents.forEach(a => {
                if(a.name !== user) select.innerHTML += `<option value="${a.name}">${a.name} (Niv ${a.level})</option>`;
            });
        }

        async function loadMails(box) {
            currentBox = box;
            document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('inbox-view').style.display = 'block';
            document.getElementById('read-view').classList.remove('active');
            document.getElementById('inbox-view').innerHTML = '<div style="padding:20px;">Chargement...</div>';

            const res = await fetch(`/api/read?resource=messages&username=${user}&box=${box}`);
            const data = await res.json();
            
            const list = document.getElementById('inbox-view');
            list.innerHTML = '';

            if(data.messages.length === 0) {
                list.innerHTML = '<div style="padding:20px; color:#666; text-align:center;">Aucun message.</div>';
                return;
            }

            data.messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `mail-item ${!msg.is_read && box === 'inbox' ? 'unread' : ''}`;
                div.onclick = () => openMail(msg);
                div.innerHTML = `
                    <div class="mail-sender">${box === 'inbox' ? 'DE: ' + msg.sender : 'À: ' + msg.recipient}</div>
                    <div class="mail-subject">${msg.subject}</div>
                    <div class="mail-date">${new Date(msg.created_at).toLocaleDateString()}</div>
                `;
                list.appendChild(div);
            });
        }

        function openMail(msg) {
            document.getElementById('inbox-view').style.display = 'none';
            const readView = document.getElementById('read-view');
            readView.classList.add('active');

            document.getElementById('view-subject').innerText = msg.subject;
            document.getElementById('view-sender').innerText = msg.sender;
            document.getElementById('view-date').innerText = new Date(msg.created_at).toLocaleString();
            document.getElementById('view-body').innerText = msg.body;
            
            document.getElementById('btn-delete').onclick = async () => {
                if(confirm('Supprimer ce message ?')) {
                    await fetch('/api/execute-action', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ action: 'delete_message', id: msg.id })
                    });
                    loadMails(currentBox);
                }
            };
        }

        function closeMail() {
            document.getElementById('read-view').classList.remove('active');
            document.getElementById('inbox-view').style.display = 'block';
        }

        function openCompose() { 
            document.getElementById('composeModal').style.display = 'flex'; 
            loadAgents();
        }
        function closeCompose() { document.getElementById('composeModal').style.display = 'none'; }

        document.getElementById('composeForm').onsubmit = async (e) => {
            e.preventDefault();
            const recipient = document.getElementById('compose-recipient').value;
            const subject = document.getElementById('compose-subject').value;
            const body = document.getElementById('compose-body').value;

            const res = await fetch('/api/execute-action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    action: 'send_message', 
                    sender: user, 
                    recipient, subject, body 
                })
            });

            if(res.ok) {
                alert('Message envoyé crypté.');
                closeCompose();
                document.getElementById('composeForm').reset();
                if(currentBox === 'sent') loadMails('sent');
            }
        };

        const pusher = new Pusher('TA_CLE_PUBLIQUE_PUSHER', { cluster: 'eu' });
        const channel = pusher.subscribe('operations-channel');
        channel.bind('new-message', function(data) {
            if(data.recipient === user) {
                const header = document.querySelector('.ops-header h1');
                header.style.color = '#00ff00';
                header.innerText = 'NOUVEAU MESSAGE REÇU !';
                setTimeout(() => { 
                    header.style.color = ''; 
                    header.innerHTML = 'MESSAGERIE SÉCURISÉE<span class="blinker">_</span>';
                }, 2000);
                
                if(currentBox === 'inbox') loadMails('inbox');
            }
        });

        loadMails('inbox');
    </script>
</body>
</html>