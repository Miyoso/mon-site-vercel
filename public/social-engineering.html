<script>
    const chatBox = document.getElementById('chat-container');
    const input = document.getElementById('userInput');
    const sendBtn = document.getElementById('btnSend');
    
    // Historique de la conversation pour que l'IA se souvienne
    let history = [];

    async function sendMessage() {
        const text = input.value.trim();
        if (!text) return;

        // 1. Afficher le message du joueur
        addMessage(text, 'user');
        input.value = '';
        
        // 2. Appeler votre API (La vraie IA)
        showTyping(true);
        
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text, history: history })
            });

            const data = await response.json();
            showTyping(false);

            if (data.reply) {
                // 3. Vérifier si on a gagné
                if (data.reply.includes("ACCESS_GRANTED_CODE_2025")) {
                    // On nettoie le code secret pour l'affichage utilisateur
                    const cleanReply = data.reply.replace("ACCESS_GRANTED_CODE_2025", "");
                    addMessage(cleanReply, 'bot');
                    setTimeout(() => gameWin(), 2000);
                } else {
                    addMessage(data.reply, 'bot');
                    // On ajoute l'échange à l'historique
                    history.push({ role: "user", content: text });
                    history.push({ role: "assistant", content: data.reply });
                }
            }
        } catch (e) {
            showTyping(false);
            addMessage("Erreur système... Dave est parti prendre un café (Erreur API).", 'bot');
        }
    }

    // --- Fonctions utilitaires (inchangées) ---
    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        div.innerHTML = `<span class="sender">${sender === 'bot' ? 'Dave (IT)' : 'Moi'}</span>${text}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    
    function showTyping(show) {
        document.getElementById('typingIndicator').style.display = show ? 'block' : 'none';
    }
    
    function gameWin() {
         document.getElementById('overlay').innerHTML = `
            <div class="win-text">ACCÈS AUTORISÉ</div>
            <button onclick="window.location.href='/index.html'">RETOUR</button>
        `;
        document.getElementById('overlay').classList.add('visible');
    }

    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });
</script>